<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS-ID - Sistema Integrado de Activos Tecnol√≥gicos</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        :root { --bg-dark: #0a0b10; --glass: rgba(255, 255, 255, 0.05); --neon-purple: #bc13fe; --neon-cyan: #00f2ff; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: radial-gradient(circle at top right, #1a1b25, #0a0b10); color: white; min-height: 100vh; margin: 0; }
        .glass-card { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 2rem; }
        .btn-primary { background: linear-gradient(90deg, #bc13fe, #7a12f5); transition: all 0.3s ease; }
        .btn-primary:hover { transform: scale(1.02); box-shadow: 0 0 20px rgba(188, 19, 254, 0.3); }
        .input-dark { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 1rem; border-radius: 1rem; outline: none; }
        .input-dark:focus { border-color: var(--neon-cyan); box-shadow: 0 0 0 2px rgba(0, 242, 255, 0.1); }
        .active-filter { background: linear-gradient(90deg, #bc13fe, #7a12f5); color: white; }
        .report-card { animation: fadeInUp 0.3s ease both; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .badge-danado { background: rgba(239,68,68,0.15); color: #f87171; border: 1px solid rgba(239,68,68,0.3); }
        .badge-mantenimiento { background: rgba(249,115,22,0.15); color: #fb923c; border: 1px solid rgba(249,115,22,0.3); }
        .badge-excelente { background: rgba(16,185,129,0.15); color: #34d399; border: 1px solid rgba(16,185,129,0.3); }
        .badge-dept { background: rgba(99,102,241,0.15); color: #818cf8; border: 1px solid rgba(99,102,241,0.3); }
        .badge-status { background: rgba(255,255,255,0.05); color: #94a3b8; border: 1px solid rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; display: inline-flex; align-items: center; gap: 4px; }
        .badge-status.activo { background: rgba(16,185,129,0.15); color: #34d399; border-color: rgba(16,185,129,0.3); }
        .badge-status.devuelto { background: rgba(100,116,139,0.15); color: #94a3b8; border-color: rgba(100,116,139,0.3); }
        .badge-status.reparacion { background: rgba(249,115,22,0.15); color: #fb923c; border-color: rgba(249,115,22,0.3); }
        .role-badge-admin { background: linear-gradient(90deg,rgba(188,19,254,0.25),rgba(122,18,245,0.25)); color: #e879f9; border: 1px solid rgba(188,19,254,0.5); padding: 2px 10px; border-radius: 20px; font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        .role-badge-operario { background: rgba(0,229,255,0.1); color: #22d3ee; border: 1px solid rgba(0,229,255,0.3); padding: 2px 10px; border-radius: 20px; font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        .role-badge-mantenimiento { background: rgba(251,146,60,0.12); color: #fb923c; border: 1px solid rgba(251,146,60,0.35); padding: 2px 10px; border-radius: 20px; font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        .table-row-hover:hover { background: rgba(255,255,255,0.04); transition: background 0.15s; }
        .rotate-180 { transform: rotate(180deg); }
        .manual-tab.active { background: linear-gradient(90deg, #bc13fe, #7a12f5); color: white; }
        .time-filter-btn.active-time { background: linear-gradient(90deg, #bc13fe, #7a12f5); color: white; }
        .pulse-dot { width:8px; height:8px; background:#f59e0b; border-radius:50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(1.3)} }
        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; background: white !important; } .no-print { display: none !important; } }
        
        /* Estilo para permisos de usuarios */
        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 4px;
            margin-top: 8px;
        }
        .permission-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 8px;
            font-weight: 600;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .permission-item.allowed {
            color: #34d399;
            border-color: rgba(52,211,153,0.2);
            background: rgba(52,211,153,0.05);
        }
        .permission-item.denied {
            color: #f87171;
            border-color: rgba(248,113,113,0.2);
            background: rgba(248,113,113,0.05);
        }
        
        /* Tabs para la secci√≥n unificada */
        .dept-tab {
            cursor: pointer;
            transition: all 0.2s;
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.75rem;
        }
        .dept-tab.active {
            background: linear-gradient(90deg, #bc13fe, #7a12f5);
            color: white;
        }
        .dept-tab:not(.active) {
            background: rgba(255,255,255,0.05);
            color: #94a3b8;
        }
        .dept-tab:not(.active):hover {
            background: rgba(255,255,255,0.1);
        }

        /* Estilo para IDs de usuario */
        .user-id-badge {
            background: rgba(99,102,241,0.1);
            color: #818cf8;
            border: 1px solid rgba(99,102,241,0.2);
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 9px;
            font-family: monospace;
            display: inline-block;
            font-weight: 600;
        }

        /* Estilo para la tabla de asignaciones */
        .assignments-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 12px;
        }
        
        .assignments-table th {
            text-align: left;
            padding: 16px;
            color: #94a3b8;
            font-weight: 800;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .assignments-table td {
            padding: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            vertical-align: middle;
        }
        
        .assignments-table tbody tr:hover {
            background: rgba(255,255,255,0.02);
        }
        
        .asset-name {
            color: #22d3ee;
            font-weight: 800;
        }
        
        .user-email {
            font-size: 9px;
            color: #64748b;
            margin-top: 2px;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-icon {
            background: rgba(255,255,255,0.05);
            border: none;
            color: #94a3b8;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-icon:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .btn-icon.edit:hover {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }
        
        .btn-icon.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }
        
        .total-count {
            text-align: right;
            font-size: 10px;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Separadores visuales */
        .table-section {
            background: rgba(255,255,255,0.02);
            border-radius: 16px;
            overflow: hidden;
        }
    </style>
</head>
<body>

<!-- Toast Container -->
<div id="toast-container" class="fixed top-5 right-5 z-[9999] space-y-2"></div>

<!-- Loader -->
<div id="global-loader" class="hidden fixed inset-0 bg-black/80 z-[9999] flex items-center justify-center">
    <div class="glass-card p-8 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-400 mx-auto mb-4"></div>
        <p class="text-white font-black text-sm">Procesando...</p>
    </div>
</div>

<!-- Confirm Modal -->
<div id="confirm-modal" class="hidden fixed inset-0 bg-black/80 z-[9999] flex items-center justify-center p-6">
    <div class="glass-card p-8 max-w-md w-full">
        <i class="fas fa-question-circle text-4xl text-yellow-400 mb-4"></i>
        <h3 class="text-xl font-black text-white mb-2" id="confirm-title">¬øEst√°s seguro?</h3>
        <p class="text-sm text-slate-400 mb-6" id="confirm-message"></p>
        <div class="flex gap-3">
            <button id="confirm-yes" class="flex-1 btn-primary p-3 rounded-xl font-black uppercase text-xs">S√≠, continuar</button>
            <button id="confirm-no" class="flex-1 bg-white/5 hover:bg-white/10 p-3 rounded-xl font-black uppercase text-xs">Cancelar</button>
        </div>
    </div>
</div>

<!-- Vista P√∫blica QR -->
<div id="public-scan-screen" class="hidden fixed inset-0 z-[2500] bg-[#0a0b10] overflow-y-auto p-6">
    <div class="max-w-lg mx-auto pt-6">
        <div class="flex items-center gap-3 mb-6">
            <img src="https://raw.githubusercontent.com/anniel137/uptjaa-inventory/main/gemini-2.5-flash-image_quiero_que_me_crees_el_logo_de_el_polianzoategui_que_sea_algo_mas_futurista-0.jpg" class="w-10 h-10 rounded-full border border-cyan-400 object-cover">
            <div>
                <h1 class="font-black text-xl italic">NEXUS-ID</h1>
                <p class="text-[8px] font-bold text-cyan-400 uppercase tracking-widest">Sistema Integrado de Activos Tecnol√≥gicos</p>
            </div>
        </div>
        <div id="public-loading" class="glass-card p-10 text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-cyan-400 mb-4"></i>
            <p class="text-slate-400 font-bold uppercase text-sm">Cargando informaci√≥n del activo...</p>
        </div>
        <div id="public-asset-card" class="hidden glass-card overflow-hidden">
            <img id="pub-img" class="w-full h-56 object-cover">
            <div class="p-6 space-y-4">
                <h2 id="pub-name" class="text-3xl font-black uppercase italic text-cyan-400"></h2>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white/5 p-4 rounded-2xl">
                        <p class="text-[9px] text-slate-500 uppercase mb-1">Estado</p>
                        <p id="pub-cond" class="font-black text-sm"></p>
                    </div>
                    <div class="bg-white/5 p-4 rounded-2xl">
                        <p class="text-[9px] text-slate-500 uppercase mb-1">Ubicaci√≥n</p>
                        <p id="pub-loc" class="font-black text-sm"></p>
                    </div>
                    <div class="bg-white/5 p-4 rounded-2xl">
                        <p class="text-[9px] text-slate-500 uppercase mb-1">Serial</p>
                        <p id="pub-serial" class="font-black text-sm"></p>
                    </div>
                </div>
                <div id="pub-reason-box" class="hidden bg-orange-500/10 border border-orange-500/30 p-4 rounded-2xl">
                    <p class="text-[9px] text-orange-400 uppercase font-black mb-1">Nota de estado</p>
                    <p id="pub-reason-text" class="text-sm italic text-slate-300"></p>
                </div>
                <div class="pt-2 border-t border-white/10 text-center">
                    <p class="text-[9px] text-slate-500 uppercase">Para reportar una novedad, inicie sesi√≥n como operario</p>
                    <button onclick="document.getElementById('public-scan-screen').classList.add('hidden'); document.getElementById('login-screen').classList.remove('hidden');" class="mt-2 btn-primary px-6 py-2 rounded-xl font-black uppercase text-xs">
                        <i class="fas fa-sign-in-alt mr-1"></i> Iniciar Sesi√≥n
                    </button>
                </div>
            </div>
        </div>
        <div id="public-not-found" class="hidden glass-card p-10 text-center">
            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
            <p class="font-black uppercase text-sm text-red-400">Activo no encontrado</p>
            <p class="text-xs text-slate-500 mt-2">El c√≥digo QR puede estar desactualizado o el activo fue eliminado.</p>
        </div>
    </div>
</div>

<!-- Login Screen -->
<div id="login-screen" class="fixed inset-0 z-[2000] bg-[#0a0b10] flex items-center justify-center p-6">
    <div class="glass-card p-10 w-full max-w-md text-center">
        <img src="https://raw.githubusercontent.com/anniel137/uptjaa-inventory/main/gemini-2.5-flash-image_quiero_que_me_crees_el_logo_de_el_polianzoategui_que_sea_algo_mas_futurista-0.jpg" class="w-24 h-24 mx-auto mb-6 rounded-full border-2 border-cyan-400 object-cover">
        <h2 class="text-4xl font-black italic mb-1">NEXUS-ID</h2>
        <p class="text-[9px] text-cyan-400 font-bold mb-8 uppercase tracking-widest">Sistema Integrado de Activos Tecnol√≥gicos</p>
        <form id="login-form" class="space-y-4">
            <input type="email" id="user-input" placeholder="Correo Institucional" class="w-full input-dark" required>
            <input type="password" id="pass-input" placeholder="Contrase√±a" class="w-full input-dark" required>
            <button type="submit" class="w-full btn-primary p-4 rounded-2xl font-black uppercase text-sm shadow-lg hover:scale-105 transition">Entrar al Sistema</button>
        </form>
        <div class="mt-6 border-t border-white/10 pt-6 text-center">
            <p class="text-[10px] text-slate-500 mb-3 uppercase font-bold">¬øEres personal de la instituci√≥n y no tienes acceso?</p>
            <button onclick="toggleRegRequest()" class="text-xs text-cyan-400 font-black uppercase hover:text-cyan-300 transition">
                <i class="fas fa-user-plus mr-1"></i> Solicitar Acceso
            </button>
        </div>
        <div id="reg-request-form" class="hidden mt-4 space-y-3">
            <input type="text" id="reg-name" placeholder="Nombre Completo" class="w-full input-dark">
            <input type="text" id="reg-cedula" placeholder="C√©dula de Identidad" class="w-full input-dark">
            <input type="email" id="reg-email" placeholder="Correo Institucional" class="w-full input-dark">
            <input type="text" id="reg-cargo" placeholder="Cargo / Departamento" class="w-full input-dark">
            <button onclick="submitRegRequest()" class="w-full bg-cyan-600 hover:bg-cyan-500 p-3 rounded-2xl font-black uppercase text-sm transition">
                <i class="fas fa-paper-plane mr-1"></i> Enviar Solicitud
            </button>
            <p class="text-[9px] text-slate-600 text-center">Tu solicitud ser√° revisada por un administrador.</p>
        </div>
    </div>
</div>

<!-- App Interface -->
<div id="app-interface" class="hidden flex h-screen w-full">
    <aside id="main-sidebar" class="w-72 bg-black/40 backdrop-blur-xl border-r border-white/10 flex flex-col p-6 shrink-0">
        <div class="mb-12">
            <h1 class="font-black text-3xl italic">NEXUS-ID</h1>
            <p class="text-[8px] font-bold text-purple-500 uppercase mt-1">Sistema Integrado de Activos Tecnol√≥gicos</p>
        </div>
        <nav class="flex-1 space-y-3">
            <button id="nav-dashboard" onclick="showSection('dashboard')" class="w-full flex items-center p-4 rounded-2xl font-bold text-slate-400 hover:text-cyan-400 transition-all">
                <i class="fas fa-chart-line w-8"></i> Panel
            </button>
            <button id="nav-inventario" onclick="showSection('inventario')" class="w-full flex items-center p-4 rounded-2xl font-bold text-slate-400 hover:text-cyan-400 transition-all">
                <i class="fas fa-box-open w-8"></i> Inventario
            </button>
            <!-- Secci√≥n unificada: Departamentos y Asignaciones -->
            <button id="nav-departamentos-asignaciones" onclick="showSection('departamentos-asignaciones')" class="w-full flex items-center p-4 rounded-2xl font-bold text-slate-400 hover:text-cyan-400 transition-all mantenimiento-only admin-only">
                <i class="fas fa-sitemap w-8"></i> Deptos & Asignaciones
            </button>
            <button id="nav-reportes" onclick="showSection('reportes')" class="w-full flex items-center p-4 rounded-2xl font-bold text-slate-400 hover:text-cyan-400 transition-all">
                <i class="fas fa-bell w-8"></i> Reportes
            </button>
            <button id="nav-usuarios" onclick="showSection('usuarios')" class="w-full flex items-center p-4 rounded-2xl font-bold text-slate-400 hover:text-cyan-400 transition-all admin-only">
                <i class="fas fa-users-cog w-8"></i> Usuarios
            </button>
            <button id="nav-registrados" onclick="showSection('registrados')" class="w-full flex items-center p-4 rounded-2xl font-bold text-slate-400 hover:text-cyan-400 transition-all admin-only">
                <i class="fas fa-user-check w-8"></i> Registrados
                <span id="pending-badge" class="hidden ml-auto bg-yellow-500 text-black text-[8px] font-black px-2 py-0.5 rounded-full">!</span>
            </button>
            <button id="nav-manual" onclick="showSection('manual')" class="w-full flex items-center p-4 rounded-2xl font-bold text-slate-400 hover:text-cyan-400 transition-all">
                <i class="fas fa-book w-8"></i> Manual
            </button>
        </nav>
        <div class="p-4 glass-card rounded-2xl text-center">
            <p id="user-role-badge" class="text-[8px] font-black text-cyan-400 uppercase mb-1"></p>
            <p id="display-user" class="text-[10px] text-white truncate"></p>
            <button onclick="logout()" class="text-[9px] text-red-500 font-black mt-2 uppercase">Salir</button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto">
        <header class="p-8">
            <h2 id="section-title" class="text-3xl font-black uppercase italic text-white">Dashboard</h2>
        </header>

        <div id="content-area" class="p-8">
            
            <!-- Dashboard -->
            <section id="sec-dashboard" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="glass-card p-8 border-l-4 border-purple-500"><h4>Total Activos</h4><p id="dash-total" class="text-4xl font-black">0</p></div>
                <div class="glass-card p-8 border-l-4 border-emerald-500"><h4>Excelente</h4><p id="dash-excelente" class="text-4xl font-black">0</p></div>
                <div class="glass-card p-8 border-l-4 border-orange-500"><h4>Mantenimiento</h4><p id="dash-mantenimiento" class="text-4xl font-black">0</p></div>
                <div class="glass-card p-8 border-l-4 border-red-500"><h4>Da√±ado</h4><p id="dash-danado" class="text-4xl font-black">0</p></div>
            </section>

            <!-- Inventario -->
            <section id="sec-inventario" class="hidden space-y-8">
                <div class="glass-card p-8">
                    <h3 id="asset-form-title" class="text-xl font-black mb-6 uppercase">Gesti√≥n de Activo</h3>
                    <form id="form-asset" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="edit-id">
                        <input type="text" id="as-name" placeholder="Nombre del Activo" class="input-dark" required>
                        <input type="text" id="as-serial" placeholder="Serial / N√∫mero de Inventario" class="input-dark" required>
                        <input type="text" id="as-loc" placeholder="Ubicaci√≥n F√≠sica" class="input-dark" required>
                        <select id="as-type" class="input-dark bg-slate-800">
                            <option value="">Tipo de Activo</option>
                            <option value="Computadora">Computadora</option>
                            <option value="Laptop">Laptop</option>
                            <option value="Monitor">Monitor</option>
                            <option value="Impresora">Impresora</option>
                            <option value="Servidor">Servidor</option>
                            <option value="Proyector">Proyector</option>
                            <option value="Tel√©fono IP">Tel√©fono IP</option>
                            <option value="Switch/Router">Switch/Router</option>
                            <option value="Otro">Otro</option>
                        </select>
                        <select id="as-dept" class="input-dark bg-slate-800">
                            <option value="">Departamento (opcional)</option>
                        </select>
                        <div class="col-span-full">
                            <label class="block text-[10px] text-slate-400 uppercase font-black mb-2 tracking-wider">
                                <i class="fas fa-image mr-1"></i> Imagen del Activo
                            </label>
                            <div id="img-upload-zone" onclick="document.getElementById('as-photo-file').click()" class="relative w-full h-36 rounded-2xl border-2 border-dashed border-white/20 hover:border-cyan-400/50 cursor-pointer transition-all flex flex-col items-center justify-center gap-2 bg-white/5 hover:bg-white/8 overflow-hidden">
                                <img id="img-preview" class="hidden absolute inset-0 w-full h-full object-cover rounded-2xl opacity-80">
                                <div id="img-placeholder" class="flex flex-col items-center gap-2 pointer-events-none">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-slate-500"></i>
                                    <p class="text-xs text-slate-400 font-bold">Haz clic para subir imagen</p>
                                    <p class="text-[9px] text-slate-600">JPG, PNG, WEBP ‚Äî m√°x. 2 MB</p>
                                </div>
                                <div id="img-change-overlay" class="hidden absolute inset-0 bg-black/50 items-center justify-center rounded-2xl">
                                    <p class="text-white text-xs font-black uppercase"><i class="fas fa-pencil-alt mr-1"></i>Cambiar imagen</p>
                                </div>
                            </div>
                            <input type="file" id="as-photo-file" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                            <input type="hidden" id="as-photo">
                            <p id="img-upload-error" class="hidden text-[10px] text-red-400 mt-1 font-bold"></p>
                        </div>
                        <input type="date" id="as-purchase" placeholder="Fecha de Adquisici√≥n" class="input-dark">
                        <select id="as-cond" class="input-dark bg-slate-800">
                            <option value="Excelente">Excelente</option>
                            <option value="Mantenimiento">Mantenimiento</option>
                            <option value="Da√±ado">Da√±ado</option>
                        </select>
                        <textarea id="as-reason" placeholder="Detalle del estado del activo..." class="input-dark h-24 col-span-full"></textarea>
                        <button type="submit" class="col-span-full btn-primary p-4 rounded-xl font-black uppercase">Sincronizar Activo</button>
                    </form>
                </div>
                <div id="assets-container" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
            </section>

            <!-- Usuarios -->
            <section id="sec-usuarios" class="hidden space-y-8">
                <div class="glass-card p-8">
                    <h3 class="text-xl font-black mb-6 uppercase">Registrar Nuevo Personal</h3>
                    <form id="form-user" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="u-name" placeholder="Nombre Completo" class="input-dark" required>
                        <input type="text" id="u-cedula" placeholder="C√©dula / ID Empleado" class="input-dark" required>
                        <input type="email" id="u-email" placeholder="Correo Institucional" class="input-dark" required>
                        <input type="text" id="u-cargo" placeholder="Cargo / Puesto" class="input-dark">
                        <select id="u-dept-assign" class="input-dark bg-slate-800">
                            <option value="">Departamento</option>
                        </select>
                        <select id="u-role" class="input-dark bg-slate-800">
                            <option value="operario">‚öôÔ∏è Nivel 3 ‚Äî Personal Operario</option>
                            <option value="mantenimiento">üîß Nivel 2 ‚Äî Personal de Mantenimiento</option>
                            <option value="admin">üõ°Ô∏è Nivel 1 ‚Äî Personal Administrativo</option>
                        </select>
                        <button type="submit" class="col-span-full btn-primary p-4 rounded-xl font-black uppercase">A√±adir al Sistema</button>
                    </form>
                </div>
                <div id="admin-user-list" class="glass-card p-8">
                    <h3 class="text-xl font-black mb-6 uppercase">Panel Administrativo de Usuarios</h3>
                    <div id="users-table-container" class="overflow-x-auto text-sm"></div>
                </div>
            </section>

            <!-- Reportes Mejorados -->
            <section id="sec-reportes" class="hidden space-y-6">
                <!-- Tabs de Reportes -->
                <div class="glass-card p-4 flex gap-2">
                    <button onclick="showReportTab('general')" id="report-tab-general" class="flex-1 py-3 rounded-xl font-black uppercase text-xs transition-all bg-gradient-to-r from-purple-500 to-cyan-500 text-white">
                        <i class="fas fa-chart-pie mr-2"></i>Reporte General
                    </button>
                    <button onclick="showReportTab('por-activo')" id="report-tab-por-activo" class="flex-1 py-3 rounded-xl font-black uppercase text-xs transition-all bg-white/5 text-slate-400 hover:text-white">
                        <i class="fas fa-box mr-2"></i>Por Activo
                    </button>
                </div>
                
                <!-- Stats Bar -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="report-stats-bar">
                    <div class="glass-card p-5 flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center">
                            <i class="fas fa-clipboard-list text-purple-400"></i>
                        </div>
                        <div>
                            <p class="text-[9px] text-slate-500 uppercase font-bold">Total</p>
                            <p id="stat-total" class="text-2xl font-black text-white">0</p>
                        </div>
                    </div>
                    <div class="glass-card p-5 flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-red-500/20 flex items-center justify-center">
                            <i class="fas fa-times-circle text-red-400"></i>
                        </div>
                        <div>
                            <p class="text-[9px] text-slate-500 uppercase font-bold">Da√±ado</p>
                            <p id="stat-danado" class="text-2xl font-black text-red-400">0</p>
                        </div>
                    </div>
                    <div class="glass-card p-5 flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-orange-500/20 flex items-center justify-center">
                            <i class="fas fa-tools text-orange-400"></i>
                        </div>
                        <div>
                            <p class="text-[9px] text-slate-500 uppercase font-bold">Mantenimiento</p>
                            <p id="stat-mantenimiento" class="text-2xl font-black text-orange-400">0</p>
                        </div>
                    </div>
                    <div class="glass-card p-5 flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-emerald-500/20 flex items-center justify-center">
                            <i class="fas fa-check-circle text-emerald-400"></i>
                        </div>
                        <div>
                            <p class="text-[9px] text-slate-500 uppercase font-bold">Excelente</p>
                            <p id="stat-excelente" class="text-2xl font-black text-emerald-400">0</p>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="glass-card p-5 flex flex-col md:flex-row gap-4 items-center">
                    <div class="relative flex-1 w-full">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
                        <input id="report-search" type="text" placeholder="Buscar por activo, usuario o motivo..." class="w-full input-dark pl-10 py-3 text-sm">
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="setReportFilter('todos')" id="filter-todos" class="report-filter-btn active-filter px-4 py-2 rounded-xl text-xs font-black uppercase transition-all">Todos</button>
                        <button onclick="setReportFilter('Da√±ado')" id="filter-danado" class="report-filter-btn px-4 py-2 rounded-xl text-xs font-black uppercase transition-all bg-white/5 text-slate-400 hover:text-red-400">Da√±ado</button>
                        <button onclick="setReportFilter('Mantenimiento')" id="filter-mantenimiento" class="report-filter-btn px-4 py-2 rounded-xl text-xs font-black uppercase transition-all bg-white/5 text-slate-400 hover:text-orange-400">Mantenimiento</button>
                        <button onclick="setReportFilter('Excelente')" id="filter-excelente" class="report-filter-btn px-4 py-2 rounded-xl text-xs font-black uppercase transition-all bg-white/5 text-slate-400 hover:text-emerald-400">Excelente</button>
                    </div>
                </div>
                
                <!-- Time filter + print -->
                <div class="glass-card p-4 flex flex-col md:flex-row gap-3 items-center justify-between">
                    <div class="flex gap-2 flex-wrap items-center">
                        <span class="text-[9px] text-slate-500 uppercase font-black mr-1"><i class="fas fa-calendar-alt mr-1"></i>Per√≠odo:</span>
                        <button onclick="setTimeFilter('all')" id="tfilter-all" class="time-filter-btn active-time px-3 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all">Todo</button>
                        <button onclick="setTimeFilter('day')" id="tfilter-day" class="time-filter-btn px-3 py-1.5 rounded-lg text-[10px] font-black uppercase bg-white/5 text-slate-400 transition-all">Hoy</button>
                        <button onclick="setTimeFilter('week')" id="tfilter-week" class="time-filter-btn px-3 py-1.5 rounded-lg text-[10px] font-black uppercase bg-white/5 text-slate-400 transition-all">Esta Semana</button>
                        <button onclick="setTimeFilter('month')" id="tfilter-month" class="time-filter-btn px-3 py-1.5 rounded-lg text-[10px] font-black uppercase bg-white/5 text-slate-400 transition-all">Este Mes</button>
                    </div>
                    <button onclick="printReport()" class="bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all flex items-center gap-2">
                        <i class="fas fa-print"></i> Imprimir Reporte Membretado
                    </button>
                </div>
                
                <!-- Header row -->
                <div class="flex items-center justify-between px-1">
                    <h3 class="text-sm font-black uppercase text-slate-400 tracking-widest">
                        <i class="fas fa-history mr-2"></i>Historial de Actividad
                    </h3>
                    <span id="report-count-label" class="text-[9px] text-slate-600 font-bold uppercase"></span>
                </div>

                <!-- Empty state -->
                <div id="reports-empty" class="hidden glass-card p-16 text-center">
                    <i class="fas fa-inbox text-4xl text-slate-700 mb-4"></i>
                    <p class="font-black text-slate-500 uppercase text-sm">Sin reportes encontrados</p>
                    <p class="text-xs text-slate-600 mt-1">Intenta con otros filtros o t√©rminos de b√∫squeda</p>
                </div>

                <!-- Reporte General Container -->
                <div id="report-general-container" class="space-y-3"></div>
                
                <!-- Reporte Por Activo Container -->
                <div id="report-por-activo-container" class="hidden space-y-4"></div>
            </section>

            <!-- SECCI√ìN UNIFICADA: DEPARTAMENTOS Y ASIGNACIONES -->
            <section id="sec-departamentos-asignaciones" class="hidden space-y-8">
                <!-- Tabs para cambiar entre Departamentos y Asignaciones -->
                <div class="glass-card p-4 flex gap-2">
                    <button onclick="showDeptAsignTab('departamentos')" id="dept-tab-departamentos" class="dept-tab active">
                        <i class="fas fa-building mr-2"></i>Departamentos
                    </button>
                    <button onclick="showDeptAsignTab('asignaciones')" id="dept-tab-asignaciones" class="dept-tab">
                        <i class="fas fa-link mr-2"></i>Asignaciones
                    </button>
                </div>

                <!-- Contenedor de Departamentos -->
                <div id="dept-container" class="space-y-8">
                    <div class="glass-card p-8">
                        <h3 class="text-xl font-black mb-6 uppercase">Gesti√≥n de Departamentos</h3>
                        <form id="form-dept" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="dept-edit-id">
                            <input type="text" id="dept-name" placeholder="Nombre del Departamento *" class="input-dark" required>
                            <input type="text" id="dept-coord" placeholder="Coordinador / Jefe" class="input-dark">
                            <input type="text" id="dept-area" placeholder="√Årea / Piso" class="input-dark">
                            <input type="tel" id="dept-phone" placeholder="Tel√©fono de contacto" class="input-dark">
                            <input type="email" id="dept-email" placeholder="Correo del departamento" class="input-dark">
                            <textarea id="dept-address" placeholder="Direcci√≥n / Ubicaci√≥n completa" class="input-dark col-span-full h-20"></textarea>
                            <button type="submit" class="col-span-full btn-primary p-4 rounded-xl font-black uppercase">
                                <i class="fas fa-save mr-2"></i>Guardar Departamento
                            </button>
                        </form>
                    </div>
                    
                    <div class="glass-card p-8">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-black uppercase">Tabla de Departamentos</h3>
                            <span id="dept-count" class="bg-white/5 text-slate-400 px-3 py-1 rounded-full text-[10px] font-bold">0 departamentos</span>
                        </div>
                        <div id="depts-table-container" class="overflow-x-auto"></div>
                    </div>
                </div>

                <!-- Contenedor de Asignaciones - CON EL FORMATO SOLICITADO -->
                <div id="asignaciones-container" class="hidden space-y-8">
                    <div class="glass-card p-8">
                        <h3 class="text-xl font-black mb-2 uppercase">Tabla de Asignaci√≥n de Activos</h3>
                        <p class="text-xs text-slate-500 mb-6">Asigna activos tecnol√≥gicos a usuarios registrados y departamentos.</p>
                        <form id="form-assign" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="assign-edit-id">
                            <select id="assign-asset" class="input-dark bg-slate-800" required>
                                <option value="">Seleccionar Activo</option>
                            </select>
                            <select id="assign-user" class="input-dark bg-slate-800" required>
                                <option value="">Seleccionar Personal</option>
                            </select>
                            <select id="assign-dept" class="input-dark bg-slate-800">
                                <option value="">Departamento</option>
                            </select>
                            <input type="text" id="assign-location" placeholder="Ubicaci√≥n espec√≠fica" class="input-dark">
                            <input type="date" id="assign-date" class="input-dark" title="Fecha de asignaci√≥n">
                            <select id="assign-status" class="input-dark bg-slate-800">
                                <option value="Activo">Activo (en uso)</option>
                                <option value="Devuelto">Devuelto</option>
                                <option value="En reparaci√≥n">En reparaci√≥n</option>
                            </select>
                            <textarea id="assign-notes" placeholder="Notas de la asignaci√≥n..." class="input-dark h-20 col-span-full"></textarea>
                            <button type="submit" class="col-span-full btn-primary p-4 rounded-xl font-black uppercase"><i class="fas fa-link mr-2"></i>Registrar Asignaci√≥n</button>
                        </form>
                    </div>
                    <div class="glass-card p-8">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-black uppercase">Registro de Asignaciones</h3>
                            <div class="flex gap-2">
                                <input id="assign-search" type="text" placeholder="Buscar asignaci√≥n..." class="input-dark py-2 text-xs w-48">
                                <button onclick="exportAssignmentsToExcel()" class="bg-emerald-600/20 hover:bg-emerald-600/40 px-3 py-2 rounded-xl text-[10px] font-black uppercase transition-all flex items-center gap-1">
                                    <i class="fas fa-file-excel"></i> Exportar
                                </button>
                            </div>
                        </div>
                        <div id="assignments-table-container" class="table-section"></div>
                        <div id="assignments-total" class="total-count"></div>
                    </div>
                </div>
            </section>

            <!-- Registrados -->
            <section id="sec-registrados" class="hidden space-y-6">
                <div class="glass-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-black uppercase">Solicitudes de Acceso al Sistema</h3>
                            <p class="text-xs text-slate-500 mt-1">Usuarios que solicitaron acceso a la app.</p>
                        </div>
                        <span id="pending-count-label" class="bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 text-[10px] font-black px-3 py-1 rounded-full uppercase">0 Pendientes</span>
                    </div>
                    <div id="registrados-container" class="space-y-3"></div>
                </div>
                <div class="glass-card p-6">
                    <h3 class="text-xl font-black uppercase mb-4">Todos los Usuarios del Sistema</h3>
                    <div id="all-auth-users-container" class="overflow-x-auto text-sm"></div>
                </div>
            </section>

            <!-- Manual -->
            <section id="sec-manual" class="hidden space-y-6 max-w-4xl mx-auto">
                <div class="letterhead-header glass-card p-8 flex items-center gap-6">
                    <img src="https://raw.githubusercontent.com/anniel137/uptjaa-inventory/main/gemini-2.5-flash-image_quiero_que_me_crees_el_logo_de_el_polianzoategui_que_sea_algo_mas_futurista-0.jpg" class="w-20 h-20 rounded-full border-2 border-purple-500 object-cover shrink-0">
                    <div>
                        <h1 class="font-black text-3xl italic text-white">NEXUS-ID</h1>
                        <p class="text-[9px] font-bold text-cyan-400 uppercase tracking-widest">Sistema Integrado de Activos Tecnol√≥gicos</p>
                        <p class="text-xs text-slate-400 mt-1">Universidad Polit√©cnica Territorial Jos√© Antonio Anzo√°tegui</p>
                        <p class="text-[10px] text-slate-500 mt-0.5 font-black uppercase">Manual de Usuario ‚Äî v2.0</p>
                    </div>
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="showManualTab('intro')" id="mtab-intro" class="manual-tab active px-4 py-2 rounded-xl text-xs font-black uppercase bg-white/5 text-slate-400">Introducci√≥n</button>
                    <button onclick="showManualTab('login')" id="mtab-login" class="manual-tab px-4 py-2 rounded-xl text-xs font-black uppercase bg-white/5 text-slate-400">Acceso</button>
                    <button onclick="showManualTab('inventario')" id="mtab-inventario" class="manual-tab px-4 py-2 rounded-xl text-xs font-black uppercase bg-white/5 text-slate-400">Inventario</button>
                    <button onclick="showManualTab('asignacion')" id="mtab-asignacion" class="manual-tab px-4 py-2 rounded-xl text-xs font-black uppercase bg-white/5 text-slate-400">Asignaciones</button>
                    <button onclick="showManualTab('reportes')" id="mtab-reportes" class="manual-tab px-4 py-2 rounded-xl text-xs font-black uppercase bg-white/5 text-slate-400">Reportes</button>
                    <button onclick="showManualTab('roles')" id="mtab-roles" class="manual-tab px-4 py-2 rounded-xl text-xs font-black uppercase bg-white/5 text-slate-400">Roles</button>
                    <button onclick="showManualTab('qr')" id="mtab-qr" class="manual-tab px-4 py-2 rounded-xl text-xs font-black uppercase bg-white/5 text-slate-400">C√≥digo QR</button>
                </div>
                <div id="manual-content-area" class="manual-content glass-card p-8 space-y-6 text-sm leading-relaxed text-slate-300"></div>
            </section>

            <!-- Scan View -->
            <section id="sec-scan-view" class="hidden max-w-2xl mx-auto">
                <div class="glass-card overflow-hidden">
                    <img id="scan-img" class="w-full h-72 object-cover">
                    <div class="p-8 space-y-6">
                        <h2 id="scan-name" class="text-4xl font-black uppercase italic text-cyan-400"></h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white/5 p-4 rounded-2xl"><p class="text-[9px] text-slate-500 uppercase">Estado</p><p id="scan-cond" class="font-black"></p></div>
                            <div class="bg-white/5 p-4 rounded-2xl"><p class="text-[9px] text-slate-500 uppercase">Ubicaci√≥n</p><p id="scan-loc" class="font-black"></p></div>
                        </div>
                        <div id="scan-reason-box" class="bg-red-500/10 border border-red-500/20 p-4 rounded-2xl hidden">
                            <p id="scan-reason-text" class="text-sm italic"></p>
                        </div>
                        <hr class="border-white/10">
                        <div class="space-y-4">
                            <h3 class="font-black text-xs uppercase text-center">Actualizar Novedad</h3>
                            <select id="rep-new-cond" class="w-full input-dark bg-slate-800">
                                <option value="Da√±ado">Da√±ado</option>
                                <option value="Mantenimiento">Mantenimiento</option>
                                <option value="Excelente">Excelente</option>
                            </select>
                            <textarea id="rep-reason" placeholder="Explicaci√≥n detallada..." class="w-full input-dark h-24" required></textarea>
                            <button id="btn-send-report" class="w-full btn-primary p-4 rounded-2xl font-black uppercase">Guardar Reporte</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
</div>

<script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyD0rFUIbW_494SmefO7FRVhsBVW1aXxcDo",
        authDomain: "control-de-activos-1c3b7.firebaseapp.com",
        databaseURL: "https://control-de-activos-1c3b7-default-rtdb.firebaseio.com",
        projectId: "control-de-activos-1c3b7",
        storageBucket: "control-de-activos-1c3b7.firebasestorage.app",
        messagingSenderId: "898905793270",
        appId: "1:898905793270:web:7e8e1219f999af6a88c2d7"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const MASTER_EMAIL = "anniel137@gmail.com";
    
    // ===================== VARIABLES GLOBALES =====================
    let userRole = "operario";
    let allReports = [];
    let activeFilter = 'todos';
    let activeTimeFilter = 'all';
    let currentReportTab = 'general';
    let assetReportsMap = {};
    let allDepts = [];
    let allAssignments = [];
    let allUsers = [];
    let allAssets = [];
    
    const urlParams = new URLSearchParams(window.location.search);
    const scannedId = urlParams.get('id');
    
    // ===================== FUNCIONES UTILITARIAS =====================
    function showLoader(message = 'Procesando...') {
        const loader = document.getElementById('global-loader');
        loader.querySelector('p').textContent = message;
        loader.classList.remove('hidden');
    }
    
    function hideLoader() {
        document.getElementById('global-loader').classList.add('hidden');
    }
    
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const colors = {
            success: 'bg-emerald-500/90 border-emerald-400',
            error: 'bg-red-500/90 border-red-400',
            warning: 'bg-orange-500/90 border-orange-400',
            info: 'bg-cyan-500/90 border-cyan-400'
        };
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        const toast = document.createElement('div');
        toast.className = `${colors[type]} backdrop-blur-lg border text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 transform transition-all duration-300 translate-x-full`;
        toast.innerHTML = `<i class="fas ${icons[type]} text-xl"></i><span class="font-bold text-sm">${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => toast.classList.remove('translate-x-full'), 10);
        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    function showConfirm(title, message) {
        return new Promise((resolve) => {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            modal.classList.remove('hidden');
            
            const handleYes = () => {
                modal.classList.add('hidden');
                cleanup();
                resolve(true);
            };
            const handleNo = () => {
                modal.classList.add('hidden');
                cleanup();
                resolve(false);
            };
            const cleanup = () => {
                document.getElementById('confirm-yes').removeEventListener('click', handleYes);
                document.getElementById('confirm-no').removeEventListener('click', handleNo);
            };
            
            document.getElementById('confirm-yes').addEventListener('click', handleYes);
            document.getElementById('confirm-no').addEventListener('click', handleNo);
        });
    }
    
    // ===================== NAVEGACI√ìN =====================
    function showSection(id) {
        document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
        const sec = document.getElementById('sec-' + id);
        if (sec) sec.classList.remove('hidden');
        
        // Actualizar t√≠tulo seg√∫n la secci√≥n
        let title = id.charAt(0).toUpperCase() + id.slice(1);
        if (id === 'departamentos-asignaciones') title = 'Departamentos y Asignaciones';
        document.getElementById('section-title').textContent = title;
        
        // Highlight nav
        document.querySelectorAll('nav button').forEach(b => {
            b.classList.remove('text-cyan-400', 'bg-white/10');
            b.classList.add('text-slate-400');
        });
        const navBtn = document.getElementById('nav-' + id);
        if (navBtn) { 
            navBtn.classList.add('text-cyan-400', 'bg-white/10'); 
            navBtn.classList.remove('text-slate-400'); 
        }
    }
    
    // ===================== LOGIN Y AUTH =====================
    document.getElementById('login-form').onsubmit = (e) => {
        e.preventDefault();
        auth.signInWithEmailAndPassword(
            document.getElementById('user-input').value, 
            document.getElementById('pass-input').value
        ).catch(() => showToast("Acceso denegado. Verifique sus credenciales.", "error"));
    };
    
    function logout() { 
        auth.signOut().then(() => location.href = window.location.origin + window.location.pathname); 
    }
    
    function toggleRegRequest() {
        document.getElementById('reg-request-form').classList.toggle('hidden');
    }
    
    function submitRegRequest() {
        const name = document.getElementById('reg-name').value;
        const cedula = document.getElementById('reg-cedula').value;
        const email = document.getElementById('reg-email').value;
        const cargo = document.getElementById('reg-cargo').value;
        if (!name || !cedula || !email) { 
            showToast("Completa nombre, c√©dula y correo.", "warning"); 
            return; 
        }
        db.ref('access_requests').push({
            name, cedula, email, cargo,
            status: 'pendiente',
            timestamp: new Date().toISOString(),
            date: new Date().toLocaleString()
        }).then(() => {
            showToast("‚úÖ Solicitud enviada. Un administrador la revisar√°.");
            document.getElementById('reg-request-form').classList.add('hidden');
            ['reg-name','reg-cedula','reg-email','reg-cargo'].forEach(id => 
                document.getElementById(id).value = '');
        });
    }
    
    // ===================== VISTA P√öBLICA QR =====================
    if (scannedId) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('public-scan-screen').classList.remove('hidden');
        loadPublicAsset(scannedId);
    }
    
    function loadPublicAsset(id) {
        db.ref('assets/' + id).once('value', snap => {
            document.getElementById('public-loading').classList.add('hidden');
            const a = snap.val();
            if (!a) {
                document.getElementById('public-not-found').classList.remove('hidden');
                return;
            }
            const card = document.getElementById('public-asset-card');
            card.classList.remove('hidden');
            document.getElementById('pub-img').src = a.imageUrl;
            document.getElementById('pub-name').textContent = a.name;
            document.getElementById('pub-serial').textContent = a.serial || 'N/A';
            const condEl = document.getElementById('pub-cond');
            condEl.textContent = a.cond;
            condEl.className = 'font-black text-sm ' + (a.cond === 'Da√±ado' ? 'text-red-400' : a.cond === 'Mantenimiento' ? 'text-orange-400' : 'text-emerald-400');
            document.getElementById('pub-loc').textContent = a.location;
            if (a.reason) {
                document.getElementById('pub-reason-box').classList.remove('hidden');
                document.getElementById('pub-reason-text').textContent = a.reason;
            }
        });
    }
    
    // ===================== INVENTARIO (con creador/editor) =====================
    function loadAssets() {
        db.ref('assets').on('value', snap => {
            const container = document.getElementById('assets-container');
            container.innerHTML = '';
            let stats = { total: 0, Excelente: 0, Mantenimiento: 0, Da√±ado: 0 };
            snap.forEach(doc => {
                const a = doc.val(); 
                stats.total++; 
                stats[a.cond]++;
                
                // Determinar qui√©n cre√≥ y edit√≥
                const creador = a.createdBy ? `<span class="text-[8px] text-cyan-400/70">Creado por: ${a.createdBy}</span>` : '';
                const editor = a.updatedBy ? `<span class="text-[8px] text-purple-400/70">Editado por: ${a.updatedBy}</span>` : '';
                
                container.innerHTML += `
                    <div class="glass-card p-6 border border-white/5">
                        <img src="${a.imageUrl}" class="w-full h-32 object-cover rounded-xl mb-4">
                        <h4 class="text-white font-black uppercase text-xs">${a.name}</h4>
                        <p class="text-[9px] font-bold ${a.cond === 'Da√±ado' ? 'text-red-500' : 'text-cyan-400'} uppercase">${a.cond}</p>
                        <div class="text-[8px] text-slate-500 mt-2 space-y-0.5">
                            ${creador}
                            ${editor}
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button onclick="editAsset('${doc.key}')" class="flex-1 bg-white/5 p-2 rounded-lg text-[9px] font-bold">EDITAR</button>
                            <button onclick="openQR('${doc.key}')" class="flex-1 bg-white/5 p-2 rounded-lg text-[9px] font-bold">QR</button>
                            <button onclick="deleteAsset('${doc.key}')" class="p-2 text-red-500/50 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
            });
            document.getElementById('dash-total').textContent = stats.total;
            document.getElementById('dash-excelente').textContent = stats.Excelente;
            document.getElementById('dash-mantenimiento').textContent = stats.Mantenimiento;
            document.getElementById('dash-danado').textContent = stats.Da√±ado;
        });
    }
    
    document.getElementById('form-asset').onsubmit = (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-id').value;
        const deptKey = document.getElementById('as-dept').value;
        const dept = allDepts.find(d=>d.key===deptKey);
        const currentUser = auth.currentUser;
        const userEmail = currentUser ? currentUser.email : 'Sistema';
        
        const data = {
            name: document.getElementById('as-name').value,
            serial: document.getElementById('as-serial').value,
            type: document.getElementById('as-type').value,
            location: document.getElementById('as-loc').value,
            deptKey: deptKey, 
            deptName: dept?.name||'',
            imageUrl: document.getElementById('as-photo').value,
            purchaseDate: document.getElementById('as-purchase').value,
            cond: document.getElementById('as-cond').value,
            reason: document.getElementById('as-reason').value,
            updatedAt: new Date().toISOString(),
            updatedBy: userEmail
        };
        
        showLoader(id ? "Actualizando activo..." : "Guardando activo...");
        
        if(id) {
            db.ref('assets/'+id).update(data).then(() => { 
                showToast("Activo actualizado correctamente");
                e.target.reset(); 
                resetImageUpload(); 
                document.getElementById('edit-id').value='';
                hideLoader();
            });
        } else {
            data.createdAt = new Date().toISOString();
            data.createdBy = userEmail;
            db.ref('assets').push(data).then(() => { 
                showToast("Activo guardado correctamente");
                e.target.reset(); 
                resetImageUpload(); 
                hideLoader();
            });
        }
    };
    
    function editAsset(id) {
        db.ref('assets/'+id).once('value', snap => {
            const a = snap.val();
            document.getElementById('edit-id').value = id;
            document.getElementById('as-name').value = a.name;
            document.getElementById('as-serial').value = a.serial;
            document.getElementById('as-type').value = a.type||'';
            document.getElementById('as-loc').value = a.location;
            document.getElementById('as-dept').value = a.deptKey||'';
            document.getElementById('as-purchase').value = a.purchaseDate||'';
            document.getElementById('as-cond').value = a.cond;
            document.getElementById('as-reason').value = a.reason||'';
            
            if (a.imageUrl) {
                document.getElementById('as-photo').value = a.imageUrl;
                const preview = document.getElementById('img-preview');
                const placeholder = document.getElementById('img-placeholder');
                const overlay = document.getElementById('img-change-overlay');
                preview.src = a.imageUrl;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            }
            showSection('inventario');
        });
    }
    
    function deleteAsset(id) {
        showConfirm('Eliminar Activo', '¬øSeguro que deseas eliminar este activo tecnol√≥gico? Esta acci√≥n no se puede deshacer.')
            .then(confirmed => {
                if (confirmed) {
                    showLoader('Eliminando...');
                    db.ref('assets/' + id).remove().then(() => {
                        hideLoader();
                        showToast('Activo eliminado correctamente');
                    });
                }
            });
    }
    
    function openQR(id) {
        db.ref('assets/' + id).once('value', snap => {
            const a = snap.val();
            const m = document.createElement('div');
            m.className = "fixed inset-0 z-[3000] bg-black/95 flex items-center justify-center p-6";
            m.innerHTML = `
                <div class="glass-card p-8 text-center" id="print-area">
                    <div id="qr-gen" class="bg-white p-4 rounded-2xl mb-4 inline-block"></div>
                    <h4 id="qr-label" class="text-white font-black uppercase text-sm mb-4">${a.name}</h4>
                    <div class="flex flex-col gap-2 w-full no-print">
                        <button onclick="window.print()" class="w-full bg-emerald-600 hover:bg-emerald-500 p-3 rounded-xl font-black uppercase text-xs transition">
                            <i class="fas fa-print mr-2"></i>Imprimir QR
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="w-full btn-primary p-3 rounded-xl font-black uppercase text-xs">
                            Cerrar
                        </button>
                    </div>
                </div>`;
            document.body.appendChild(m);
            new QRCode(document.getElementById('qr-gen'), { 
                text: window.location.origin + window.location.pathname + "?id=" + id, 
                width: 220, 
                height: 220 
            });
        });
    }
    
    function handleImageUpload(event) {
        const file = event.target.files[0];
        const errEl = document.getElementById('img-upload-error');
        errEl.classList.add('hidden');
        if (!file) return;
        if (file.size > 2 * 1024 * 1024) {
            errEl.textContent = '‚ö†Ô∏è La imagen supera los 2 MB. Elige una imagen m√°s peque√±a.';
            errEl.classList.remove('hidden');
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('as-photo').value = e.target.result;
            const preview = document.getElementById('img-preview');
            const placeholder = document.getElementById('img-placeholder');
            const overlay = document.getElementById('img-change-overlay');
            preview.src = e.target.result;
            preview.classList.remove('hidden');
            placeholder.classList.add('hidden');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
        };
        reader.readAsDataURL(file);
    }
    
    function resetImageUpload() {
        document.getElementById('as-photo').value = '';
        document.getElementById('as-photo-file').value = '';
        const preview = document.getElementById('img-preview');
        const placeholder = document.getElementById('img-placeholder');
        const overlay = document.getElementById('img-change-overlay');
        preview.src = '';
        preview.classList.add('hidden');
        placeholder.classList.remove('hidden');
        overlay.classList.add('hidden');
        overlay.classList.remove('flex');
        document.getElementById('img-upload-error').classList.add('hidden');
    }
    
    // ===================== REPORTES MEJORADOS =====================
    function loadReports() {
        db.ref('reports').on('value', snap => {
            allReports = [];
            assetReportsMap = {};
            
            snap.forEach(doc => {
                const report = { key: doc.key, ...doc.val() };
                allReports.unshift(report);
                
                const assetName = report.assetName || 'Activo sin nombre';
                if (!assetReportsMap[assetName]) {
                    assetReportsMap[assetName] = [];
                }
                assetReportsMap[assetName].push(report);
            });
            
            updateReportStats();
            
            if (currentReportTab === 'general') {
                renderReports();
            } else {
                renderAssetReports();
            }
        });
    }
    
    function showReportTab(tab) {
        currentReportTab = tab;
        const tabGeneral = document.getElementById('report-tab-general');
        const tabPorActivo = document.getElementById('report-tab-por-activo');
        
        if (tab === 'general') {
            tabGeneral.className = 'flex-1 py-3 rounded-xl font-black uppercase text-xs transition-all bg-gradient-to-r from-purple-500 to-cyan-500 text-white';
            tabPorActivo.className = 'flex-1 py-3 rounded-xl font-black uppercase text-xs transition-all bg-white/5 text-slate-400 hover:text-white';
            document.getElementById('report-general-container').classList.remove('hidden');
            document.getElementById('report-por-activo-container').classList.add('hidden');
            renderReports();
        } else {
            tabPorActivo.className = 'flex-1 py-3 rounded-xl font-black uppercase text-xs transition-all bg-gradient-to-r from-purple-500 to-cyan-500 text-white';
            tabGeneral.className = 'flex-1 py-3 rounded-xl font-black uppercase text-xs transition-all bg-white/5 text-slate-400 hover:text-white';
            document.getElementById('report-por-activo-container').classList.remove('hidden');
            document.getElementById('report-general-container').classList.add('hidden');
            renderAssetReports();
        }
    }
    
    function renderAssetReports() {
        const container = document.getElementById('report-por-activo-container');
        if (!container) return;
        
        const assetNames = Object.keys(assetReportsMap).sort();
        
        if (assetNames.length === 0) {
            container.innerHTML = '<div class="glass-card p-16 text-center"><i class="fas fa-inbox text-4xl text-slate-700 mb-4"></i><p class="font-black text-slate-500 uppercase text-sm">Sin reportes por activo</p></div>';
            return;
        }
        
        let html = '';
        
        for (const assetName of assetNames) {
            const reports = assetReportsMap[assetName];
            const lastReport = reports[0];
            const reportCount = reports.length;
            const estados = { Da√±ado: 0, Mantenimiento: 0, Excelente: 0 };
            reports.forEach(r => { if (r.newC) estados[r.newC]++; });
            
            html += `
            <div class="glass-card p-6 asset-report-card" data-asset="${assetName}">
                <div class="flex items-center justify-between cursor-pointer" onclick="toggleAssetReports('${assetName.replace(/'/g, "\\'")}')">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-purple-500/20 to-cyan-500/20 flex items-center justify-center">
                            <i class="fas fa-box text-2xl text-cyan-400"></i>
                        </div>
                        <div>
                            <h3 class="text-white font-black text-lg">${assetName}</h3>
                            <p class="text-[10px] text-slate-500">${reportCount} reporte${reportCount !== 1 ? 's' : ''} ¬∑ √öltimo: ${lastReport.date || 'N/A'}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex gap-1">
                            ${estados.Da√±ado > 0 ? `<span class="badge-danado px-2 py-1 text-[8px] rounded-full"><i class="fas fa-times-circle mr-1"></i>${estados.Da√±ado}</span>` : ''}
                            ${estados.Mantenimiento > 0 ? `<span class="badge-mantenimiento px-2 py-1 text-[8px] rounded-full"><i class="fas fa-tools mr-1"></i>${estados.Mantenimiento}</span>` : ''}
                            ${estados.Excelente > 0 ? `<span class="badge-excelente px-2 py-1 text-[8px] rounded-full"><i class="fas fa-check-circle mr-1"></i>${estados.Excelente}</span>` : ''}
                        </div>
                        <i class="fas fa-chevron-down text-slate-500 transition-transform" id="chevron-${assetName.replace(/\s/g, '')}"></i>
                    </div>
                </div>
                <div id="reports-${assetName.replace(/\s/g, '')}" class="hidden mt-4 space-y-2 pl-16">
                    ${reports.map(r => `
                    <div class="bg-white/5 p-4 rounded-xl border-l-4 ${r.newC === 'Da√±ado' ? 'border-red-500' : r.newC === 'Mantenimiento' ? 'border-orange-500' : 'border-emerald-500'}">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-black uppercase ${r.newC === 'Da√±ado' ? 'text-red-400' : r.newC === 'Mantenimiento' ? 'text-orange-400' : 'text-emerald-400'}">
                                ${r.newC}
                            </span>
                            <span class="text-[8px] text-slate-500">${r.date || 'N/A'}</span>
                        </div>
                        <p class="text-xs italic text-slate-300 mb-2">"${r.reason}"</p>
                        <div class="flex items-center gap-2 text-[9px] text-slate-500">
                            <i class="fas fa-user"></i> ${r.user || 'Sistema'}
                            ${r.updatedBy ? `<span class="text-slate-600">‚Ä¢</span><i class="fas fa-history"></i> Editado: ${r.updatedBy}` : ''}
                        </div>
                    </div>
                    `).join('')}
                </div>
            </div>
            `;
        }
        
        container.innerHTML = html;
    }
    
    function toggleAssetReports(assetName) {
        const containerId = `reports-${assetName.replace(/\s/g, '')}`;
        const container = document.getElementById(containerId);
        const chevron = document.getElementById(`chevron-${assetName.replace(/\s/g, '')}`);
        
        if (container.classList.contains('hidden')) {
            container.classList.remove('hidden');
            chevron.classList.add('rotate-180');
        } else {
            container.classList.add('hidden');
            chevron.classList.remove('rotate-180');
        }
    }
    
    function updateReportStats() {
        const total = allReports.length;
        const danado = allReports.filter(r => r.newC === 'Da√±ado').length;
        const mant = allReports.filter(r => r.newC === 'Mantenimiento').length;
        const exc = allReports.filter(r => r.newC === 'Excelente').length;
        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-danado').textContent = danado;
        document.getElementById('stat-mantenimiento').textContent = mant;
        document.getElementById('stat-excelente').textContent = exc;
    }
    
    function setReportFilter(f) {
        activeFilter = f;
        document.querySelectorAll('.report-filter-btn').forEach(b => {
            b.classList.remove('active-filter');
            b.classList.add('bg-white/5', 'text-slate-400');
        });
        const btn = document.getElementById('filter-' + f.toLowerCase().replace('√©','e').replace('√≥','o').replace('√±','n'));
        if (btn) { 
            btn.classList.add('active-filter'); 
            btn.classList.remove('bg-white/5','text-slate-400'); 
        }
        renderReports();
    }
    
    function setTimeFilter(t) {
        activeTimeFilter = t;
        document.querySelectorAll('.time-filter-btn').forEach(b => {
            b.classList.remove('active-time');
            b.classList.add('bg-white/5','text-slate-400');
        });
        const btn = document.getElementById('tfilter-'+t);
        if (btn) { 
            btn.classList.add('active-time'); 
            btn.classList.remove('bg-white/5','text-slate-400'); 
        }
        renderReports();
    }
    
    function getCurrentFilteredReports() {
        const search = (document.getElementById('report-search')?.value||'').toLowerCase();
        const now = new Date();
        return allReports.filter(r => {
            const matchFilter = activeFilter === 'todos' || r.newC === activeFilter;
            const matchSearch = !search ||
                (r.assetName||'').toLowerCase().includes(search) ||
                (r.user||'').toLowerCase().includes(search) ||
                (r.reason||'').toLowerCase().includes(search);
            let matchTime = true;
            if (activeTimeFilter !== 'all' && r.date) {
                try {
                    const rd = new Date(r.date);
                    if (!isNaN(rd)) {
                        if (activeTimeFilter === 'day') {
                            matchTime = rd.toDateString() === now.toDateString();
                        } else if (activeTimeFilter === 'week') {
                            const weekAgo = new Date(now); 
                            weekAgo.setDate(now.getDate()-7);
                            matchTime = rd >= weekAgo;
                        } else if (activeTimeFilter === 'month') {
                            matchTime = rd.getMonth()===now.getMonth() && rd.getFullYear()===now.getFullYear();
                        }
                    }
                } catch(e) {}
            }
            return matchFilter && matchSearch && matchTime;
        });
    }
    
    function renderReports() {
        const container = document.getElementById('report-general-container');
        const emptyEl = document.getElementById('reports-empty');
        const filtered = getCurrentFilteredReports();
        
        document.getElementById('report-count-label').textContent = `${filtered.length} resultado${filtered.length!==1?'s':''}`;
        
        if (filtered.length === 0) {
            container.innerHTML = '';
            emptyEl.classList.remove('hidden');
            return;
        }
        emptyEl.classList.add('hidden');
        
        const condConfig = {
            'Da√±ado':        { border: 'border-red-500',    badge: 'badge-danado',        icon: 'fa-times-circle' },
            'Mantenimiento': { border: 'border-orange-500', badge: 'badge-mantenimiento', icon: 'fa-tools' },
            'Excelente':     { border: 'border-emerald-500',badge: 'badge-excelente',     icon: 'fa-check-circle' }
        };
        
        container.innerHTML = filtered.map((r, i) => {
            const cfg = condConfig[r.newC] || condConfig['Mantenimiento'];
            const initials = (r.user||'?').substring(0,2).toUpperCase();
            return `
            <div class="report-item glass-card p-5 border-l-4 ${cfg.border} flex gap-4 items-start" style="animation-delay:${i*0.04}s">
                <div class="w-10 h-10 rounded-2xl bg-white/5 flex items-center justify-center shrink-0 text-[10px] font-black text-cyan-400 border border-white/10">${initials}</div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between gap-2 flex-wrap mb-1">
                        <h5 class="text-white font-black uppercase text-sm truncate">${r.assetName || 'Activo'}</h5>
                        <span class="text-[9px] px-3 py-1 rounded-full font-black uppercase ${cfg.badge} shrink-0">
                            <i class="fas ${cfg.icon} mr-1"></i>${r.newC}
                        </span>
                    </div>
                    <p class="text-xs italic text-slate-300 mb-2">"${r.reason}"</p>
                    <div class="flex items-center gap-3 flex-wrap">
                        <span class="text-[9px] text-slate-500 flex items-center gap-1"><i class="fas fa-user text-[8px]"></i>${r.user}</span>
                        <span class="text-[9px] text-slate-600">‚Ä¢</span>
                        <span class="text-[9px] text-slate-500 flex items-center gap-1"><i class="fas fa-clock text-[8px]"></i>${r.date}</span>
                    </div>
                </div>
            </div>`;
        }).join('');
    }
    
    function printReport() {
        const filtered = getCurrentFilteredReports();
        const periodLabel = {'all':'Todo el per√≠odo','day':'Hoy','week':'Esta semana','month':'Este mes'}[activeTimeFilter];
        const condLabel = activeFilter === 'todos' ? 'Todos los estados' : activeFilter;
        const now = new Date().toLocaleString('es-VE');
        const total = filtered.length;
        const danado = filtered.filter(r=>r.newC==='Da√±ado').length;
        const mant = filtered.filter(r=>r.newC==='Mantenimiento').length;
        const exc = filtered.filter(r=>r.newC==='Excelente').length;
        
        const rows = filtered.map(r => `
            <tr style="border-bottom:1px solid #eee;">
                <td style="padding:8px;font-size:11px;">${r.assetName||'-'}</td>
                <td style="padding:8px;font-size:11px;">${r.user||'-'}</td>
                <td style="padding:8px;font-size:11px;color:${r.newC==='Da√±ado'?'#dc2626':r.newC==='Mantenimiento'?'#ea580c':'#16a34a'};font-weight:bold;">${r.newC}</td>
                <td style="padding:8px;font-size:11px;font-style:italic;">${r.reason||'-'}</td>
                <td style="padding:8px;font-size:11px;color:#666;">${r.date||'-'}</td>
            </tr>`).join('');
        
        const win = window.open('','_blank');
        win.document.write(`<!DOCTYPE html><html><head><title>Reporte NEXUS-ID</title>
        <style>
            body{font-family:Arial,sans-serif;margin:0;padding:0;color:#111;}
            .header{background:linear-gradient(135deg,#1a1b25,#0d0e17);color:white;padding:30px 40px;display:flex;align-items:center;gap:20px;}
            .header img{width:70px;height:70px;border-radius:50%;border:2px solid #00f2ff;object-fit:cover;}
            .header-text h1{font-size:28px;font-weight:900;font-style:italic;margin:0;}
            .header-text p{font-size:9px;color:#00f2ff;text-transform:uppercase;letter-spacing:2px;margin:4px 0 0;}
            .meta{background:#f8f9fa;border-bottom:3px solid #bc13fe;padding:12px 40px;display:flex;justify-content:space-between;align-items:center;font-size:10px;color:#666;}
            .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:20px 40px;}
            .stat-card{border:1px solid #e5e7eb;border-radius:8px;padding:12px;text-align:center;}
            .stat-card .num{font-size:28px;font-weight:900;} .stat-card .lbl{font-size:9px;text-transform:uppercase;color:#999;}
            table{width:100%;border-collapse:collapse;margin:0 40px;width:calc(100% - 80px);}
            thead th{background:#1a1b25;color:white;padding:10px 8px;font-size:10px;text-transform:uppercase;text-align:left;}
            .footer{margin-top:30px;padding:15px 40px;border-top:1px solid #eee;display:flex;justify-content:space-between;font-size:9px;color:#999;}
        </style></head><body>
        <div class="header">
            <img src="https://raw.githubusercontent.com/anniel137/uptjaa-inventory/main/gemini-2.5-flash-image_quiero_que_me_crees_el_logo_de_el_polianzoategui_que_sea_algo_mas_futurista-0.jpg">
            <div class="header-text">
                <h1>NEXUS-ID</h1>
                <p>Sistema Integrado de Activos Tecnol√≥gicos</p>
                <small>Universidad Polit√©cnica Territorial Jos√© Antonio Anzo√°tegui</small>
            </div>
        </div>
        <div class="meta">
            <span><strong>Reporte de Novedades</strong> ‚Äî Generado: ${now}</span>
            <span>Per√≠odo: <strong>${periodLabel}</strong> | Estado: <strong>${condLabel}</strong></span>
        </div>
        <div class="stats">
            <div class="stat-card"><div class="num" style="color:#7c3aed;">${total}</div><div class="lbl">Total Reportes</div></div>
            <div class="stat-card"><div class="num" style="color:#dc2626;">${danado}</div><div class="lbl">Da√±ados</div></div>
            <div class="stat-card"><div class="num" style="color:#ea580c;">${mant}</div><div class="lbl">Mantenimiento</div></div>
            <div class="stat-card"><div class="num" style="color:#16a34a;">${exc}</div><div class="lbl">Excelentes</div></div>
        </div>
        <table>
            <thead><tr><th>Activo</th><th>Reportado por</th><th>Estado</th><th>Motivo</th><th>Fecha</th></tr></thead>
            <tbody>${rows}</tbody>
        </table>
        <div class="footer">
            <span>NEXUS-ID ‚Äî Sistema Integrado de Activos Tecnol√≥gicos</span>
            <span>Documento generado autom√°ticamente. ${now}</span>
        </div>
        </body></html>`);
        win.document.close();
        setTimeout(() => win.print(), 500);
    }
    
    // ===================== DEPARTAMENTOS =====================
    function loadDepts() {
        db.ref('departments').on('value', snap => {
            allDepts = [];
            const container = document.getElementById('depts-table-container');
            if (!container) return;
            
            let html = `
            <table class="w-full text-left text-[11px] font-bold">
                <thead>
                    <tr class="text-slate-500 border-b border-white/10 uppercase text-[9px]">
                        <th class="p-4">Departamento</th>
                        <th class="p-4">Coordinador</th>
                        <th class="p-4">√Årea</th>
                        <th class="p-4">Tel√©fono</th>
                        <th class="p-4">Correo</th>
                        <th class="p-4">Activos</th>
                        <th class="p-4">Acciones</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            snap.forEach(doc => {
                const d = doc.val(); 
                allDepts.push({key: doc.key, ...d});
                
                html += `
                <tr class="border-b border-white/5 table-row-hover">
                    <td class="p-4">
                        <span class="badge-dept text-[10px] px-3 py-1.5 rounded-full font-black">
                            <i class="fas fa-building mr-1"></i>${d.name}
                        </span>
                    </td>
                    <td class="p-4 text-slate-300">
                        ${d.coordinator ? 
                            `<div><i class="fas fa-user-tie mr-1 text-slate-500"></i>${d.coordinator}</div>` : 
                            '<span class="text-slate-600">‚Äî</span>'}
                    </td>
                    <td class="p-4 text-slate-400">
                        ${d.area || d.floor || '<span class="text-slate-600">‚Äî</span>'}
                    </td>
                    <td class="p-4">
                        ${d.phone ? 
                            `<a href="tel:${d.phone}" class="text-cyan-400 hover:text-cyan-300 text-[10px]">
                                <i class="fas fa-phone-alt mr-1"></i>${d.phone}
                            </a>` : 
                            '<span class="text-slate-600">‚Äî</span>'}
                    </td>
                    <td class="p-4">
                        ${d.email ? 
                            `<a href="mailto:${d.email}" class="text-purple-400 hover:text-purple-300 text-[10px]">
                                <i class="fas fa-envelope mr-1"></i>${d.email}
                            </a>` : 
                            '<span class="text-slate-600">‚Äî</span>'}
                    </td>
                    <td class="p-4">
                        <span id="dept-asset-count-${doc.key}" class="text-cyan-400 font-black text-sm">0</span>
                        <span class="text-[8px] text-slate-600 ml-1">activos</span>
                    </td>
                    <td class="p-4">
                        <div class="flex gap-2">
                            <button onclick="editDept('${doc.key}')" class="text-blue-400 hover:text-blue-300 bg-blue-400/10 p-2 rounded-lg transition-all" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteDept('${doc.key}')" class="text-red-500 hover:text-red-400 bg-red-500/10 p-2 rounded-lg transition-all" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            });
            
            container.innerHTML = html + '</tbody></table>';
            document.getElementById('dept-count').textContent = `${allDepts.length} departamento${allDepts.length !== 1 ? 's' : ''}`;
            updateDeptAssetCounts();
            populateDeptSelects();
        });
    }
    
    function updateDeptAssetCounts() {
        db.ref('assets').once('value', snap => {
            const counts = {};
            snap.forEach(doc => {
                const asset = doc.val();
                if (asset.deptKey) {
                    counts[asset.deptKey] = (counts[asset.deptKey] || 0) + 1;
                }
            });
            allDepts.forEach(dept => {
                const el = document.getElementById(`dept-asset-count-${dept.key}`);
                if (el) el.textContent = counts[dept.key] || 0;
            });
        });
    }
    
    document.getElementById('form-dept').onsubmit = (e) => {
        e.preventDefault();
        const id = document.getElementById('dept-edit-id').value;
        const data = {
            name: document.getElementById('dept-name').value,
            coordinator: document.getElementById('dept-coord').value,
            area: document.getElementById('dept-area').value,
            floor: document.getElementById('dept-area').value,
            phone: document.getElementById('dept-phone').value,
            email: document.getElementById('dept-email').value,
            address: document.getElementById('dept-address').value,
            updatedAt: new Date().toISOString()
        };
        
        const operation = id ? 
            db.ref('departments/'+id).update(data) : 
            db.ref('departments').push(data);
        
        operation.then(() => { 
            showToast(id ? "Departamento actualizado" : "Departamento creado");
            e.target.reset(); 
            document.getElementById('dept-edit-id').value='';
        }).catch(error => {
            showToast("Error: " + error.message, "error");
        });
    };
    
    function editDept(id) {
        const d = allDepts.find(x=>x.key===id); 
        if(!d) return;
        document.getElementById('dept-edit-id').value = id;
        document.getElementById('dept-name').value = d.name;
        document.getElementById('dept-coord').value = d.coordinator||'';
        document.getElementById('dept-area').value = d.area || d.floor || '';
        document.getElementById('dept-phone').value = d.phone||'';
        document.getElementById('dept-email').value = d.email||'';
        document.getElementById('dept-address').value = d.address||'';
        showSection('departamentos-asignaciones');
        // Cambiar a la pesta√±a de departamentos
        showDeptAsignTab('departamentos');
    }
    
    function deleteDept(id) {
        showConfirm('Eliminar Departamento', '¬øSeguro que deseas eliminar este departamento?').then(confirmed => {
            if (confirmed) {
                db.ref('departments/'+id).remove().then(() => {
                    showToast('Departamento eliminado');
                });
            }
        });
    }
    
    function populateDeptSelects() {
        ['as-dept','assign-dept','u-dept-assign'].forEach(sid => {
            const sel = document.getElementById(sid);
            if (!sel) return;
            const cur = sel.value;
            sel.innerHTML = '<option value="">Seleccionar Departamento</option>' + 
                allDepts.map(d => `<option value="${d.key}" data-phone="${d.phone||''}" data-email="${d.email||''}">${d.name}</option>`).join('');
            sel.value = cur;
        });
    }
    
    // ===================== ASIGNACIONES - VERSI√ìN MEJORADA CON EL FORMATO SOLICITADO =====================
    function loadAssignments() {
        db.ref('assignments').on('value', snap => {
            allAssignments = [];
            snap.forEach(doc => {
                allAssignments.push({key: doc.key, ...doc.val()});
            });
            // Ordenar por fecha (m√°s reciente primero)
            allAssignments.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            renderAssignmentsTable();
        });
    }
    
    function populateAssignSelects() {
        db.ref('assets').once('value', snap => {
            const sel = document.getElementById('assign-asset');
            let opts = '<option value="">Seleccionar Activo</option>';
            snap.forEach(doc => {
                const a = doc.val();
                opts += `<option value="${doc.key}">${a.name} (${a.serial||'S/N'})</option>`;
            });
            sel.innerHTML = opts;
        });
        db.ref('users').once('value', snap => {
            const sel = document.getElementById('assign-user');
            let opts = '<option value="">Seleccionar Personal</option>';
            snap.forEach(doc => {
                const u = doc.val();
                opts += `<option value="${doc.key}" data-email="${u.email}">${u.name} ‚Äî ${u.cargo||u.role}</option>`;
            });
            sel.innerHTML = opts;
        });
    }
    
    function renderAssignmentsTable() {
        const container = document.getElementById('assignments-table-container');
        const totalEl = document.getElementById('assignments-total');
        
        if (!container) return;
        
        // Limpiar contenedor
        container.innerHTML = '';
        
        const search = (document.getElementById('assign-search')?.value || '').toLowerCase();
        let filtered = allAssignments.filter(a =>
            !search || 
            (a.assetName || '').toLowerCase().includes(search) || 
            (a.userName || '').toLowerCase().includes(search) || 
            (a.deptName || '').toLowerCase().includes(search)
        );
        
        if (filtered.length === 0) { 
            container.innerHTML = '<div class="p-8 text-center"><p class="text-slate-500 text-xs">üì≠ No hay asignaciones registradas</p></div>';
            if (totalEl) totalEl.textContent = '';
            return; 
        }
        
        // Crear tabla con el formato exacto solicitado
        const table = document.createElement('table');
        table.className = 'assignments-table';
        
        // Cabecera
        const thead = document.createElement('thead');
        thead.innerHTML = `
            <tr>
                <th>Activo</th>
                <th>Asignado a</th>
                <th>ID Usuario</th>
                <th>Departamento</th>
                <th>Ubicaci√≥n</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th>Acci√≥n</th>
            </tr>
        `;
        table.appendChild(thead);
        
        // Cuerpo de la tabla
        const tbody = document.createElement('tbody');
        
        filtered.forEach((a, index) => {
            // Determinar clase del badge de estado
            let statusClass = 'badge-status';
            let statusText = a.status || '‚Äî';
            let statusIcon = '';
            
            if (a.status === 'Activo') {
                statusClass += ' activo';
                statusIcon = 'üü¢';
            } else if (a.status === 'Devuelto') {
                statusClass += ' devuelto';
                statusIcon = 'üîµ';
            } else if (a.status === 'En reparaci√≥n') {
                statusClass += ' reparacion';
                statusIcon = 'üü†';
            }
            
            const row = document.createElement('tr');
            row.className = 'table-row-hover';
            row.style.animation = `fadeIn 0.3s ease ${index * 0.05}s both`;
            
            row.innerHTML = `
                <td>
                    <span class="asset-name">${a.assetName || '-'}</span>
                    <div class="user-email">ID: ${a.assetId ? a.assetId.substring(0, 8) + '...' : ''}</div>
                </td>
                <td>
                    <div style="font-weight: 600; color: white;">${a.userName || '-'}</div>
                    <div class="user-email">${a.userEmail || ''}</div>
                </td>
                <td>
                    <span class="user-id-badge">
                        ${(a.userId || '').substring(0, 12)}...
                    </span>
                </td>
                <td>
                    <span class="badge-dept">
                        <i class="fas fa-building mr-1"></i>${a.deptName || '‚Äî'}
                    </span>
                </td>
                <td style="color: #94a3b8;">${a.location || '-'}</td>
                <td>
                    <div style="color: white; font-size: 11px;">${a.date || '-'}</div>
                    ${a.registeredAt ? `<div class="user-email">${new Date(a.registeredAt).toLocaleDateString()}</div>` : ''}
                </td>
                <td>
                    <span class="${statusClass}">
                        ${statusIcon} ${statusText}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button onclick="editAssignment('${a.key}')" class="btn-icon edit" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteAssignment('${a.key}')" class="btn-icon delete" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            
            tbody.appendChild(row);
        });
        
        table.appendChild(tbody);
        container.appendChild(table);
        
        // Actualizar total
        if (totalEl) {
            totalEl.textContent = `Total: ${filtered.length} asignaci√≥n(es)`;
        }
    }
    
    // Funci√≥n para editar asignaci√≥n
    function editAssignment(id) {
        const assignment = allAssignments.find(a => a.key === id);
        if (!assignment) {
            showToast('No se encontr√≥ la asignaci√≥n', 'error');
            return;
        }
        
        // Limpiar formulario
        document.getElementById('form-assign').reset();
        
        // Rellenar con los datos
        document.getElementById('assign-edit-id').value = id;
        document.getElementById('assign-asset').value = assignment.assetId || '';
        document.getElementById('assign-user').value = assignment.userId || '';
        document.getElementById('assign-dept').value = assignment.deptKey || '';
        document.getElementById('assign-location').value = assignment.location || '';
        document.getElementById('assign-date').value = assignment.date || '';
        document.getElementById('assign-status').value = assignment.status || 'Activo';
        document.getElementById('assign-notes').value = assignment.notes || '';
        
        // Cambiar a la pesta√±a de asignaciones y hacer scroll
        showDeptAsignTab('asignaciones');
        setTimeout(() => {
            document.getElementById('form-assign').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    }
    
    // Formulario de asignaci√≥n
    document.getElementById('form-assign').onsubmit = (e) => {
        e.preventDefault();
        
        const editId = document.getElementById('assign-edit-id').value;
        const assetSel = document.getElementById('assign-asset');
        const userSel = document.getElementById('assign-user');
        const deptSel = document.getElementById('assign-dept');
        const assetId = assetSel.value;
        const userId = userSel.value;
        
        if (!assetId || !userId) { 
            showToast("Selecciona activo y personal", "warning");
            return; 
        }
        
        // Obtener nombres
        const assetOption = assetSel.options[assetSel.selectedIndex];
        const assetName = assetOption ? assetOption.text.split('(')[0].trim() : '';
        
        const userOption = userSel.options[userSel.selectedIndex];
        const userName = userOption ? userOption.text.split('‚Äî')[0].trim() : '';
        const userEmail = userOption ? userOption.getAttribute('data-email') || '' : '';
        
        const deptKey = deptSel.value;
        const dept = allDepts.find(d => d.key === deptKey);
        const deptName = dept ? dept.name : '';
        
        const currentUser = auth.currentUser;
        const registeredBy = currentUser ? currentUser.email : 'Sistema';
        
        // Preparar datos
        const data = {
            assetId: assetId,
            assetName: assetName,
            userId: userId,
            userName: userName,
            userEmail: userEmail,
            deptKey: deptKey,
            deptName: deptName,
            location: document.getElementById('assign-location').value,
            date: document.getElementById('assign-date').value || new Date().toLocaleDateString('es-VE'),
            status: document.getElementById('assign-status').value,
            notes: document.getElementById('assign-notes').value,
            lastModifiedBy: registeredBy,
            lastModifiedAt: new Date().toISOString()
        };
        
        if (editId) {
            // Actualizar
            data.updatedAt = new Date().toISOString();
            showLoader('Actualizando asignaci√≥n...');
            
            db.ref('assignments/' + editId).update(data)
                .then(() => {
                    hideLoader();
                    showToast('‚úÖ Asignaci√≥n actualizada correctamente');
                    e.target.reset();
                    document.getElementById('assign-edit-id').value = '';
                })
                .catch(error => {
                    hideLoader();
                    showToast('‚ùå Error: ' + error.message, 'error');
                });
        } else {
            // Crear nueva
            data.createdAt = new Date().toISOString();
            data.registeredAt = new Date().toISOString();
            showLoader('Registrando asignaci√≥n...');
            
            db.ref('assignments').push(data)
                .then(() => {
                    hideLoader();
                    showToast('‚úÖ Asignaci√≥n registrada correctamente');
                    e.target.reset();
                })
                .catch(error => {
                    hideLoader();
                    showToast('‚ùå Error: ' + error.message, 'error');
                });
        }
    };
    
    // Eliminar asignaci√≥n
    function deleteAssignment(id) {
        showConfirm('Eliminar Asignaci√≥n', '¬øEst√°s seguro de eliminar esta asignaci√≥n?')
            .then(confirmed => {
                if (confirmed) {
                    showLoader('Eliminando...');
                    db.ref('assignments/' + id).remove()
                        .then(() => {
                            hideLoader();
                            showToast('‚úÖ Asignaci√≥n eliminada correctamente');
                        })
                        .catch(error => {
                            hideLoader();
                            showToast('‚ùå Error: ' + error.message, 'error');
                        });
                }
            });
    }
    
    // Exportar a Excel
    function exportAssignmentsToExcel() {
        if (allAssignments.length === 0) {
            showToast('No hay datos para exportar', 'warning');
            return;
        }
        
        let csv = "Activo,Asignado a,Email,ID Usuario,Departamento,Ubicaci√≥n,Fecha,Estado,Notas\n";
        allAssignments.forEach(a => {
            csv += `"${a.assetName || ''}","${a.userName || ''}","${a.userEmail || ''}","${a.userId || ''}","${a.deptName || ''}","${a.location || ''}","${a.date || ''}","${a.status || ''}","${(a.notes || '').replace(/"/g, '""')}"\n`;
        });
        
        const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `asignaciones_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
        
        showToast('üì• Exportado correctamente');
    }
    
    // ===================== FUNCI√ìN PARA CAMBIAR ENTRE DEPARTAMENTOS Y ASIGNACIONES =====================
    function showDeptAsignTab(tab) {
        const deptTab = document.getElementById('dept-tab-departamentos');
        const asignTab = document.getElementById('dept-tab-asignaciones');
        const deptContainer = document.getElementById('dept-container');
        const asignContainer = document.getElementById('asignaciones-container');
        
        if (tab === 'departamentos') {
            deptTab.classList.add('active');
            asignTab.classList.remove('active');
            deptContainer.classList.remove('hidden');
            asignContainer.classList.add('hidden');
        } else {
            asignTab.classList.add('active');
            deptTab.classList.remove('active');
            asignContainer.classList.remove('hidden');
            deptContainer.classList.add('hidden');
        }
    }
    
    // ===================== USUARIOS (con permisos visuales) =====================
    function getRolePermissions(role) {
        if (role === 'admin') {
            return [
                { name: 'Panel', allowed: true },
                { name: 'Inventario', allowed: true },
                { name: 'Deptos & Asig', allowed: true },
                { name: 'Reportes', allowed: true },
                { name: 'Usuarios', allowed: true },
                { name: 'Registrados', allowed: true },
                { name: 'Manual', allowed: true }
            ];
        }
        if (role === 'mantenimiento') {
            return [
                { name: 'Panel', allowed: true },
                { name: 'Inventario', allowed: true },
                { name: 'Deptos & Asig', allowed: true },
                { name: 'Reportes', allowed: true },
                { name: 'Usuarios', allowed: false },
                { name: 'Registrados', allowed: false },
                { name: 'Manual', allowed: true }
            ];
        }
        // operario - AHORA PUEDE VER REPORTES
        return [
            { name: 'Panel', allowed: true },
            { name: 'Inventario', allowed: true },
            { name: 'Deptos & Asig', allowed: false },
            { name: 'Reportes', allowed: true },
            { name: 'Usuarios', allowed: false },
            { name: 'Registrados', allowed: false },
            { name: 'Manual', allowed: true }
        ];
    }
    
    function loadAdminUsers() {
        db.ref('users').on('value', snap => {
            const container = document.getElementById('users-table-container');
            const roleLabel = r => {
                if (r === 'admin') return '<span class="role-badge-admin">üõ°Ô∏è Nivel 1 ‚Äî Administrativo</span>';
                if (r === 'mantenimiento') return '<span class="role-badge-mantenimiento">üîß Nivel 2 ‚Äî Mantenimiento</span>';
                return '<span class="role-badge-operario">‚öôÔ∏è Nivel 3 ‚Äî Operario</span>';
            };
            
            let html = `<table class="w-full text-left uppercase text-[11px] font-bold">
                <tr class="text-slate-500 border-b border-white/10">
                    <th class="p-4">Usuario</th>
                    <th class="p-4">C√©dula</th>
                    <th class="p-4">Nivel</th>
                    <th class="p-4">Permisos</th>
                    <th class="p-4">Acci√≥n</th>
                </tr>`;
            
            snap.forEach(doc => {
                const u = doc.val();
                const permissions = getRolePermissions(u.role);
                
                let permisosHtml = '<div class="permissions-grid">';
                permissions.forEach(p => {
                    permisosHtml += `
                        <div class="permission-item ${p.allowed ? 'allowed' : 'denied'}">
                            <i class="fas ${p.allowed ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                            ${p.name}
                        </div>`;
                });
                permisosHtml += '</div>';
                
                html += `<tr class="border-b border-white/5 table-row-hover">
                    <td class="p-4">
                        <div class="font-black text-white">${u.name}</div>
                        <div class="text-[8px] text-slate-500">${u.email}</div>
                        <div class="text-[8px] text-slate-600 mt-1">${u.cargo || '‚Äî'}</div>
                    </td>
                    <td class="p-4 text-slate-400">${u.cedula||'-'}</td>
                    <td class="p-4">${roleLabel(u.role)}</td>
                    <td class="p-4">${permisosHtml}</td>
                    <td class="p-4">
                        ${u.email !== MASTER_EMAIL ? 
                            `<button onclick="deleteUser('${doc.key}')" class="text-red-500 hover:text-red-400">
                                <i class="fas fa-trash-alt"></i>
                            </button>` : 
                            '<span class="text-slate-600">‚Äî</span>'}
                    </td>
                </tr>`;
            });
            container.innerHTML = html + "</table>";
        });
    }
    
    document.getElementById('form-user').onsubmit = (e) => {
        e.preventDefault();
        const deptKey = document.getElementById('u-dept-assign').value;
        const dept = allDepts.find(d=>d.key===deptKey);
        const data = {
            name: document.getElementById('u-name').value,
            cedula: document.getElementById('u-cedula').value,
            email: document.getElementById('u-email').value,
            cargo: document.getElementById('u-cargo').value,
            deptKey: deptKey,
            deptName: dept?.name||'',
            role: document.getElementById('u-role').value,
            registeredAt: new Date().toISOString()
        };
        db.ref('users').push(data).then(() => { 
            showToast("Personal a√±adido al sistema"); 
            e.target.reset(); 
        });
    };
    
    function deleteUser(id) { 
        showConfirm('Eliminar Usuario', '¬øEliminar acceso a este usuario?').then(confirmed => {
            if (confirmed) {
                db.ref('users/' + id).remove().then(() => {
                    showToast('Usuario eliminado');
                });
            }
        });
    }
    
    // ===================== REGISTRADOS =====================
    function loadRegistrados() {
        db.ref('access_requests').on('value', snap => {
            const container = document.getElementById('registrados-container');
            const pendingBadge = document.getElementById('pending-badge');
            const pendingLabel = document.getElementById('pending-count-label');
            let pending = 0, html = '';
            const items = [];
            snap.forEach(doc => items.unshift({key: doc.key, ...doc.val()}));
            items.forEach(r => {
                if (r.status === 'pendiente') pending++;
                const statusBadge = r.status === 'pendiente'
                    ? 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30'
                    : r.status === 'aprobado'
                        ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30'
                        : 'bg-red-500/20 text-red-400 border-red-500/30';
                html += `<div class="glass-card p-5 flex items-center gap-4 border ${r.status==='pendiente'?'border-yellow-500/20':'border-white/5'}">
                    <div class="w-12 h-12 rounded-2xl bg-white/5 flex items-center justify-center font-black text-sm text-cyan-400 border border-white/10 shrink-0">
                        ${(r.name||'?').substring(0,2).toUpperCase()}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-black text-white text-sm">${r.name}</p>
                        <p class="text-[10px] text-slate-400">${r.email} ‚Äî C.I.: ${r.cedula}</p>
                        <p class="text-[9px] text-slate-500">${r.cargo||'Cargo no especificado'} ¬∑ ${r.date}</p>
                    </div>
                    <div class="flex flex-col items-end gap-2 shrink-0">
                        <span class="text-[9px] px-3 py-1 rounded-full font-black uppercase border ${statusBadge}">${r.status}</span>
                        ${r.status === 'pendiente' ? `
                        <div class="flex gap-2">
                            <button onclick="approveRequest('${r.key}','${r.name}','${r.email}')" class="bg-emerald-600 hover:bg-emerald-500 text-white text-[9px] font-black px-3 py-1.5 rounded-lg uppercase transition">
                                <i class="fas fa-check mr-1"></i>Aprobar
                            </button>
                            <button onclick="rejectRequest('${r.key}')" class="bg-red-600/50 hover:bg-red-600 text-white text-[9px] font-black px-3 py-1.5 rounded-lg uppercase transition">
                                <i class="fas fa-times mr-1"></i>Rechazar
                            </button>
                        </div>` : ''}
                    </div>
                </div>`;
            });
            container.innerHTML = html || '<p class="text-slate-500 text-xs text-center py-8">No hay solicitudes de acceso</p>';
            if (pendingBadge) { 
                pendingBadge.classList.toggle('hidden', pending===0); 
                pendingBadge.textContent = pending; 
            }
            if (pendingLabel) pendingLabel.textContent = `${pending} Pendiente${pending!==1?'s':''}`;
        });
        loadAllAuthUsers();
    }
    
    function approveRequest(key, name, email) {
        showConfirm('Aprobar Acceso', `¬øAprobar acceso a ${name}?`).then(confirmed => {
            if (confirmed) {
                db.ref('access_requests/'+key).update({status:'aprobado', approvedAt: new Date().toISOString()})
                .then(() => showToast(`‚úÖ Solicitud de ${name} aprobada`));
            }
        });
    }
    
    function rejectRequest(key) {
        showConfirm('Rechazar Solicitud', '¬øRechazar esta solicitud?').then(confirmed => {
            if (confirmed) {
                db.ref('access_requests/'+key).update({status:'rechazado', rejectedAt: new Date().toISOString()})
                .then(() => showToast('Solicitud rechazada'));
            }
        });
    }
    
    function loadAllAuthUsers() {
        db.ref('users').on('value', snap => {
            const container = document.getElementById('all-auth-users-container');
            if (!container) return;
            const roleBadge = r => {
                if (r === 'admin') return '<span class="role-badge-admin">üõ°Ô∏è Admin</span>';
                if (r === 'mantenimiento') return '<span class="role-badge-mantenimiento">üîß Mant.</span>';
                return '<span class="role-badge-operario">‚öôÔ∏è Operario</span>';
            };
            let html = `<table class="w-full text-left uppercase text-[11px] font-bold">
                <thead><tr class="text-slate-500 border-b border-white/10">
                    <th class="p-4">Nombre</th><th class="p-4">Correo</th><th class="p-4">C.I.</th><th class="p-4">Cargo</th><th class="p-4">Depto</th><th class="p-4">Nivel</th>
                </tr></thead><tbody>`;
            snap.forEach(doc => {
                const u = doc.val();
                const dept = allDepts.find(d => d.key === u.deptKey);
                html += `<tr class="border-b border-white/5 table-row-hover">
                    <td class="p-4 text-white">${u.name}</td>
                    <td class="p-4 text-slate-400 normal-case">${u.email}</td>
                    <td class="p-4 text-slate-400">${u.cedula||'-'}</td>
                    <td class="p-4 text-slate-400 normal-case">${u.cargo||'-'}</td>
                    <td class="p-4"><span class="badge-dept text-[9px] px-2 py-0.5 rounded-full">${dept?.name||'-'}</span></td>
                    <td class="p-4">${roleBadge(u.role)}</td>
                </tr>`;
            });
            container.innerHTML = html + '</tbody></table>';
        });
    }
    
    // ===================== ROLES Y PERMISOS =====================
    function applyRoleUI(role) {
        userRole = role;
        document.querySelectorAll('.admin-only, .mantenimiento-only, .operario-only').forEach(el => {
            el.style.display = 'none';
        });
        
        if (role === 'admin') {
            document.querySelectorAll('.admin-only, .mantenimiento-only').forEach(el => el.style.display = 'flex');
            document.getElementById('user-role-badge').innerHTML = '<span class="role-badge-admin">üõ°Ô∏è Nivel 1 ‚Äî Administrativo (Acceso Total)</span>';
        } else if (role === 'mantenimiento') {
            document.querySelectorAll('.mantenimiento-only').forEach(el => el.style.display = 'flex');
            document.getElementById('user-role-badge').innerHTML = '<span class="role-badge-mantenimiento">üîß Nivel 2 ‚Äî Mantenimiento (Gesti√≥n T√©cnica)</span>';
        } else {
            document.getElementById('user-role-badge').innerHTML = '<span class="role-badge-operario">‚öôÔ∏è Nivel 3 ‚Äî Operario (Solo Consulta + Reportes)</span>';
        }
    }
    
    // ===================== MANUAL DE USUARIO =====================
    const manualContent = {
        intro: `<h2 class="text-2xl font-black text-white uppercase mb-4">üìã Introducci√≥n</h2><p>NEXUS-ID es un sistema de gesti√≥n de activos tecnol√≥gicos para la UPTJAA.</p>`,
        login: `<h2 class="text-2xl font-black text-white uppercase mb-4">üîê Acceso</h2><p>Ingresa con tu correo institucional.</p>`,
        inventario: `<h2 class="text-2xl font-black text-white uppercase mb-4">üì¶ Inventario</h2><p>Gestiona todos los activos tecnol√≥gicos.</p>`,
        asignacion: `<h2 class="text-2xl font-black text-white uppercase mb-4">üîó Asignaciones</h2><p>Asigna activos a personal y departamentos.</p>`,
        reportes: `<h2 class="text-2xl font-black text-white uppercase mb-4">üìä Reportes</h2><p>Visualiza el historial de novedades.</p>`,
        roles: `<h2 class="text-2xl font-black text-white uppercase mb-4">üë• Roles</h2><p>Tres niveles de acceso: Admin (todo), Mantenimiento (gesti√≥n t√©cnica), Operario (solo consulta + reportes).</p>`,
        qr: `<h2 class="text-2xl font-black text-white uppercase mb-4">üì± QR</h2><p>Cada activo tiene su c√≥digo QR √∫nico.</p>`
    };
    
    function showManualTab(tab) {
        document.querySelectorAll('.manual-tab').forEach(t => t.classList.remove('active'));
        const btn = document.getElementById('mtab-'+tab);
        if (btn) btn.classList.add('active');
        const area = document.getElementById('manual-content-area');
        if (area) area.innerHTML = manualContent[tab] || '<p>Contenido no disponible</p>';
    }
    
    // ===================== SCAN VIEW =====================
    function loadScannedAsset(id) {
        db.ref('assets/' + id).on('value', snap => {
            const a = snap.val(); 
            if(!a) return;
            showSection('scan-view');
            document.getElementById('scan-img').src = a.imageUrl;
            document.getElementById('scan-name').textContent = a.name;
            document.getElementById('scan-cond').textContent = a.cond;
            document.getElementById('scan-loc').textContent = a.location;
            if(a.reason) {
                document.getElementById('scan-reason-box').classList.remove('hidden');
                document.getElementById('scan-reason-text').textContent = "NOTA ACTUAL: " + a.reason;
            }
            document.getElementById('btn-send-report').onclick = () => {
                const motivo = document.getElementById('rep-reason').value;
                const newC = document.getElementById('rep-new-cond').value;
                if(!motivo) return showToast("Indique el motivo de la novedad", "warning");
                
                const currentUser = auth.currentUser;
                const userEmail = currentUser ? currentUser.email : 'Sistema';
                
                db.ref('reports').push({ 
                    assetId: id,
                    assetName: a.name, 
                    user: userEmail, 
                    reason: motivo, 
                    newC: newC, 
                    date: new Date().toLocaleString() 
                });
                
                db.ref('assets/' + id).update({ 
                    cond: newC, 
                    reason: motivo,
                    updatedBy: userEmail,
                    updatedAt: new Date().toISOString()
                }).then(() => {
                    showToast("Estado Actualizado con √âxito");
                    document.getElementById('rep-reason').value = '';
                });
            };
        });
    }
    
    // ===================== AUTH STATE =====================
    auth.onAuthStateChanged(user => {
        if (user) {
            db.ref('users/' + user.uid).on('value', snap => {
                let userData = snap.val();
                if (user.email === MASTER_EMAIL && !userData) {
                    userData = { name: "Admin General", role: "admin", email: user.email, cedula: 'N/A', cargo: 'Administrador' };
                    db.ref('users/' + user.uid).set(userData);
                }
                
                const role = userData?.role || "mantenimiento";
                
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('public-scan-screen').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden');
                document.getElementById('display-user').textContent = user.email;
                
                applyRoleUI(role);
                
                if (role === 'admin') {
                    document.getElementById('admin-user-list').classList.remove('hidden');
                    loadAdminUsers();
                    loadRegistrados();
                }
                
                loadDepts();
                
                if (role === 'admin' || role === 'mantenimiento') {
                    loadAssignments();
                    populateAssignSelects();
                }
                
                // Cargar reportes para todos los roles
                loadReports();
                
                if (scannedId) {
                    document.getElementById('main-sidebar').classList.add('hidden');
                    loadScannedAsset(scannedId);
                } else {
                    showSection('dashboard');
                    loadAssets();
                    
                    // Event listeners para b√∫squedas
                    const reportSearch = document.getElementById('report-search');
                    if (reportSearch) {
                        reportSearch.addEventListener('input', () => renderReports());
                    }
                    
                    const assignSearch = document.getElementById('assign-search');
                    if (assignSearch) {
                        assignSearch.addEventListener('input', () => renderAssignmentsTable());
                    }
                    
                    // Inicializar pesta√±a de departamentos
                    showDeptAsignTab('departamentos');
                    
                    setTimeout(() => showManualTab('intro'), 100);
                }
            });
        } else {
            if (!scannedId) {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-interface').classList.add('hidden');
            }
        }
    });
</script>
</body>
</html>
