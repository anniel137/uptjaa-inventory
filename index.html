<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS-ID - Sistema Integrado de Activos Tecnol√≥gicos</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        :root { --bg-dark: #0a0b10; --glass: rgba(255, 255, 255, 0.05); --neon-purple: #bc13fe; --neon-cyan: #00f2ff; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: radial-gradient(circle at top right, #1a1b25, #0a0b10); color: white; min-height: 100vh; margin: 0; }
        .glass-card { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 2rem; }
        .btn-primary { background: linear-gradient(90deg, #bc13fe, #7a12f5); transition: all 0.3s ease; }
        .input-dark { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 1rem; border-radius: 1rem; outline: none; }
        .input-dark:focus { border-color: var(--neon-cyan); }

        /* ESTILOS DE REPORTES */
        .active-filter { background: linear-gradient(90deg, #bc13fe, #7a12f5); color: white; }
        .report-card { animation: fadeInUp 0.3s ease both; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .badge-danado { background: rgba(239,68,68,0.15); color: #f87171; border: 1px solid rgba(239,68,68,0.3); }
        .badge-mantenimiento { background: rgba(249,115,22,0.15); color: #fb923c; border: 1px solid rgba(249,115,22,0.3); }
        .badge-excelente { background: rgba(16,185,129,0.15); color: #34d399; border: 1px solid rgba(16,185,129,0.3); }
        .report-item { transition: transform 0.2s ease; }
        .report-item:hover { transform: translateX(4px); }

        /* ESTILOS DE IMPRESI√ìN AGREGADOS */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                display: flex !important; 
                flex-direction: column;
                justify-content: center; 
                align-items: center; 
                background: white !important;
            }
            .no-print { display: none !important; }
            #qr-gen { border: none !important; }
            #qr-label { color: black !important; font-size: 14pt !important; margin-top: 10px; }
            /* Estilos para reporte membretado impreso */
            #report-print-area, #report-print-area * { visibility: visible !important; }
            #report-print-area {
                position: absolute; left: 0; top: 0; width: 100%;
                background: white !important; color: black !important;
                padding: 30px; font-family: Arial, sans-serif;
            }
        }
        /* Tabs manual */
        .manual-tab { cursor: pointer; transition: all 0.2s; }
        .manual-tab.active { background: linear-gradient(90deg, #bc13fe, #7a12f5); color: white; }
        /* Badge departamento */
        .badge-dept { background: rgba(99,102,241,0.15); color: #818cf8; border: 1px solid rgba(99,102,241,0.3); }
        /* Filtro tiempo activo */
        .time-filter-btn.active-time { background: linear-gradient(90deg, #bc13fe, #7a12f5); color: white; }
        /* Animaci√≥n pulse para usuarios pendientes */
        .pulse-dot { width:8px; height:8px; background:#f59e0b; border-radius:50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(1.3)} }
        /* Estilo de membrete en pantalla */
        .letterhead-header { background: linear-gradient(135deg, #1a1b25, #0d0e17); border-bottom: 3px solid #bc13fe; }
        /* Scroll suave en manual */
        .manual-content { scroll-behavior: smooth; }


        /* ===== TOAST NOTIFICATIONS ===== */
        #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; pointer-events: none; }
        .toast {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.875rem 1.25rem; border-radius: 1rem;
            font-size: 12px; font-weight: 700; font-family: 'Plus Jakarta Sans', sans-serif;
            backdrop-filter: blur(20px); border: 1px solid;
            animation: toastIn 0.3s ease both; pointer-events: all;
            max-width: 360px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        .toast.hiding { animation: toastOut 0.3s ease forwards; }
        .toast-success { background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.4); color: #34d399; }
        .toast-error   { background: rgba(239,68,68,0.15);  border-color: rgba(239,68,68,0.4);  color: #f87171; }
        .toast-warning { background: rgba(245,158,11,0.15); border-color: rgba(245,158,11,0.4); color: #fbbf24; }
        .toast-info    { background: rgba(0,242,255,0.10);  border-color: rgba(0,242,255,0.3);  color: #22d3ee; }
        @keyframes toastIn  { from { opacity:0; transform: translateX(20px); } to { opacity:1; transform: translateX(0); } }
        @keyframes toastOut { from { opacity:1; transform: translateX(0); }   to { opacity:0; transform: translateX(20px); } }
        /* ===== ROLE LEVEL BADGES ===== */
        .role-badge-admin {
            background: linear-gradient(90deg,rgba(188,19,254,0.25),rgba(122,18,245,0.25));
            color: #e879f9; border: 1px solid rgba(188,19,254,0.5);
            padding: 2px 10px; border-radius: 20px; font-size: 9px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .role-badge-operario {
            background: rgba(0,229,255,0.1);
            color: #22d3ee; border: 1px solid rgba(0,229,255,0.3);
            padding: 2px 10px; border-radius: 20px; font-size: 9px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .role-badge-mantenimiento {
            background: rgba(251,146,60,0.12);
            color: #fb923c; border: 1px solid rgba(251,146,60,0.35);
            padding: 2px 10px; border-radius: 20px; font-size: 9px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 1px;
        }
        /* Nav items visibility by role */
        .mantenimiento-only { display: none; }
        .operario-only      { display: none; }
        .admin-only         { display: none; }
        /* Row highlight en tablas */
        .table-row-hover:hover { background: rgba(255,255,255,0.04); transition: background 0.15s; }
    </style>
</head>
<body>

    <!-- VISTA P√öBLICA PARA QR (sin login) -->
    <div id="public-scan-screen" class="hidden fixed inset-0 z-[2500] bg-[#0a0b10] overflow-y-auto p-6">
        <div class="max-w-lg mx-auto pt-6">
            <div class="flex items-center gap-3 mb-6">
                <img src="https://raw.githubusercontent.com/anniel137/uptjaa-inventory/main/gemini-2.5-flash-image_quiero_que_me_crees_el_logo_de_el_polianzoategui_que_sea_algo_mas_futurista-0.jpg" class="w-10 h-10 rounded-full border border-cyan-400 object-cover">
                <div>
                    <h1 class="font-black text-xl italic">NEXUS-ID</h1>
                    <p class="text-[8px] font-bold text-cyan-400 uppercase tracking-widest">Sistema Integrado de Activos Tecnol√≥gicos</p>
                </div>
            </div>
            <div id="public-loading" class="glass-card p-10 text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-cyan-400 mb-4"></i>
                <p class="text-slate-400 font-bold uppercase text-sm">Cargando informaci√≥n del activo...</p>
            </div>
            <div id="public-asset-card" class="hidden glass-card overflow-hidden">
                <img id="pub-img" class="w-full h-56 object-cover" onerror="this.style.display='none'">
                <div class="p-6 space-y-4">
                    <h2 id="pub-name" class="text-3xl font-black uppercase italic text-cyan-400"></h2>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white/5 p-4 rounded-2xl">
                            <p class="text-[9px] text-slate-500 uppercase mb-1">Estado</p>
                            <p id="pub-cond" class="font-black text-sm"></p>
                        </div>
                        <div class="bg-white/5 p-4 rounded-2xl">
                            <p class="text-[9px] text-slate-500 uppercase mb-1">Ubicaci√≥n</p>
                            <p id="pub-loc" class="font-black text-sm"></p>
                        </div>
                        <div class="bg-white/5 p-4 rounded-2xl">
                            <p class="text-[9px] text-slate-500 uppercase mb-1">Serial</p>
                            <p id="pub-serial" class="font-black text-sm"></p>
                        </div>
                    </div>
                    <div id="pub-reason-box" class="hidden bg-orange-500/10 border border-orange-500/30 p-4 rounded-2xl">
                        <p class="text-[9px] text-orange-400 uppercase font-black mb-1">Nota de estado</p>
                        <p id="pub-reason-text" class="text-sm italic text-slate-300"></p>
                    </div>
                    <div class="pt-2 border-t border-white/10 text-center">
                        <p class="text-[9px] text-slate-500 uppercase">Para reportar una novedad, inicie sesi√≥n como operario</p>
                        <button onclick="document.getElementById('public-scan-screen').classList.add('hidden'); document.getElementById('login-screen').classList.remove('hidden');" 
                            class="mt-2 btn-primary px-6 py-2 rounded-xl font-black uppercase text-xs">
                            <i class="fas fa-sign-in-alt mr-1"></i> Iniciar Sesi√≥n
                        </button>
                    </div>
                </div>
            </div>
            <div id="public-not-found" class="hidden glass-card p-10 text-center">
                <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                <p class="font-black uppercase text-sm text-red-400">Activo no encontrado</p>
                <p class="text-xs text-slate-500 mt-2">El c√≥digo QR puede estar desactualizado o el activo fue eliminado.</p>
            </div>
        </div>
    </div>

    <div id="login-screen" class="fixed inset-0 z-[2000] bg-[#0a0b10] flex items-center justify-center p-6">
        <div class="glass-card p-10 w-full max-w-md text-center">
            <img src="https://raw.githubusercontent.com/anniel137/uptjaa-inventory/main/gemini-2.5-flash-image_quiero_que_me_crees_el_logo_de_el_polianzoategui_que_sea_algo_mas_futurista-0.jpg" class="w-24 h-24 mx-auto mb-6 rounded-full border-2 border-cyan-400 object-cover">
            <h2 class="text-4xl font-black italic mb-1">NEXUS-ID</h2>
            <p class="text-[9px] text-cyan-400 font-bold mb-8 uppercase tracking-widest">Sistema Integrado de Activos Tecnol√≥gicos</p>
            <form id="login-form" class="space-y-4">
                <input type="email" id="user-input" placeholder="Correo Institucional" class="w-full input-dark" required>
                <input type="password" id="pass-input" placeholder="Contrase√±a" class="w-full input-dark" required>
                <button type="submit" class="w-full btn-primary p-4 rounded-2xl font-black uppercase text-sm shadow-lg hover:scale-105 transition">Entrar al Sistema</button>
            </form>
            <div class="mt-6 border-t border-white/10 pt-6 text-center">
                <p class="text-[10px] text-slate-500 mb-3 uppercase font-bold">¬øEres personal de la instituci√≥n y no tienes acceso?</p>
                <button onclick="toggleRegRequest()" class="text-xs text-cyan-400 font-black uppercase hover:text-cyan-300 transition">
                    <i class="fas fa-user-plus mr-1"></i> Solicitar Acceso
                </button>
            </div>
            <!-- Formulario de solicitud de registro -->
            <div id="reg-request-form" class="hidden mt-4 space-y-3">
                <input type="text" id="reg-name" placeholder="Nombre Completo" class="w-full input-dark">
                <input type="text" id="reg-cedula" placeholder="C√©dula de Identidad" class="w-full input-dark">
                <input type="email" id="reg-email" placeholder="Correo Institucional" class="w-full input-dark">
                <input type="text" id="reg-cargo" placeholder="Cargo / Departamento" class="w-full input-dark">
                <button onclick="submitRegRequest()" class="w-full bg-cyan-600 hover:bg-cyan-500 p-3 rounded-2xl font-black uppercase text-sm transition">
                    <i class="fas fa-paper-plane mr-1"></i> Enviar Solicitud
                </button>
                <p class="text-[9px] text-slate-600 text-center">Tu solicitud ser√° revisada por un administrador. La informaci√≥n solo ser√° usada para verificar que eres personal activo.</p>
            </div>
        </div>
    </div>

    <div id="app-interface" class="hidden flex h-screen w-full">
        <aside id="main-sidebar" class="w-72 bg-black/40 backdrop-blur-xl border-r border-white/10 flex flex-col p-6 shrink-0">
            <div class="mb-12">
                <h1 class="font-black text-3xl italic">NEXUS-ID</h1>
                <p class="text-[8px] font-bold text-purple-500 uppercase mt-1">Sistema Integrado de Activos Tecnol√≥gicos</p>
            </div>
            <nav class="flex-1 space-y-3">
                <!-- Todos ven: Panel, Inventario, Manual -->
                <button id="nav-dashboard" onclick="showSection('dashboard')" class="w-full flex items-center p-4 rounded-2xl font-bold text-slate-400 hover:text-cyan-400 transition-all">
                    <i class="fas fa-chart-line w-8"></i> Panel
                </button>
                <button id="nav-inventario" onclick="showSection('inventario')" class="w-full flex items-center p-4 rounded-2xl font-bold text-slate-400 hover:text-cyan-400 transition-all">
                    <i class="fas fa-box-open w-8"></i> Inventario
                </button>
                <!-- Nivel 2 (mantenimiento) y Nivel 1 (admin) -->
                <button id="nav-asignaciones" onclick="showSection('asignaciones')" class="w-full flex items-center p-4 rounded-2xl font-bold text-slate-400 hover:text-cyan-400 transition-all mantenimiento-only admin-only">
                    <i class="fas fa-link w-8"></i> Asignaciones
                </button>
                <button id="nav-reportes" onclick="showSection('reportes')" class="w-full flex items-center p-4 rounded-2xl font-bold text-slate-400 hover:text-cyan-400 transition-all mantenimiento-only admin-only">
                    <i class="fas fa-bell w-8"></i> Reportes
                </button>
                <button id="nav-departamentos" onclick="showSection('departamentos')" class="w-full flex items-center p-4 rounded-2xl font-bold text-slate-400 hover:text-cyan-400 transition-all mantenimiento-only admin-only">
                    <i class="fas fa-sitemap w-8"></i> Departamentos
                </button>
                <!-- Solo Nivel 1 (admin) -->
                <button id="nav-usuarios" onclick="showSection('usuarios')" class="w-full flex items-center p-4 rounded-2xl font-bold text-slate-400 hover:text-cyan-400 transition-all admin-only">
                    <i class="fas fa-users-cog w-8"></i> Usuarios
                </button>
                <button id="nav-registrados" onclick="showSection('registrados')" class="w-full flex items-center p-4 rounded-2xl font-bold text-slate-400 hover:text-cyan-400 transition-all admin-only">
                    <i class="fas fa-user-check w-8"></i> Registrados
                    <span id="pending-badge" class="hidden ml-auto bg-yellow-500 text-black text-[8px] font-black px-2 py-0.5 rounded-full">!</span>
                </button>
                <!-- Todos ven el manual -->
                <button id="nav-manual" onclick="showSection('manual')" class="w-full flex items-center p-4 rounded-2xl font-bold text-slate-400 hover:text-cyan-400 transition-all">
                    <i class="fas fa-book w-8"></i> Manual
                </button>
                <!-- Indicador visual de nivel -->
                <div id="role-level-indicator" class="mt-4 p-3 rounded-2xl border border-white/10 text-center hidden">
                    <p class="text-[8px] text-slate-500 uppercase font-black mb-1">Nivel de Acceso</p>
                    <div id="role-level-bar" class="flex gap-1 justify-center mt-1">
                        <div id="lvl-dot-3" class="w-3 h-3 rounded-full bg-cyan-500/30 border border-cyan-500/50" title="Operario"></div>
                        <div id="lvl-dot-2" class="w-3 h-3 rounded-full bg-orange-500/30 border border-orange-500/50" title="Mantenimiento"></div>
                        <div id="lvl-dot-1" class="w-3 h-3 rounded-full bg-purple-500/30 border border-purple-500/50" title="Administrativo"></div>
                    </div>
                </div>
            </nav>
            <div class="p-4 glass-card rounded-2xl text-center">
                <p id="user-role-badge" class="text-[8px] font-black text-cyan-400 uppercase mb-1"></p>
                <p id="display-user" class="text-[10px] text-white truncate"></p>
                <button onclick="logout()" class="text-[9px] text-red-500 font-black mt-2 uppercase">Salir</button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto">
            <header class="p-8">
                <h2 id="section-title" class="text-3xl font-black uppercase italic text-white">Dashboard</h2>
            </header>

            <div id="content-area" class="p-8">
                
                <section id="sec-dashboard" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="glass-card p-8 border-l-4 border-purple-500"><h4>Total Activos</h4><p id="dash-total" class="text-4xl font-black">0</p></div>
                    <div class="glass-card p-8 border-l-4 border-emerald-500"><h4>Excelente</h4><p id="dash-excelente" class="text-4xl font-black">0</p></div>
                    <div class="glass-card p-8 border-l-4 border-orange-500"><h4>Mantenimiento</h4><p id="dash-mantenimiento" class="text-4xl font-black">0</p></div>
                    <div class="glass-card p-8 border-l-4 border-red-500"><h4>Da√±ado</h4><p id="dash-danado" class="text-4xl font-black">0</p></div>
                </section>

                <section id="sec-inventario" class="hidden space-y-8">
                    <div class="glass-card p-8">
                        <h3 id="asset-form-title" class="text-xl font-black mb-6 uppercase">Gesti√≥n de Activo</h3>
                        <form id="form-asset" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="edit-id">
                            <input type="text" id="as-name" placeholder="Nombre del Activo" class="input-dark" required>
                            <input type="text" id="as-serial" placeholder="Serial / N√∫mero de Inventario" class="input-dark" required>
                            <input type="text" id="as-model" placeholder="Modelo" class="input-dark">
                            <input type="text" id="as-loc" placeholder="Ubicaci√≥n F√≠sica" class="input-dark" required>
                            <select id="as-type" class="input-dark bg-slate-800">
                                <option value="">Tipo de Activo</option>
                                <option value="Computadora">Computadora</option>
                                <option value="Laptop">Laptop</option>
                                <option value="Monitor">Monitor</option>
                                <option value="Impresora">Impresora</option>
                                <option value="Servidor">Servidor</option>
                                <option value="Proyector">Proyector</option>
                                <option value="Tel√©fono IP">Tel√©fono IP</option>
                                <option value="Switch/Router">Switch/Router</option>
                                <option value="Otro">Otro</option>
                            </select>
                            <select id="as-dept" class="input-dark bg-slate-800">
                                <option value="">Departamento (opcional)</option>
                            </select>
                            <!-- CARGA DE IMAGEN -->
                            <div class="col-span-full">
                                <label class="block text-[10px] text-slate-400 uppercase font-black mb-2 tracking-wider">
                                    <i class="fas fa-image mr-1"></i> Imagen del Activo
                                </label>
                                <!-- Zona de subida de archivo -->
                                <div id="img-upload-zone" onclick="document.getElementById('as-photo-file').click()"
                                    class="relative w-full h-36 rounded-2xl border-2 border-dashed border-white/20 hover:border-cyan-400/50 cursor-pointer transition-all flex flex-col items-center justify-center gap-2 bg-white/5 hover:bg-white/8 overflow-hidden mb-3">
                                    <img id="img-preview" class="hidden absolute inset-0 w-full h-full object-cover rounded-2xl opacity-80">
                                    <div id="img-placeholder" class="flex flex-col items-center gap-2 pointer-events-none">
                                        <i class="fas fa-cloud-upload-alt text-3xl text-slate-500"></i>
                                        <p class="text-xs text-slate-400 font-bold">Haz clic para subir imagen</p>
                                        <p class="text-[9px] text-slate-600">JPG, PNG, WEBP ‚Äî m√°x. 2 MB</p>
                                    </div>
                                    <div id="img-change-overlay" class="hidden absolute inset-0 bg-black/50 items-center justify-center rounded-2xl">
                                        <p class="text-white text-xs font-black uppercase"><i class="fas fa-pencil-alt mr-1"></i>Cambiar imagen</p>
                                    </div>
                                </div>
                                <input type="file" id="as-photo-file" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                                <p id="img-upload-error" class="hidden text-[10px] text-red-400 mb-2 font-bold"></p>
                                <!-- Separador -->
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="flex-1 h-px bg-white/10"></div>
                                    <span class="text-[9px] text-slate-500 uppercase font-black">O ingresa una URL</span>
                                    <div class="flex-1 h-px bg-white/10"></div>
                                </div>
                                <!-- Campo URL original -->
                                <input type="url" id="as-photo" placeholder="https://... (URL de imagen)" class="input-dark w-full" oninput="handleUrlInput(this.value)">
                            </div>
                            <input type="date" id="as-purchase" placeholder="Fecha de Adquisici√≥n" class="input-dark">
                            <select id="as-cond" class="input-dark bg-slate-800">
                                <option value="Excelente">Excelente</option>
                                <option value="Mantenimiento">Mantenimiento</option>
                                <option value="Da√±ado">Da√±ado</option>
                            </select>
                            <textarea id="as-reason" placeholder="Detalle del estado del activo..." class="input-dark h-24 col-span-full"></textarea>
                            <button type="submit" class="col-span-full btn-primary p-4 rounded-xl font-black uppercase">Sincronizar Activo</button>
                        </form>
                    </div>
                    <div id="assets-container" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
                </section>

                <section id="sec-usuarios" class="hidden space-y-8">
                    <div class="glass-card p-8">
                        <h3 class="text-xl font-black mb-6 uppercase">Registrar Nuevo Personal</h3>
                        <form id="form-user" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" id="u-name" placeholder="Nombre Completo" class="input-dark" required>
                            <input type="text" id="u-cedula" placeholder="C√©dula / ID Empleado" class="input-dark" required>
                            <input type="email" id="u-email" placeholder="Correo Institucional" class="input-dark" required>
                            <input type="text" id="u-cargo" placeholder="Cargo / Puesto" class="input-dark">
                            <select id="u-dept-assign" class="input-dark bg-slate-800">
                                <option value="">Departamento</option>
                            </select>
                            <select id="u-role" class="input-dark bg-slate-800">
                                <option value="operario">‚öôÔ∏è Nivel 3 ‚Äî Personal Operario</option>
                                <option value="mantenimiento">üîß Nivel 2 ‚Äî Personal de Mantenimiento</option>
                                <option value="admin">üõ°Ô∏è Nivel 1 ‚Äî Personal Administrativo</option>
                            </select>
                            <!-- Contrase√±a -->
                            <div class="col-span-full">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="relative">
                                        <input type="password" id="u-password" placeholder="Contrase√±a de acceso" class="input-dark w-full pr-12" required minlength="6">
                                        <button type="button" onclick="togglePassVis('u-password','eye-1')" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-cyan-400 transition">
                                            <i id="eye-1" class="fas fa-eye text-sm"></i>
                                        </button>
                                    </div>
                                    <div class="relative">
                                        <input type="password" id="u-password-confirm" placeholder="Confirmar contrase√±a" class="input-dark w-full pr-12" required minlength="6">
                                        <button type="button" onclick="togglePassVis('u-password-confirm','eye-2')" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-cyan-400 transition">
                                            <i id="eye-2" class="fas fa-eye text-sm"></i>
                                        </button>
                                    </div>
                                </div>
                                <p class="text-[9px] text-slate-500 mt-2"><i class="fas fa-info-circle mr-1"></i>M√≠nimo 6 caracteres. El usuario usar√° este correo y contrase√±a para iniciar sesi√≥n.</p>
                            </div>
                            <p id="form-user-error" class="hidden col-span-full text-[11px] text-red-400 font-bold bg-red-500/10 border border-red-500/20 rounded-xl px-4 py-2"></p>
                            <button type="submit" id="btn-add-user" class="col-span-full btn-primary p-4 rounded-xl font-black uppercase">
                                <i class="fas fa-user-plus mr-2"></i>A√±adir al Sistema
                            </button>
                        </form>
                    </div>
                    <div id="admin-user-list" class="hidden glass-card p-8">
                        <h3 class="text-xl font-black mb-6 uppercase">Panel Administrativo de Usuarios</h3>
                        <div id="users-table-container" class="overflow-x-auto text-sm"></div>
                    </div>
                </section>

                <section id="sec-reportes" class="hidden space-y-6">

                    <!-- Stats Bar -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="glass-card p-5 flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center shrink-0"><i class="fas fa-clipboard-list text-purple-400"></i></div>
                            <div><p class="text-[9px] text-slate-500 uppercase font-bold">Total Reportes</p><p id="stat-total" class="text-2xl font-black text-white">0</p></div>
                        </div>
                        <div class="glass-card p-5 flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-red-500/20 flex items-center justify-center shrink-0"><i class="fas fa-times-circle text-red-400"></i></div>
                            <div><p class="text-[9px] text-slate-500 uppercase font-bold">Da√±ado</p><p id="stat-danado" class="text-2xl font-black text-red-400">0</p></div>
                        </div>
                        <div class="glass-card p-5 flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-orange-500/20 flex items-center justify-center shrink-0"><i class="fas fa-tools text-orange-400"></i></div>
                            <div><p class="text-[9px] text-slate-500 uppercase font-bold">Mantenimiento</p><p id="stat-mantenimiento" class="text-2xl font-black text-orange-400">0</p></div>
                        </div>
                        <div class="glass-card p-5 flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-emerald-500/20 flex items-center justify-center shrink-0"><i class="fas fa-check-circle text-emerald-400"></i></div>
                            <div><p class="text-[9px] text-slate-500 uppercase font-bold">Excelente</p><p id="stat-excelente" class="text-2xl font-black text-emerald-400">0</p></div>
                        </div>
                    </div>

                    <!-- View toggle + global controls -->
                    <div class="glass-card p-4 flex flex-col md:flex-row gap-3 items-center justify-between">
                        <!-- View tabs -->
                        <div class="flex gap-2">
                            <button onclick="setReportView('assets')" id="view-btn-assets"
                                class="report-view-btn px-4 py-2 rounded-xl text-xs font-black uppercase transition-all bg-gradient-to-r from-purple-600 to-violet-600 text-white">
                                <i class="fas fa-box-open mr-1.5"></i>Por Activo
                            </button>
                            <button onclick="setReportView('history')" id="view-btn-history"
                                class="report-view-btn px-4 py-2 rounded-xl text-xs font-black uppercase transition-all bg-white/5 text-slate-400 hover:text-white">
                                <i class="fas fa-history mr-1.5"></i>Historial General
                            </button>
                        </div>
                        <button onclick="printReport()" class="bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all flex items-center gap-2 shrink-0">
                            <i class="fas fa-print"></i> Imprimir Reporte
                        </button>
                    </div>

                    <!-- ====== VISTA: POR ACTIVO ====== -->
                    <div id="view-assets-panel">
                        <div class="relative mb-4">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
                            <input id="asset-report-search" type="text" placeholder="Buscar activo por nombre o serial..."
                                class="w-full input-dark pl-10 py-3 text-sm" oninput="renderAssetReportCards()">
                        </div>
                        <div id="asset-report-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
                        <div id="asset-report-empty" class="hidden glass-card p-16 text-center">
                            <i class="fas fa-inbox text-4xl text-slate-700 mb-4"></i>
                            <p class="font-black text-slate-500 uppercase text-sm">Sin activos con reportes</p>
                        </div>
                    </div>

                    <!-- ====== VISTA: HISTORIAL GENERAL ====== -->
                    <div id="view-history-panel" class="hidden space-y-4">
                        <div class="glass-card p-5 flex flex-col md:flex-row gap-4 items-center">
                            <div class="relative flex-1 w-full">
                                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
                                <input id="report-search" type="text" placeholder="Buscar por activo, usuario o motivo..."
                                    class="w-full input-dark pl-10 py-3 text-sm" oninput="filterReports()">
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="setReportFilter('todos')" id="filter-todos" class="report-filter-btn active-filter px-4 py-2 rounded-xl text-xs font-black uppercase transition-all">Todos</button>
                                <button onclick="setReportFilter('Da√±ado')" id="filter-danado" class="report-filter-btn px-4 py-2 rounded-xl text-xs font-black uppercase transition-all bg-white/5 text-slate-400 hover:text-red-400">Da√±ado</button>
                                <button onclick="setReportFilter('Mantenimiento')" id="filter-mantenimiento" class="report-filter-btn px-4 py-2 rounded-xl text-xs font-black uppercase transition-all bg-white/5 text-slate-400 hover:text-orange-400">Mantenimiento</button>
                                <button onclick="setReportFilter('Excelente')" id="filter-excelente" class="report-filter-btn px-4 py-2 rounded-xl text-xs font-black uppercase transition-all bg-white/5 text-slate-400 hover:text-emerald-400">Excelente</button>
                            </div>
                        </div>
                        <div class="glass-card p-4 flex gap-3 items-center flex-wrap">
                            <span class="text-[9px] text-slate-500 uppercase font-black"><i class="fas fa-calendar-alt mr-1"></i>Per√≠odo:</span>
                            <button onclick="setTimeFilter('all')" id="tfilter-all" class="time-filter-btn active-time px-3 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all">Todo</button>
                            <button onclick="setTimeFilter('day')" id="tfilter-day" class="time-filter-btn px-3 py-1.5 rounded-lg text-[10px] font-black uppercase bg-white/5 text-slate-400 transition-all">Hoy</button>
                            <button onclick="setTimeFilter('week')" id="tfilter-week" class="time-filter-btn px-3 py-1.5 rounded-lg text-[10px] font-black uppercase bg-white/5 text-slate-400 transition-all">Esta Semana</button>
                            <button onclick="setTimeFilter('month')" id="tfilter-month" class="time-filter-btn px-3 py-1.5 rounded-lg text-[10px] font-black uppercase bg-white/5 text-slate-400 transition-all">Este Mes</button>
                        </div>
                        <div class="flex items-center justify-between px-1">
                            <h3 class="text-sm font-black uppercase text-slate-400 tracking-widest"><i class="fas fa-history mr-2"></i>Historial de Actividad</h3>
                            <span id="report-count-label" class="text-[9px] text-slate-600 font-bold uppercase"></span>
                        </div>
                        <div id="reports-empty" class="hidden glass-card p-16 text-center">
                            <i class="fas fa-inbox text-4xl text-slate-700 mb-4"></i>
                            <p class="font-black text-slate-500 uppercase text-sm">Sin reportes encontrados</p>
                            <p class="text-xs text-slate-600 mt-1">Intenta con otros filtros o t√©rminos de b√∫squeda</p>
                        </div>
                        <div id="reports-list-container" class="space-y-3"></div>
                    </div>

                    <!-- Modal: reportes de un activo -->
                    <div id="asset-report-modal" class="hidden fixed inset-0 z-[4000] bg-black/85 backdrop-blur-sm flex items-center justify-center p-4">
                        <div class="glass-card w-full max-w-xl max-h-[88vh] flex flex-col overflow-hidden">
                            <!-- Header fijo -->
                            <div class="p-6 border-b border-white/10 flex items-center gap-4 shrink-0">
                                <img id="arm-img" class="w-14 h-14 rounded-2xl object-cover border border-white/10 shrink-0" onerror="this.style.display='none'">
                                <div class="flex-1 min-w-0">
                                    <h3 id="arm-name" class="text-lg font-black uppercase text-cyan-400 truncate"></h3>
                                    <p id="arm-serial" class="text-[9px] text-slate-500"></p>
                                    <div id="arm-stats" class="flex gap-2 mt-1 flex-wrap"></div>
                                </div>
                                <button onclick="closeAssetReportModal()" class="text-slate-500 hover:text-white text-xl transition shrink-0"><i class="fas fa-times"></i></button>
                            </div>
                            <!-- Lista scrollable -->
                            <div id="arm-list" class="overflow-y-auto p-5 space-y-3 flex-1"></div>
                        </div>
                    </div>

                </section>

                <!-- ===================== SECCI√ìN: DEPARTAMENTOS ===================== -->
                <section id="sec-departamentos" class="hidden space-y-8">
                    <div class="glass-card p-8">
                        <h3 id="dept-form-title" class="text-xl font-black mb-6 uppercase">Registrar Departamento</h3>
                        <form id="form-dept" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="hidden" id="dept-edit-id">
                            <input type="text" id="dept-name" placeholder="Nombre del Departamento" class="input-dark col-span-full md:col-span-2" required>
                            <input type="text" id="dept-coord" placeholder="Coordinador / Jefe" class="input-dark">
                            <input type="text" id="dept-floor" placeholder="Piso / √Årea / Edificio" class="input-dark">
                            <input type="text" id="dept-phone" placeholder="Tel√©fono / Extensi√≥n" class="input-dark">
                            <input type="email" id="dept-email" placeholder="Correo del coordinador" class="input-dark col-span-full md:col-span-2">
                            <textarea id="dept-desc" placeholder="Descripci√≥n o funciones del departamento..." class="input-dark h-20 col-span-full"></textarea>
                            <div class="col-span-full flex gap-3">
                                <button type="submit" id="btn-dept-submit" class="flex-1 btn-primary p-4 rounded-xl font-black uppercase"><i class="fas fa-save mr-2"></i>Guardar Departamento</button>
                                <button type="button" id="btn-dept-cancel" onclick="cancelDeptEdit()" class="hidden px-6 bg-white/5 hover:bg-white/10 p-4 rounded-xl font-black uppercase text-sm text-slate-400 transition"><i class="fas fa-times mr-1"></i>Cancelar</button>
                            </div>
                        </form>
                    </div>

                    <!-- Stats cards -->
                    <div id="dept-stats-row" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="glass-card p-5 flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center shrink-0"><i class="fas fa-sitemap text-purple-400"></i></div>
                            <div><p class="text-[9px] text-slate-500 uppercase font-bold">Departamentos</p><p id="stat-dept-total" class="text-2xl font-black">0</p></div>
                        </div>
                        <div class="glass-card p-5 flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-cyan-500/20 flex items-center justify-center shrink-0"><i class="fas fa-box-open text-cyan-400"></i></div>
                            <div><p class="text-[9px] text-slate-500 uppercase font-bold">Activos Totales</p><p id="stat-dept-assets" class="text-2xl font-black text-cyan-400">0</p></div>
                        </div>
                        <div class="glass-card p-5 flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-indigo-500/20 flex items-center justify-center shrink-0"><i class="fas fa-users text-indigo-400"></i></div>
                            <div><p class="text-[9px] text-slate-500 uppercase font-bold">Personal</p><p id="stat-dept-users" class="text-2xl font-black text-indigo-400">0</p></div>
                        </div>
                        <div class="glass-card p-5 flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-emerald-500/20 flex items-center justify-center shrink-0"><i class="fas fa-link text-emerald-400"></i></div>
                            <div><p class="text-[9px] text-slate-500 uppercase font-bold">Asignaciones</p><p id="stat-dept-assignments" class="text-2xl font-black text-emerald-400">0</p></div>
                        </div>
                    </div>

                    <div class="glass-card p-8">
                        <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
                            <h3 class="text-xl font-black uppercase">Tabla de Departamentos</h3>
                            <input id="dept-search" type="text" placeholder="Buscar departamento..." class="input-dark py-2 text-xs w-52" oninput="renderDepts()">
                        </div>
                        <div id="depts-table-container" class="overflow-x-auto text-sm"></div>
                    </div>

                    <!-- Modal detalle de departamento -->
                    <div id="dept-detail-modal" class="hidden fixed inset-0 z-[4000] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                        <div class="glass-card w-full max-w-2xl max-h-[85vh] overflow-y-auto p-8">
                            <div class="flex items-center justify-between mb-6">
                                <h3 id="modal-dept-name" class="text-2xl font-black uppercase text-cyan-400"></h3>
                                <button onclick="closeDeptModal()" class="text-slate-500 hover:text-white text-xl transition"><i class="fas fa-times"></i></button>
                            </div>
                            <div id="modal-dept-body" class="space-y-5"></div>
                        </div>
                    </div>
                </section>

                <!-- ===================== SECCI√ìN: ASIGNACIONES ===================== -->
                <section id="sec-asignaciones" class="hidden space-y-8">
                    <div class="glass-card p-8">
                        <h3 class="text-xl font-black mb-2 uppercase">Tabla de Asignaci√≥n de Activos</h3>
                        <p class="text-xs text-slate-500 mb-6">Asigna activos tecnol√≥gicos a usuarios registrados y departamentos. El ID del usuario queda grabado en la base de datos.</p>
                        <form id="form-assign" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="assign-edit-id">
                            <select id="assign-asset" class="input-dark bg-slate-800" required>
                                <option value="">Seleccionar Activo</option>
                            </select>
                            <select id="assign-user" class="input-dark bg-slate-800" required>
                                <option value="">Seleccionar Personal</option>
                            </select>
                            <select id="assign-dept" class="input-dark bg-slate-800">
                                <option value="">Departamento</option>
                            </select>
                            <input type="text" id="assign-location" placeholder="Ubicaci√≥n espec√≠fica" class="input-dark">
                            <input type="date" id="assign-date" class="input-dark" title="Fecha de asignaci√≥n">
                            <select id="assign-status" class="input-dark bg-slate-800">
                                <option value="Activo">Activo (en uso)</option>
                                <option value="Devuelto">Devuelto</option>
                                <option value="En reparaci√≥n">En reparaci√≥n</option>
                            </select>
                            <textarea id="assign-notes" placeholder="Notas de la asignaci√≥n..." class="input-dark h-20 col-span-full"></textarea>
                            <button type="submit" class="col-span-full btn-primary p-4 rounded-xl font-black uppercase"><i class="fas fa-link mr-2"></i>Registrar Asignaci√≥n</button>
                        </form>
                    </div>
                    <div class="glass-card p-8">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-black uppercase">Registro de Asignaciones</h3>
                            <input id="assign-search" type="text" placeholder="Buscar..." class="input-dark py-2 text-xs w-48" oninput="renderAssignments()">
                        </div>
                        <div id="assignments-table-container" class="overflow-x-auto text-sm"></div>
                    </div>
                </section>

                <!-- ===================== SECCI√ìN: USUARIOS REGISTRADOS ===================== -->
                <section id="sec-registrados" class="hidden space-y-6">
                    <div class="glass-card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-xl font-black uppercase">Solicitudes de Acceso al Sistema</h3>
                                <p class="text-xs text-slate-500 mt-1">Usuarios que se registraron en la app. Valida si pertenecen al personal antes de aprobar.</p>
                            </div>
                            <span id="pending-count-label" class="bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 text-[10px] font-black px-3 py-1 rounded-full uppercase">0 Pendientes</span>
                        </div>
                        <div id="registrados-container" class="space-y-3"></div>
                    </div>
                    <div class="glass-card p-6">
                        <h3 class="text-xl font-black uppercase mb-4">Todos los Usuarios del Sistema</h3>
                        <div id="all-auth-users-container" class="overflow-x-auto text-sm"></div>
                    </div>
                </section>

                <!-- ===================== SECCI√ìN: MANUAL DE USUARIO ===================== -->
                <section id="sec-manual" class="hidden space-y-6 max-w-4xl mx-auto">
                    <!-- Header membretado del manual -->
                    <div class="letterhead-header glass-card p-8 flex items-center gap-6">
                        <img src="https://raw.githubusercontent.com/anniel137/uptjaa-inventory/main/gemini-2.5-flash-image_quiero_que_me_crees_el_logo_de_el_polianzoategui_que_sea_algo_mas_futurista-0.jpg" class="w-20 h-20 rounded-full border-2 border-purple-500 object-cover shrink-0">
                        <div>
                            <h1 class="font-black text-3xl italic text-white">NEXUS-ID</h1>
                            <p class="text-[9px] font-bold text-cyan-400 uppercase tracking-widest">Sistema Integrado de Activos Tecnol√≥gicos</p>
                            <p class="text-xs text-slate-400 mt-1">Universidad Polit√©cnica Territorial Jos√© Antonio Anzo√°tegui</p>
                            <p class="text-[10px] text-slate-500 mt-0.5 font-black uppercase">Manual de Usuario ‚Äî v2.0</p>
                        </div>
                    </div>
                    <!-- Tabs del manual -->
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="showManualTab('intro')" id="mtab-intro" class="manual-tab active px-4 py-2 rounded-xl text-xs font-black uppercase bg-white/5 text-slate-400">Introducci√≥n</button>
                        <button onclick="showManualTab('login')" id="mtab-login" class="manual-tab px-4 py-2 rounded-xl text-xs font-black uppercase bg-white/5 text-slate-400">Acceso</button>
                        <button onclick="showManualTab('inventario')" id="mtab-inventario" class="manual-tab px-4 py-2 rounded-xl text-xs font-black uppercase bg-white/5 text-slate-400">Inventario</button>
                        <button onclick="showManualTab('asignacion')" id="mtab-asignacion" class="manual-tab px-4 py-2 rounded-xl text-xs font-black uppercase bg-white/5 text-slate-400">Asignaciones</button>
                        <button onclick="showManualTab('reportes')" id="mtab-reportes" class="manual-tab px-4 py-2 rounded-xl text-xs font-black uppercase bg-white/5 text-slate-400">Reportes</button>
                        <button onclick="showManualTab('roles')" id="mtab-roles" class="manual-tab px-4 py-2 rounded-xl text-xs font-black uppercase bg-white/5 text-slate-400">Roles</button>
                        <button onclick="showManualTab('qr')" id="mtab-qr" class="manual-tab px-4 py-2 rounded-xl text-xs font-black uppercase bg-white/5 text-slate-400">C√≥digo QR</button>
                    </div>
                    <!-- Contenido din√°mico del manual -->
                    <div id="manual-content-area" class="manual-content glass-card p-8 space-y-6 text-sm leading-relaxed text-slate-300"></div>
                </section>

                <section id="sec-scan-view" class="hidden max-w-2xl mx-auto">
                    <div class="glass-card overflow-hidden">
                        <img id="scan-img" class="w-full h-72 object-cover" onerror="this.style.display='none'">
                        <div class="p-8 space-y-6">
                            <h2 id="scan-name" class="text-4xl font-black uppercase italic text-cyan-400"></h2>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-white/5 p-4 rounded-2xl"><p class="text-[9px] text-slate-500 uppercase">Estado</p><p id="scan-cond" class="font-black"></p></div>
                                <div class="bg-white/5 p-4 rounded-2xl"><p class="text-[9px] text-slate-500 uppercase">Ubicaci√≥n</p><p id="scan-loc" class="font-black"></p></div>
                            </div>
                            <div id="scan-reason-box" class="bg-red-500/10 border border-red-500/20 p-4 rounded-2xl hidden">
                                <p id="scan-reason-text" class="text-sm italic"></p>
                            </div>
                            <hr class="border-white/10">
                            <div class="space-y-4">
                                <h3 class="font-black text-xs uppercase text-center">Actualizar Novedad</h3>
                                <select id="rep-new-cond" class="w-full input-dark bg-slate-800">
                                    <option value="Da√±ado">Da√±ado</option>
                                    <option value="Mantenimiento">Mantenimiento</option>
                                    <option value="Excelente">Excelente</option>
                                </select>
                                <textarea id="rep-reason" placeholder="Explicaci√≥n detallada..." class="w-full input-dark h-24" required></textarea>
                                <button id="btn-send-report" class="w-full btn-primary p-4 rounded-2xl font-black uppercase">Guardar Reporte</button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <script>
        // ===================== TOAST SYSTEM =====================
        function showToast(msg, type = 'info', duration = 3500) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const icons = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
            const t = document.createElement('div');
            t.className = `toast toast-${type}`;
            t.innerHTML = `<i class="fas ${icons[type]||icons.info}"></i><span>${msg}</span>`;
            container.appendChild(t);
            setTimeout(() => {
                t.classList.add('hiding');
                t.addEventListener('animationend', () => t.remove());
            }, duration);
        }

                const firebaseConfig = {
            apiKey: "AIzaSyD0rFUIbW_494SmefO7FRVhsBVW1aXxcDo",
            authDomain: "control-de-activos-1c3b7.firebaseapp.com",
            databaseURL: "https://control-de-activos-1c3b7-default-rtdb.firebaseio.com",
            projectId: "control-de-activos-1c3b7",
            storageBucket: "control-de-activos-1c3b7.firebasestorage.app",
            messagingSenderId: "898905793270",
            appId: "1:898905793270:web:7e8e1219f999af6a88c2d7"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.database();
        const MASTER_EMAIL = "anniel137@gmail.com";
        let userRole = "operario";
        let currentUserData = {};

        const urlParams = new URLSearchParams(window.location.search);
        const scannedId = urlParams.get('id');

        // Si hay un ID en la URL (escaneo QR), mostrar vista p√∫blica SIN requerir login
        if (scannedId) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('public-scan-screen').classList.remove('hidden');
            loadPublicAsset(scannedId);
        }

        function loadPublicAsset(id) {
            db.ref('assets/' + id).once('value', snap => {
                document.getElementById('public-loading').classList.add('hidden');
                const a = snap.val();
                if (!a) {
                    document.getElementById('public-not-found').classList.remove('hidden');
                    return;
                }
                const card = document.getElementById('public-asset-card');
                card.classList.remove('hidden');
                document.getElementById('pub-img').src = a.imageUrl;
                document.getElementById('pub-name').textContent = a.name;
                document.getElementById('pub-serial').textContent = a.serial || 'N/A';
                const condEl = document.getElementById('pub-cond');
                condEl.textContent = a.cond;
                condEl.className = 'font-black text-sm ' + (a.cond === 'Da√±ado' ? 'text-red-400' : a.cond === 'Mantenimiento' ? 'text-orange-400' : 'text-emerald-400');
                document.getElementById('pub-loc').textContent = a.location;
                if (a.reason) {
                    document.getElementById('pub-reason-box').classList.remove('hidden');
                    document.getElementById('pub-reason-text').textContent = a.reason;
                }
            });
        }


        function loadAssets() {
            db.ref('assets').on('value', snap => {
                allAssets = [];
                const container = document.getElementById('assets-container');
                let stats = { total: 0, Excelente: 0, Mantenimiento: 0, Da√±ado: 0 };
                let cards = '';
                const canEdit = (userRole === 'admin' || userRole === 'mantenimiento');
                snap.forEach(doc => {
                    const a = doc.val();
                    allAssets.push({key: doc.key, ...a});
                    stats.total++; stats[a.cond]++;
                    const condColor = a.cond === 'Da√±ado' ? 'text-red-500' : a.cond === 'Mantenimiento' ? 'text-orange-400' : 'text-cyan-400';
                    const fallback = "this.style.display='none';this.nextElementSibling.style.display='flex'";
                    // Build creator/editor badge
                    const roleBadgeColor = r => r==='admin'?'text-purple-400 bg-purple-500/10 border-purple-500/30':r==='mantenimiento'?'text-orange-400 bg-orange-500/10 border-orange-500/30':'text-cyan-400 bg-cyan-500/10 border-cyan-500/30';
                    const roleLabel = r => r==='admin'?'Admin':r==='mantenimiento'?'Mantenimiento':'Operario';
                    const createdBy = a.createdBy;
                    const updatedBy = a.updatedBy;
                    const wasEdited = updatedBy && createdBy && updatedBy.uid !== createdBy.uid || (updatedBy && createdBy && updatedBy.date !== createdBy.date && updatedBy.uid === createdBy.uid && a.updatedAt !== a.createdBy?.date);
                    const authorBlock = createdBy ? `
                        <div class="mt-3 pt-3 border-t border-white/5 space-y-1.5">
                            <div class="flex items-center gap-1.5">
                                <i class="fas fa-plus-circle text-[8px] text-slate-600"></i>
                                <span class="text-[8px] text-slate-600 uppercase font-black tracking-wide">Registrado por</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-5 h-5 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center text-[7px] font-black text-slate-400 shrink-0">
                                    ${(createdBy.name||'?').substring(0,2).toUpperCase()}
                                </div>
                                <div class="min-w-0">
                                    <p class="text-[9px] text-white font-black truncate">${createdBy.name||createdBy.email}</p>
                                    <span class="text-[7px] px-1.5 py-0.5 rounded-full border font-black uppercase ${roleBadgeColor(createdBy.role)}">${roleLabel(createdBy.role)}</span>
                                </div>
                            </div>
                            ${updatedBy && updatedBy.date !== createdBy.date ? `
                            <div class="flex items-center gap-1.5 mt-1">
                                <i class="fas fa-pencil-alt text-[8px] text-slate-700"></i>
                                <span class="text-[8px] text-slate-600 uppercase font-black tracking-wide">Editado por</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-5 h-5 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center text-[7px] font-black text-slate-400 shrink-0">
                                    ${(updatedBy.name||'?').substring(0,2).toUpperCase()}
                                </div>
                                <div class="min-w-0">
                                    <p class="text-[9px] text-white font-black truncate">${updatedBy.name||updatedBy.email}</p>
                                    <span class="text-[7px] px-1.5 py-0.5 rounded-full border font-black uppercase ${roleBadgeColor(updatedBy.role)}">${roleLabel(updatedBy.role)}</span>
                                </div>
                            </div>` : ''}
                        </div>` : '<div class="mt-3 pt-3 border-t border-white/5"><p class="text-[8px] text-slate-700 italic">Sin informaci√≥n de registro</p></div>';

                    cards += `
                        <div class="glass-card p-6 border border-white/5">
                            <div class="relative w-full h-32 mb-4 rounded-xl overflow-hidden bg-white/5">
                                <img src="${a.imageUrl||''}" onerror="${fallback}" class="w-full h-full object-cover rounded-xl">
                                <div style="display:none" class="absolute inset-0 items-center justify-center text-slate-600 text-3xl"><i class="fas fa-image"></i></div>
                            </div>
                            <h4 class="text-white font-black uppercase text-xs">${a.name}</h4>
                            <p class="text-[9px] text-slate-500 mt-0.5">${a.serial||''}</p>
                            <p class="text-[9px] font-bold ${condColor} uppercase mt-1">${a.cond}</p>
                            ${authorBlock}
                            <div class="flex gap-2 mt-3">
                                ${canEdit ? `<button onclick="editAsset('${doc.key}')" class="flex-1 bg-white/5 p-2 rounded-lg text-[9px] font-bold hover:bg-white/10 transition">EDITAR</button>` : ''}
                                <button onclick="openQR('${doc.key}')" class="flex-1 bg-white/5 p-2 rounded-lg text-[9px] font-bold hover:bg-white/10 transition">QR</button>
                                ${canEdit ? `<button onclick="deleteAsset('${doc.key}')" class="p-2 text-red-500/50 hover:text-red-500"><i class="fas fa-trash"></i></button>` : ''}
                            </div>
                        </div>`;
                });
                container.innerHTML = cards;
                document.getElementById('dash-total').textContent = stats.total;
                document.getElementById('dash-excelente').textContent = stats.Excelente;
                document.getElementById('dash-mantenimiento').textContent = stats.Mantenimiento;
                document.getElementById('dash-danado').textContent = stats.Da√±ado;
                renderAssignments();
                updateDeptStats();
            });
        }


        function loadAdminUsers() {
            db.ref('users').on('value', snap => {
                const container = document.getElementById('users-table-container');
                const roleLabel = r => {
                    if (r === 'admin') return '<span class="role-badge-admin">üõ°Ô∏è Nivel 1 ‚Äî Administrativo</span>';
                    if (r === 'mantenimiento') return '<span class="role-badge-mantenimiento">üîß Nivel 2 ‚Äî Mantenimiento</span>';
                    return '<span class="role-badge-operario">‚öôÔ∏è Nivel 3 ‚Äî Operario</span>';
                };
                let html = `<table class="w-full text-left uppercase text-[11px] font-bold">
                    <tr class="text-slate-500 border-b border-white/10">
                        <th class="p-4">Nombre / Email</th>
                        <th class="p-4">C√©dula</th>
                        <th class="p-4">Nivel de Acceso</th>
                        <th class="p-4">Permisos</th>
                        <th class="p-4">Acci√≥n</th>
                    </tr>`;
                snap.forEach(doc => {
                    const u = doc.val();
                    const perms = getRolePermissions(u.role);
                    html += `<tr class="border-b border-white/5 table-row-hover">
                        <td class="p-4">${u.name}<br><span class="text-[9px] text-slate-500 normal-case">${u.email}</span></td>
                        <td class="p-4 text-slate-400">${u.cedula||'-'}</td>
                        <td class="p-4">${roleLabel(u.role)}</td>
                        <td class="p-4">
                            <div class="flex gap-1 flex-wrap">
                                ${perms.map(p=>`<span class="text-[8px] px-1.5 py-0.5 rounded bg-white/5 text-slate-400 border border-white/10">${p}</span>`).join('')}
                            </div>
                        </td>
                        <td class="p-4">
                            ${u.email !== MASTER_EMAIL ? `<button onclick="deleteUser('${doc.key}')" class="text-red-500 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>` : '‚Äî'}
                        </td>
                    </tr>`;
                });
                container.innerHTML = html + "</table>";
            });
        }


        function loadScannedAsset(id) {
            db.ref('assets/' + id).on('value', snap => {
                const a = snap.val(); if(!a) return;
                showSection('scan-view');
                document.getElementById('scan-img').src = a.imageUrl;
                document.getElementById('scan-name').textContent = a.name;
                document.getElementById('scan-cond').textContent = a.cond;
                document.getElementById('scan-loc').textContent = a.location;
                if(a.reason) {
                    document.getElementById('scan-reason-box').classList.remove('hidden');
                    document.getElementById('scan-reason-text').textContent = "NOTA ACTUAL: " + a.reason;
                }
                document.getElementById('btn-send-report').onclick = () => {
                    if (!auth.currentUser) {
                        showToast('Debes iniciar sesi√≥n para reportar una novedad.', 'warning');
                        return;
                    }
                    const motivo = document.getElementById('rep-reason').value.trim();
                    const newC = document.getElementById('rep-new-cond').value;
                    if (!motivo) { showToast('Indica el motivo de la novedad.', 'warning'); return; }
                    const btn = document.getElementById('btn-send-report');
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
                    db.ref('reports').push({ assetName: a.name, user: auth.currentUser.email, reason: motivo, newC: newC, date: new Date().toLocaleString() });
                    db.ref('assets/' + id).update({ cond: newC, reason: motivo }).then(() => {
                        document.getElementById('rep-reason').value = '';
                        btn.disabled = false;
                        btn.innerHTML = 'Guardar Reporte';
                        showToast('‚úÖ Estado actualizado con √©xito.', 'success');
                    }).catch(() => {
                        btn.disabled = false;
                        btn.innerHTML = 'Guardar Reporte';
                        showToast('‚ö†Ô∏è Error al guardar. Intenta de nuevo.', 'error');
                    });
                };
            });
        }

        let allReports = [];
        let activeFilter = 'todos';

        function loadReports() {
            db.ref('reports').on('value', snap => {
                allReports = [];
                snap.forEach(doc => {
                    allReports.unshift({ key: doc.key, ...doc.val() });
                });
                updateReportStats();
                // Refresh whichever view is active
                if (activeReportView === 'assets') renderAssetReportCards();
                else renderReports();
            });
        }

        function updateReportStats() {
            const total = allReports.length;
            const danado = allReports.filter(r => r.newC === 'Da√±ado').length;
            const mant = allReports.filter(r => r.newC === 'Mantenimiento').length;
            const exc = allReports.filter(r => r.newC === 'Excelente').length;
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-danado').textContent = danado;
            document.getElementById('stat-mantenimiento').textContent = mant;
            document.getElementById('stat-excelente').textContent = exc;
        }

        function setReportFilter(f) {
            activeFilter = f;
            document.querySelectorAll('.report-filter-btn').forEach(b => {
                b.classList.remove('active-filter');
                b.classList.add('bg-white/5', 'text-slate-400');
            });
            const btn = document.getElementById('filter-' + f.toLowerCase().replace('√©','e').replace('√≥','o').replace('√±','n'));
            if (btn) { btn.classList.add('active-filter'); btn.classList.remove('bg-white/5','text-slate-400'); }
            renderReports();
        }

        function filterReports() { renderReports(); }

        function openQR(id) {
            db.ref('assets/' + id).once('value', snap => {
                const a = snap.val();
                const m = document.createElement('div');
                m.className = "fixed inset-0 z-[3000] bg-black/95 flex items-center justify-center p-6";
                m.innerHTML = `
                    <div class="glass-card p-8 text-center" id="print-area">
                        <div id="qr-gen" class="bg-white p-4 rounded-2xl mb-4 inline-block"></div>
                        <h4 id="qr-label" class="text-white font-black uppercase text-sm mb-4">${a.name}</h4>
                        <div class="flex flex-col gap-2 w-full no-print">
                            <button onclick="window.print()" class="w-full bg-emerald-600 hover:bg-emerald-500 p-3 rounded-xl font-black uppercase text-xs transition">
                                <i class="fas fa-print mr-2"></i>Imprimir QR
                            </button>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="w-full btn-primary p-3 rounded-xl font-black uppercase text-xs">
                                Cerrar
                            </button>
                        </div>
                    </div>`;
                document.body.appendChild(m);
                new QRCode(document.getElementById('qr-gen'), { 
                    text: "https://anniel137.github.io/uptjaa-inventory/?id=" + id, 
                    width: 220, 
                    height: 220 
                });
            });
        }

        function deleteAsset(id) {
            if (!confirm('¬øEliminar este activo? \n\nTambi√©n se eliminar√°n sus asignaciones y reportes relacionados.')) return;
            // Cascade: remove related assignments
            allAssignments.filter(a => a.assetId === id).forEach(a => db.ref('assignments/' + a.key).remove());
            db.ref('assets/' + id).remove().then(() => showToast('Activo eliminado.', 'success'));
        }
        function deleteUser(id) {
            if (!confirm('¬øEliminar este usuario del sistema?\n\nSus asignaciones quedar√°n sin titular.')) return;
            db.ref('users/' + id).remove().then(() => showToast('Usuario eliminado.', 'success'));
        }
        
        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            auth.signInWithEmailAndPassword(document.getElementById('user-input').value, document.getElementById('pass-input').value).catch(() => showToast('Acceso denegado. Verifica tus credenciales.', 'error'));
        };
        function logout() { auth.signOut().then(() => location.href = window.location.origin + window.location.pathname); }

        // ===================== REGISTRO SOLICITUD =====================
        function toggleRegRequest() {
            const f = document.getElementById('reg-request-form');
            f.classList.toggle('hidden');
        }
        function submitRegRequest() {
            const name = document.getElementById('reg-name').value;
            const cedula = document.getElementById('reg-cedula').value;
            const email = document.getElementById('reg-email').value;
            const cargo = document.getElementById('reg-cargo').value;
            if (!name || !cedula || !email) { showToast('Completa nombre, c√©dula y correo.', 'warning'); return; }
            db.ref('access_requests').push({
                name, cedula, email, cargo,
                status: 'pendiente',
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleString()
            }).then(() => {
                showToast('‚úÖ Solicitud enviada. Un administrador la revisar√° pronto.', 'success');
                document.getElementById('reg-request-form').classList.add('hidden');
                document.getElementById('reg-name').value = '';
                document.getElementById('reg-cedula').value = '';
                document.getElementById('reg-email').value = '';
                document.getElementById('reg-cargo').value = '';
            });
        }

        // ===================== SHOW SECTION (enhanced) =====================
        function showSection(id) {
            document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
            const sec = document.getElementById('sec-' + id);
            if (sec) sec.classList.remove('hidden');
            const sectionNames = {
                dashboard: 'Panel Principal', inventario: 'Inventario', usuarios: 'Usuarios',
                reportes: 'Reportes', departamentos: 'Departamentos', asignaciones: 'Asignaciones',
                registrados: 'Solicitudes de Acceso', manual: 'Manual de Usuario', 'scan-view': 'Detalle de Activo'
            };
            document.getElementById('section-title').textContent = sectionNames[id] || id.charAt(0).toUpperCase() + id.slice(1);
            // Highlight nav
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('text-cyan-400','bg-white/10');
                b.classList.add('text-slate-400');
            });
            const navBtn = document.getElementById('nav-' + id);
            if (navBtn) { navBtn.classList.add('text-cyan-400','bg-white/10'); navBtn.classList.remove('text-slate-400'); }
            // When entering reportes, make sure the active sub-view is rendered
            if (id === 'reportes') {
                if (typeof activeReportView !== 'undefined') setReportView(activeReportView);
                else setReportView('assets');
            }
        }

        // ===================== DEPARTAMENTOS =====================
        let allDepts = [];

        function loadDepts() {
            db.ref('departments').on('value', snap => {
                allDepts = [];
                snap.forEach(doc => allDepts.push({key: doc.key, ...doc.val()}));
                renderDepts();
                populateDeptSelects();
                updateDeptStats();
            });
        }

        function updateDeptStats() {
            const totalDepts = allDepts.length;
            const totalAssets = allAssets.filter(a => a.deptKey).length;
            const totalUsers = (typeof allUsers !== 'undefined') ? allUsers.filter(u => u.deptKey).length : 0;
            const totalAssign = allAssignments.filter(a => a.deptKey).length;
            const el = id => document.getElementById(id);
            if(el('stat-dept-total'))       el('stat-dept-total').textContent = totalDepts;
            if(el('stat-dept-assets'))      el('stat-dept-assets').textContent = totalAssets;
            if(el('stat-dept-users'))       el('stat-dept-users').textContent = totalUsers;
            if(el('stat-dept-assignments')) el('stat-dept-assignments').textContent = totalAssign;
        }

        function renderDepts() {
            const container = document.getElementById('depts-table-container');
            if (!container) return;
            const search = (document.getElementById('dept-search')?.value||'').toLowerCase();
            const filtered = allDepts.filter(d =>
                !search ||
                (d.name||'').toLowerCase().includes(search) ||
                (d.coordinator||'').toLowerCase().includes(search) ||
                (d.floor||'').toLowerCase().includes(search)
            );
            if (!filtered.length) {
                container.innerHTML = '<p class="text-slate-500 text-xs text-center py-8">No hay departamentos registrados</p>';
                return;
            }
            let html = `<table class="w-full text-left uppercase text-[11px] font-bold">
                <thead><tr class="text-slate-500 border-b border-white/10 text-[9px]">
                    <th class="p-4">Departamento</th>
                    <th class="p-4">Coordinador</th>
                    <th class="p-4">√Årea / Piso</th>
                    <th class="p-4">Contacto</th>
                    <th class="p-4">Activos</th>
                    <th class="p-4">Personal</th>
                    <th class="p-4">Asignaciones</th>
                    <th class="p-4">Acci√≥n</th>
                </tr></thead><tbody>`;
            filtered.forEach(d => {
                const assetCount   = allAssets.filter(a => a.deptKey === d.key).length;
                const deptUsers    = (typeof allUsers !== 'undefined') ? allUsers.filter(u => u.deptKey === d.key) : [];
                const userCount    = deptUsers.length;
                const assignCount  = allAssignments.filter(a => a.deptKey === d.key).length;
                const roleBadge = r => r==='admin'?'<span class="role-badge-admin">Admin</span>':r==='mantenimiento'?'<span class="role-badge-mantenimiento">Mant.</span>':'<span class="role-badge-operario">Operario</span>';
                const userListHtml = userCount > 0
                    ? deptUsers.map(u => `
                        <div class="flex items-center gap-1.5 py-0.5 border-t border-white/5 first:border-0">
                            <div class="w-5 h-5 rounded-md bg-indigo-500/20 flex items-center justify-center text-[7px] font-black text-indigo-300 border border-white/10 shrink-0">${(u.name||'?').substring(0,2).toUpperCase()}</div>
                            <div class="min-w-0">
                                <p class="text-[9px] text-white font-black truncate">${u.name||'‚Äî'}</p>
                                <p class="text-[8px] text-slate-500 normal-case">${u.cargo||u.role||''}</p>
                            </div>
                            <div class="ml-auto shrink-0">${roleBadge(u.role)}</div>
                        </div>`).join('')
                    : '<p class="text-[8px] text-slate-700 italic normal-case">Sin personal</p>';
                html += `<tr class="border-b border-white/5 table-row-hover">
                    <td class="p-4">
                        <button onclick="openDeptModal('${d.key}')" class="text-left group">
                            <span class="badge-dept text-[10px] px-2 py-1 rounded-full group-hover:border-cyan-400/50 transition">${d.name}</span>
                            ${d.description ? `<p class="text-[8px] text-slate-600 mt-1 normal-case max-w-[140px] truncate">${d.description}</p>` : ''}
                        </button>
                    </td>
                    <td class="p-4 text-slate-300 normal-case">${d.coordinator||'‚Äî'}</td>
                    <td class="p-4 text-slate-400 normal-case">${d.floor||'‚Äî'}</td>
                    <td class="p-4 text-slate-500 normal-case text-[9px]">
                        ${d.phone ? `<div><i class="fas fa-phone text-[8px] mr-1"></i>${d.phone}</div>` : ''}
                        ${d.email ? `<div><i class="fas fa-envelope text-[8px] mr-1"></i>${d.email}</div>` : '‚Äî'}
                    </td>
                    <td class="p-4"><span class="${assetCount>0?'text-cyan-400':'text-slate-600'} font-black">${assetCount}</span></td>
                    <td class="p-4 min-w-[180px]">
                        <div class="space-y-0.5">${userListHtml}</div>
                    </td>
                    <td class="p-4"><span class="${assignCount>0?'text-emerald-400':'text-slate-600'} font-black">${assignCount}</span></td>
                    <td class="p-4 flex gap-2">
                        <button onclick="openDeptModal('${d.key}')" title="Ver detalle" class="text-cyan-500 hover:text-cyan-300 transition"><i class="fas fa-eye"></i></button>
                        <button onclick="editDept('${d.key}')" title="Editar" class="text-blue-400 hover:text-blue-300 transition"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteDept('${d.key}')" title="Eliminar" class="text-red-500 hover:text-red-400 transition"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
            container.innerHTML = html + '</tbody></table>';
            updateDeptStats();
        }

        function openDeptModal(deptKey) {
            const d = allDepts.find(x => x.key === deptKey);
            if (!d) return;
            const assets  = allAssets.filter(a => a.deptKey === deptKey);
            const users   = (typeof allUsers !== 'undefined') ? allUsers.filter(u => u.deptKey === deptKey) : [];
            const assigns = allAssignments.filter(a => a.deptKey === deptKey);
            const modal = document.getElementById('dept-detail-modal');
            document.getElementById('modal-dept-name').textContent = d.name;
            const condBadge = c => c==='Excelente'?'text-emerald-400':c==='Mantenimiento'?'text-orange-400':'text-red-400';
            const roleBadge = r => r==='admin'?'<span class="role-badge-admin">Admin</span>':r==='mantenimiento'?'<span class="role-badge-mantenimiento">Mantenimiento</span>':'<span class="role-badge-operario">Operario</span>';
            document.getElementById('modal-dept-body').innerHTML = `
                <!-- Info general -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white/5 p-4 rounded-2xl">
                        <p class="text-[8px] text-slate-500 uppercase font-black mb-1"><i class="fas fa-user-tie mr-1"></i>Coordinador</p>
                        <p class="text-sm font-black text-white">${d.coordinator||'‚Äî'}</p>
                    </div>
                    <div class="bg-white/5 p-4 rounded-2xl">
                        <p class="text-[8px] text-slate-500 uppercase font-black mb-1"><i class="fas fa-map-marker-alt mr-1"></i>Ubicaci√≥n</p>
                        <p class="text-sm font-black text-white">${d.floor||'‚Äî'}</p>
                    </div>
                    ${d.phone ? `<div class="bg-white/5 p-4 rounded-2xl">
                        <p class="text-[8px] text-slate-500 uppercase font-black mb-1"><i class="fas fa-phone mr-1"></i>Tel√©fono</p>
                        <p class="text-sm font-black text-white">${d.phone}</p>
                    </div>` : ''}
                    ${d.email ? `<div class="bg-white/5 p-4 rounded-2xl">
                        <p class="text-[8px] text-slate-500 uppercase font-black mb-1"><i class="fas fa-envelope mr-1"></i>Correo</p>
                        <p class="text-sm font-black text-cyan-400 normal-case">${d.email}</p>
                    </div>` : ''}
                </div>
                ${d.description ? `<div class="bg-white/5 p-4 rounded-2xl"><p class="text-[8px] text-slate-500 uppercase font-black mb-1">Descripci√≥n</p><p class="text-xs text-slate-300">${d.description}</p></div>` : ''}

                <!-- Personal -->
                <div>
                    <h4 class="text-xs font-black uppercase text-slate-400 mb-3"><i class="fas fa-users mr-2"></i>Personal del Departamento (${users.length})</h4>
                    ${users.length ? users.map(u => `
                        <div class="flex items-center gap-3 bg-white/5 p-3 rounded-xl mb-2">
                            <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-500/30 to-purple-500/20 flex items-center justify-center text-[9px] font-black text-indigo-300 border border-white/10 shrink-0">${(u.name||'?').substring(0,2).toUpperCase()}</div>
                            <div class="flex-1 min-w-0">
                                <p class="text-white font-black text-xs">${u.name}</p>
                                <p class="text-slate-500 text-[8px] normal-case">${u.email} ¬∑ ${u.cargo||''}</p>
                            </div>
                            ${roleBadge(u.role)}
                        </div>`).join('') : '<p class="text-slate-600 text-xs italic">Sin personal registrado en este departamento</p>'}
                </div>

                <!-- Activos -->
                <div>
                    <h4 class="text-xs font-black uppercase text-slate-400 mb-3"><i class="fas fa-box-open mr-2"></i>Activos en este Departamento (${assets.length})</h4>
                    ${assets.length ? assets.map(a => `
                        <div class="flex items-center gap-3 bg-white/5 p-3 rounded-xl mb-2">
                            <div class="w-8 h-8 rounded-xl bg-white/5 border border-white/10 shrink-0 overflow-hidden">
                                <img src="${a.imageUrl||''}" onerror="this.style.display='none'" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-white font-black text-xs uppercase">${a.name}</p>
                                <p class="text-slate-500 text-[8px]">${a.serial||''} ¬∑ ${a.type||''}</p>
                            </div>
                            <span class="text-[9px] font-black ${condBadge(a.cond)}">${a.cond}</span>
                        </div>`).join('') : '<p class="text-slate-600 text-xs italic">Sin activos registrados en este departamento</p>'}
                </div>

                <!-- Asignaciones activas -->
                <div>
                    <h4 class="text-xs font-black uppercase text-slate-400 mb-3"><i class="fas fa-link mr-2"></i>Asignaciones Activas (${assigns.filter(a=>a.status==='Activo').length})</h4>
                    ${assigns.filter(a=>a.status==='Activo').length ? assigns.filter(a=>a.status==='Activo').map(a => `
                        <div class="flex items-center gap-3 bg-white/5 p-3 rounded-xl mb-2">
                            <i class="fas fa-link text-emerald-400 text-xs shrink-0"></i>
                            <div class="flex-1 min-w-0">
                                <p class="text-white font-black text-xs">${a.assetName}</p>
                                <p class="text-slate-500 text-[8px]">‚Üí ${a.userName} ¬∑ ${a.date||''}</p>
                            </div>
                        </div>`).join('') : '<p class="text-slate-600 text-xs italic">Sin asignaciones activas</p>'}
                </div>`;
            modal.classList.remove('hidden');
        }

        function closeDeptModal() {
            document.getElementById('dept-detail-modal').classList.add('hidden');
        }

        function populateDeptSelects() {
            ['as-dept','assign-dept','u-dept-assign'].forEach(sid => {
                const sel = document.getElementById(sid);
                if (!sel) return;
                const cur = sel.value;
                sel.innerHTML = `<option value="">Departamento</option>` + allDepts.map(d => `<option value="${d.key}">${d.name}</option>`).join('');
                sel.value = cur;
            });
        }

        document.getElementById('form-dept').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('dept-edit-id').value;
            const data = {
                name:        document.getElementById('dept-name').value.trim(),
                coordinator: document.getElementById('dept-coord').value.trim(),
                floor:       document.getElementById('dept-floor').value.trim(),
                phone:       document.getElementById('dept-phone').value.trim(),
                email:       document.getElementById('dept-email').value.trim(),
                description: document.getElementById('dept-desc').value.trim()
            };
            const op = id ? db.ref('departments/'+id).update(data) : db.ref('departments').push(data);
            op.then(() => {
                showToast(id ? '‚úÖ Departamento actualizado.' : '‚úÖ Departamento registrado.', 'success');
                cancelDeptEdit();
            });
        };

        function cancelDeptEdit() {
            document.getElementById('form-dept').reset();
            document.getElementById('dept-edit-id').value = '';
            document.getElementById('dept-form-title').textContent = 'Registrar Departamento';
            document.getElementById('btn-dept-cancel').classList.add('hidden');
        }

        function editDept(id) {
            const d = allDepts.find(x => x.key === id); if (!d) return;
            document.getElementById('dept-edit-id').value  = id;
            document.getElementById('dept-name').value     = d.name;
            document.getElementById('dept-coord').value    = d.coordinator||'';
            document.getElementById('dept-floor').value    = d.floor||'';
            document.getElementById('dept-phone').value    = d.phone||'';
            document.getElementById('dept-email').value    = d.email||'';
            document.getElementById('dept-desc').value     = d.description||'';
            document.getElementById('dept-form-title').textContent = 'Editar Departamento: ' + d.name;
            document.getElementById('btn-dept-cancel').classList.remove('hidden');
            showSection('departamentos');
            window.scrollTo({top:0, behavior:'smooth'});
        }

        function deleteDept(id) {
            const d = allDepts.find(x=>x.key===id);
            if (!confirm(`¬øEliminar el departamento "${d?.name||''}"?\n\nLos activos y usuarios asignados a este departamento quedar√°n sin departamento.`)) return;
            db.ref('departments/'+id).remove().then(() => showToast('Departamento eliminado.', 'success'));
        }

        // ===================== ASIGNACIONES =====================
        let allAssignments = [];
        let allUsers = [];
        let allAssets = [];

        function loadAssignments() {
            db.ref('assignments').on('value', snap => {
                allAssignments = [];
                snap.forEach(doc => allAssignments.unshift({key: doc.key, ...doc.val()}));
                renderAssignments();
            });
        }
        function populateAssignSelects() {
            db.ref('assets').once('value', snap => {
                allAssets = [];
                const sel = document.getElementById('assign-asset');
                let opts = '<option value="">Seleccionar Activo</option>';
                snap.forEach(doc => {
                    const a = doc.val();
                    allAssets.push({key: doc.key, ...a});
                    opts += `<option value="${doc.key}">${a.name} (${a.serial||'S/N'})</option>`;
                });
                sel.innerHTML = opts;
                renderAssignments();
            });
            db.ref('users').on('value', snap => {
                allUsers = [];
                const sel = document.getElementById('assign-user');
                let opts = '<option value="">Seleccionar Personal</option>';
                snap.forEach(doc => {
                    const u = doc.val();
                    allUsers.push({key: doc.key, ...u});
                    opts += `<option value="${doc.key}" data-email="${u.email}">${u.name} ‚Äî ${u.cargo||u.role} [ID: ${doc.key.substring(0,8)}]</option>`;
                });
                sel.innerHTML = opts;
                // Re-render depts so the personnel list stays up to date
                renderDepts();
                updateDeptStats();
            });
        }
        function renderAssignments() {
            const container = document.getElementById('assignments-table-container');
            if (!container) return;
            const search = (document.getElementById('assign-search')?.value||'').toLowerCase();

            const condBadge = c => {
                if (c === 'Excelente')     return '<span class="text-[8px] px-1.5 py-0.5 rounded-full bg-emerald-500/15 text-emerald-400 border border-emerald-500/30">‚óè Excelente</span>';
                if (c === 'Mantenimiento') return '<span class="text-[8px] px-1.5 py-0.5 rounded-full bg-orange-500/15 text-orange-400 border border-orange-500/30">‚óè Mantenim.</span>';
                if (c === 'Da√±ado')        return '<span class="text-[8px] px-1.5 py-0.5 rounded-full bg-red-500/15 text-red-400 border border-red-500/30">‚óè Da√±ado</span>';
                return '<span class="text-[8px] px-1.5 py-0.5 rounded-full bg-white/10 text-slate-400">‚Äî</span>';
            };
            const statusColor = s => s==='Activo'?'text-emerald-400':s==='Devuelto'?'text-slate-400':'text-orange-400';
            const statusBg    = s => s==='Activo'?'bg-emerald-500/10 border-emerald-500/30':s==='Devuelto'?'bg-slate-500/10 border-slate-500/30':'bg-orange-500/10 border-orange-500/30';

            // Build map of latest assignment per asset
            const assignedMap = {};
            allAssignments.forEach(a => {
                if (!assignedMap[a.assetId] || a.registeredAt > (assignedMap[a.assetId].registeredAt||'')) {
                    assignedMap[a.assetId] = a;
                }
            });

            // Merge all assets with their assignment info
            const rows = allAssets.map(asset => {
                const assign = assignedMap[asset.key] || null;
                return { asset, assign };
            }).filter(row => {
                if (!search) return true;
                const n = (row.asset.name||'').toLowerCase();
                const s = (row.asset.serial||'').toLowerCase();
                const u = (row.assign?.userName||'').toLowerCase();
                const d = (row.assign?.deptName||'').toLowerCase();
                return n.includes(search) || s.includes(search) || u.includes(search) || d.includes(search);
            });

            if (!rows.length) {
                container.innerHTML = '<p class="text-slate-500 text-xs text-center py-8">No hay activos registrados</p>';
                return;
            }

            let html = `<table class="w-full text-left text-[11px] font-bold">
                <thead><tr class="text-slate-500 border-b border-white/10 uppercase text-[9px]">
                    <th class="p-3">Activo</th>
                    <th class="p-3">Serial</th>
                    <th class="p-3">Estado F√≠sico</th>
                    <th class="p-3">Asignado a</th>
                    <th class="p-3">Departamento</th>
                    <th class="p-3">Ubicaci√≥n</th>
                    <th class="p-3">Fecha</th>
                    <th class="p-3">Estado</th>
                    <th class="p-3">Notas</th>
                    <th class="p-3">Acci√≥n</th>
                </tr></thead><tbody>`;

            rows.forEach(({asset, assign}) => {
                const initials = assign ? (assign.userName||'?').split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase() : null;
                const userCell = assign
                    ? `<div class="flex items-center gap-2">
                            <div class="w-7 h-7 rounded-xl bg-gradient-to-br from-purple-500/30 to-cyan-500/20 flex items-center justify-center text-[9px] font-black text-cyan-300 border border-white/10 shrink-0">${initials}</div>
                            <div>
                                <p class="text-white font-black text-[10px]">${assign.userName||'-'}</p>
                                <p class="text-slate-500 text-[8px] normal-case font-normal">${assign.userEmail||''}</p>
                            </div>
                       </div>`
                    : `<span class="text-slate-600 italic text-[9px]"><i class="fas fa-user-slash mr-1"></i>Sin asignar</span>`;

                const statusCell = assign
                    ? `<span class="text-[9px] px-2 py-0.5 rounded-full font-black border ${statusBg(assign.status)} ${statusColor(assign.status)}">${assign.status||'‚Äî'}</span>`
                    : `<span class="text-[9px] px-2 py-0.5 rounded-full font-black bg-white/5 border border-white/10 text-slate-500">‚Äî</span>`;

                const actionCell = assign
                    ? `<div class="flex items-center gap-2">
                          <button onclick="deleteAssignment('${assign.key}')" title="Quitar asignaci√≥n" class="text-orange-500/70 hover:text-orange-400 transition" title="Desasignar"><i class="fas fa-unlink"></i></button>
                          <button onclick="deleteAssetRecord('${asset.key}')" title="Eliminar activo" class="text-red-500/60 hover:text-red-400 transition"><i class="fas fa-trash"></i></button>
                       </div>`
                    : `<button onclick="deleteAssetRecord('${asset.key}')" title="Eliminar activo" class="text-red-500/60 hover:text-red-400 transition"><i class="fas fa-trash"></i></button>`;

                html += `<tr class="border-b border-white/5 table-row-hover ${!assign ? 'opacity-60' : ''}">
                    <td class="p-3">
                        <div class="flex items-center gap-2">
                            <img src="${asset.imageUrl||''}" onerror="this.style.display='none'" class="w-8 h-8 rounded-lg object-cover shrink-0 border border-white/10">
                            <div>
                                <p class="text-cyan-400 font-black text-[10px]">${asset.name||'-'}</p>
                                <p class="text-slate-600 text-[8px]">${asset.type||''}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-3 text-slate-400 font-mono text-[9px]">${asset.serial||'‚Äî'}</td>
                    <td class="p-3">${condBadge(asset.cond)}</td>
                    <td class="p-3">${userCell}</td>
                    <td class="p-3"><span class="badge-dept text-[9px] px-2 py-0.5 rounded-full">${assign?.deptName||'‚Äî'}</span></td>
                    <td class="p-3 text-slate-400 text-[9px]">${assign?.location||'‚Äî'}</td>
                    <td class="p-3 text-slate-500 text-[9px]">${assign?.date||'‚Äî'}</td>
                    <td class="p-3">${statusCell}</td>
                    <td class="p-3 text-slate-400 text-[9px] italic max-w-[120px] truncate" title="${assign?.notes||''}">${assign?.notes||'‚Äî'}</td>
                    <td class="p-3">${actionCell}</td>
                </tr>`;
            });

            container.innerHTML = html + '</tbody></table>';

            // Update summary counter
            const total = rows.length;
            const assigned = rows.filter(r => r.assign).length;
            const unassigned = total - assigned;
            const headerEl = document.querySelector('#sec-asignaciones .glass-card:last-child h3');
            if (headerEl) {
                headerEl.innerHTML = `Registro de Asignaciones <span class="ml-3 text-[10px] font-normal text-slate-500">${assigned} asignados ¬∑ <span class="text-slate-600">${unassigned} sin asignar</span> ¬∑ ${total} total</span>`;
            }
            // Refresh dept stats since assignments changed
            updateDeptStats();
        }
        document.getElementById('form-assign').onsubmit = (e) => {
            e.preventDefault();
            const assetSel = document.getElementById('assign-asset');
            const userSel = document.getElementById('assign-user');
            const deptSel = document.getElementById('assign-dept');
            const assetId = assetSel.value;
            const userId = userSel.value;
            if (!assetId || !userId) { showToast('Selecciona activo y personal.', 'warning'); return; }
            const assetName = assetSel.options[assetSel.selectedIndex].text;
            const userOption = userSel.options[userSel.selectedIndex];
            const userName = userOption.text.split('‚Äî')[0].trim();
            const userEmail = userOption.getAttribute('data-email')||'';
            const deptKey = deptSel.value;
            const deptName = deptKey ? (allDepts.find(d=>d.key===deptKey)?.name||'') : '';
            // Warn if asset already has an active assignment
            const existing = allAssignments.find(a => a.assetId === assetId && a.status === 'Activo');
            const doSave = () => {
                const data = {
                    assetId, assetName, userId, userName, userEmail,
                    deptKey, deptName,
                    location: document.getElementById('assign-location').value,
                    date: document.getElementById('assign-date').value || new Date().toLocaleDateString(),
                    status: document.getElementById('assign-status').value,
                    notes: document.getElementById('assign-notes').value,
                    registeredAt: new Date().toISOString()
                };
                db.ref('assignments').push(data).then(() => { showToast('‚úÖ Asignaci√≥n registrada correctamente.', 'success'); e.target.reset(); });
            };
            if (existing) {
                if (confirm('‚ö†Ô∏è Este activo ya est√° asignado a "' + existing.userName + '" con estado Activo.\n\n¬øDeseas registrar una nueva asignaci√≥n de todas formas?')) {
                    doSave();
                }
            } else {
                doSave();
            }
        };
        function deleteAssignment(id) { if(confirm('¬øDesasignar este activo?')) db.ref('assignments/'+id).remove().then(() => showToast('Asignaci√≥n eliminada.', 'success')); }
        function deleteAssetRecord(id) { if(confirm('¬øEliminar este activo del inventario? Esta acci√≥n no se puede deshacer.')) db.ref('assets/'+id).remove().then(() => showToast('Activo eliminado.', 'success')); }

        // ===================== USUARIOS REGISTRADOS (solicitudes) =====================
        function loadRegistrados() {
            db.ref('access_requests').on('value', snap => {
                const container = document.getElementById('registrados-container');
                const pendingBadge = document.getElementById('pending-badge');
                const pendingLabel = document.getElementById('pending-count-label');
                let pending = 0, html = '';
                const items = [];
                snap.forEach(doc => items.unshift({key: doc.key, ...doc.val()}));
                items.forEach(r => {
                    if (r.status === 'pendiente') pending++;
                    const statusBadge = r.status === 'pendiente'
                        ? 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30'
                        : r.status === 'aprobado'
                            ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30'
                            : 'bg-red-500/20 text-red-400 border-red-500/30';
                    const isInPersonnel = r.status !== 'pendiente' ? '' : '';
                    html += `<div class="glass-card p-5 flex items-center gap-4 border ${r.status==='pendiente'?'border-yellow-500/20':'border-white/5'}">
                        <div class="w-12 h-12 rounded-2xl bg-white/5 flex items-center justify-center font-black text-sm text-cyan-400 border border-white/10 shrink-0">
                            ${(r.name||'?').substring(0,2).toUpperCase()}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-black text-white text-sm">${r.name}</p>
                            <p class="text-[10px] text-slate-400">${r.email} ‚Äî C.I.: ${r.cedula}</p>
                            <p class="text-[9px] text-slate-500">${r.cargo||'Cargo no especificado'} ¬∑ ${r.date}</p>
                        </div>
                        <div class="flex flex-col items-end gap-2 shrink-0">
                            <span class="text-[9px] px-3 py-1 rounded-full font-black uppercase border ${statusBadge}">${r.status}</span>
                            ${r.status === 'pendiente' ? `
                            <div class="flex gap-2">
                                <button onclick="approveRequest('${r.key}','${r.name}','${r.email}')" class="bg-emerald-600 hover:bg-emerald-500 text-white text-[9px] font-black px-3 py-1.5 rounded-lg uppercase transition">
                                    <i class="fas fa-check mr-1"></i>Aprobar
                                </button>
                                <button onclick="rejectRequest('${r.key}')" class="bg-red-600/50 hover:bg-red-600 text-white text-[9px] font-black px-3 py-1.5 rounded-lg uppercase transition">
                                    <i class="fas fa-times mr-1"></i>Rechazar
                                </button>
                            </div>` : ''}
                        </div>
                    </div>`;
                });
                container.innerHTML = html || '<p class="text-slate-500 text-xs text-center py-8">No hay solicitudes de acceso</p>';
                if (pendingBadge) { pendingBadge.classList.toggle('hidden', pending===0); pendingBadge.textContent = pending; }
                if (pendingLabel) pendingLabel.textContent = `${pending} Pendiente${pending!==1?'s':''}`;
            });
            // Also load all system users
            loadAllAuthUsers();
        }
        function approveRequest(key, name, email) {
            if (!confirm(`¬øAprobar acceso a ${name}?\n\nVerifica que esta persona sea personal activo de la instituci√≥n antes de aprobar.`)) return;
            db.ref('access_requests/'+key).update({status:'aprobado', approvedAt: new Date().toISOString()})
            .then(() => showToast(`‚úÖ Solicitud de ${name} aprobada.`, 'success'));
        }
        function rejectRequest(key) {
            if (!confirm("¬øRechazar esta solicitud?")) return;
            db.ref('access_requests/'+key).update({status:'rechazado', rejectedAt: new Date().toISOString()});
        }
        function loadAllAuthUsers() {
            db.ref('users').on('value', snap => {
                const container = document.getElementById('all-auth-users-container');
                if (!container) return;
                const roleBadge = r => {
                    if (r === 'admin') return '<span class="role-badge-admin">üõ°Ô∏è Niv.1 Admin</span>';
                    if (r === 'mantenimiento') return '<span class="role-badge-mantenimiento">üîß Niv.2 Mant.</span>';
                    return '<span class="role-badge-operario">‚öôÔ∏è Niv.3 Operario</span>';
                };
                let html = `<table class="w-full text-left uppercase text-[11px] font-bold">
                    <thead><tr class="text-slate-500 border-b border-white/10">
                        <th class="p-4">ID Sistema</th><th class="p-4">Nombre</th><th class="p-4">Correo</th><th class="p-4">C.I.</th><th class="p-4">Cargo</th><th class="p-4">Depto</th><th class="p-4">Nivel</th>
                    </tr></thead><tbody>`;
                snap.forEach(doc => {
                    const u = doc.val();
                    const dept = allDepts.find(d => d.key === u.deptKey);
                    html += `<tr class="border-b border-white/5 table-row-hover">
                        <td class="p-4 font-mono text-[9px] text-slate-500">${doc.key.substring(0,12)}...</td>
                        <td class="p-4 text-white">${u.name}</td>
                        <td class="p-4 text-slate-400 normal-case">${u.email}</td>
                        <td class="p-4 text-slate-400">${u.cedula||'-'}</td>
                        <td class="p-4 text-slate-400 normal-case">${u.cargo||'-'}</td>
                        <td class="p-4"><span class="badge-dept text-[9px] px-2 py-0.5 rounded-full">${dept?.name||'-'}</span></td>
                        <td class="p-4">${roleBadge(u.role)}</td>
                    </tr>`;
                });
                container.innerHTML = html + '</tbody></table>';
            });
        }

        // ===================== MANUAL DE USUARIO =====================
        const manualContent = {
            intro: `
                <h2 class="text-2xl font-black text-white uppercase mb-4">üìã Introducci√≥n al Sistema NEXUS-ID</h2>
                <p class="mb-4">NEXUS-ID es un <strong class="text-cyan-400">Sistema Integrado de Gesti√≥n de Activos Tecnol√≥gicos</strong> desarrollado para la Universidad Polit√©cnica Territorial Jos√© Antonio Anzo√°tegui. Permite registrar, controlar, asignar y reportar el estado de todos los equipos tecnol√≥gicos de la instituci√≥n.</p>
                <h3 class="text-lg font-black text-white uppercase mt-6 mb-3">üéØ Objetivos del Sistema</h3>
                <ul class="space-y-2 list-none">
                    <li class="flex gap-2"><span class="text-cyan-400">‚Ä∫</span> Mantener un inventario actualizado y detallado de todos los activos tecnol√≥gicos</li>
                    <li class="flex gap-2"><span class="text-cyan-400">‚Ä∫</span> Controlar la asignaci√≥n de equipos a personal y departamentos</li>
                    <li class="flex gap-2"><span class="text-cyan-400">‚Ä∫</span> Generar reportes peri√≥dicos membretados para auditor√≠a</li>
                    <li class="flex gap-2"><span class="text-cyan-400">‚Ä∫</span> Garantizar que solo personal verificado tenga acceso al sistema</li>
                    <li class="flex gap-2"><span class="text-cyan-400">‚Ä∫</span> Rastrear el historial de cambios de estado mediante c√≥digos QR</li>
                </ul>
                <h3 class="text-lg font-black text-white uppercase mt-6 mb-3">üèóÔ∏è Estructura del Sistema</h3>
                <p>El sistema maneja <strong class="text-purple-400">5 tablas principales</strong> en su base de datos: <span class="text-cyan-400 font-black">Activos</span> (inventario de equipos), <span class="text-cyan-400 font-black">Usuarios</span> (personal autorizado), <span class="text-cyan-400 font-black">Departamentos</span> (unidades organizativas), <span class="text-cyan-400 font-black">Asignaciones</span> (v√≠nculos activo-persona-departamento) y <span class="text-cyan-400 font-black">Reportes</span> (historial de novedades).</p>
                <div class="mt-6 bg-purple-500/10 border border-purple-500/30 rounded-2xl p-5">
                    <p class="text-[10px] text-purple-400 font-black uppercase mb-1">‚ö° Potencial del sistema</p>
                    <p class="text-xs">NEXUS-ID puede escalar para integrar: alertas autom√°ticas de mantenimiento, notificaciones por correo, reportes de depreciaci√≥n de activos, firma digital de actas de entrega, integraci√≥n con sistemas administrativos institucionales y m√≥dulo de licitaciones.</p>
                </div>`,
            login: `
                <h2 class="text-2xl font-black text-white uppercase mb-4">üîê Acceso al Sistema</h2>
                <h3 class="text-lg font-black text-white mt-4 mb-2">¬øC√≥mo ingresar?</h3>
                <p class="mb-3">Ingresa tu <strong class="text-cyan-400">correo institucional</strong> y contrase√±a en la pantalla de inicio. Si no tienes credenciales, debes solicitar acceso.</p>
                <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4 mb-4">
                    <p class="text-[10px] text-yellow-400 font-black uppercase mb-1">‚ö†Ô∏è Control de Acceso Importante</p>
                    <p class="text-xs">El sistema verifica que el usuario sea personal activo de la instituci√≥n. No cualquier persona puede registrarse libremente. El administrador debe aprobar cada solicitud de acceso revisando la c√©dula y cargo del solicitante.</p>
                </div>
                <h3 class="text-lg font-black text-white mt-4 mb-2">¬øC√≥mo solicitar acceso?</h3>
                <ol class="space-y-2 list-decimal list-inside text-xs">
                    <li>En la pantalla de login, haz clic en <span class="text-cyan-400 font-bold">"Solicitar Acceso"</span></li>
                    <li>Completa el formulario con tu nombre, c√©dula, correo y cargo</li>
                    <li>Espera la revisi√≥n del administrador</li>
                    <li>Una vez aprobado, el admin crear√° tus credenciales</li>
                </ol>`,
            inventario: `
                <h2 class="text-2xl font-black text-white uppercase mb-4">üì¶ Gesti√≥n de Inventario</h2>
                <p class="mb-4">La secci√≥n de inventario permite registrar y administrar todos los activos tecnol√≥gicos de la instituci√≥n.</p>
                <h3 class="text-lg font-black text-white mt-4 mb-2">Campos del Activo</h3>
                <div class="grid grid-cols-2 gap-3 text-xs">
                    <div class="bg-white/5 p-3 rounded-xl"><strong class="text-cyan-400">Nombre</strong><br>Identificaci√≥n descriptiva del equipo</div>
                    <div class="bg-white/5 p-3 rounded-xl"><strong class="text-cyan-400">Serial</strong><br>N√∫mero √∫nico de inventario o serie del fabricante</div>
                    <div class="bg-white/5 p-3 rounded-xl"><strong class="text-cyan-400">Marca / Modelo</strong><br>Fabricante y modelo espec√≠fico del equipo</div>
                    <div class="bg-white/5 p-3 rounded-xl"><strong class="text-cyan-400">Tipo</strong><br>Categor√≠a del activo (PC, Laptop, Impresora, etc.)</div>
                    <div class="bg-white/5 p-3 rounded-xl"><strong class="text-cyan-400">Ubicaci√≥n</strong><br>Lugar f√≠sico donde se encuentra el equipo</div>
                    <div class="bg-white/5 p-3 rounded-xl"><strong class="text-cyan-400">Estado</strong><br>Excelente, En Mantenimiento, o Da√±ado</div>
                </div>
                <h3 class="text-lg font-black text-white mt-6 mb-2">Estados del Activo</h3>
                <ul class="space-y-2 text-xs">
                    <li><span class="text-emerald-400 font-black">‚óè Excelente:</span> El equipo funciona correctamente y no requiere intervenci√≥n.</li>
                    <li><span class="text-orange-400 font-black">‚óè Mantenimiento:</span> El equipo est√° siendo revisado o requiere servicio preventivo.</li>
                    <li><span class="text-red-400 font-black">‚óè Da√±ado:</span> El equipo presenta fallas o est√° fuera de servicio.</li>
                </ul>`,
            asignacion: `
                <h2 class="text-2xl font-black text-white uppercase mb-4">üîó Tabla de Asignaciones</h2>
                <p class="mb-4">Las asignaciones vinculan un activo tecnol√≥gico a un usuario y un departamento espec√≠fico. Cada asignaci√≥n queda registrada con el <strong class="text-cyan-400">ID √∫nico del usuario en el sistema</strong>.</p>
                <h3 class="text-lg font-black text-white mt-4 mb-2">¬øC√≥mo asignar un activo?</h3>
                <ol class="space-y-2 list-decimal list-inside text-xs">
                    <li>Ve a la secci√≥n <strong class="text-cyan-400">Asignaciones</strong> en el men√∫</li>
                    <li>Selecciona el activo del inventario</li>
                    <li>Selecciona el personal al que se asignar√° (el sistema toma su ID autom√°ticamente)</li>
                    <li>Selecciona el departamento y la ubicaci√≥n espec√≠fica</li>
                    <li>Establece la fecha y el estado de la asignaci√≥n</li>
                    <li>Haz clic en <strong>Registrar Asignaci√≥n</strong></li>
                </ol>
                <div class="mt-4 bg-cyan-500/10 border border-cyan-500/30 rounded-xl p-4 text-xs">
                    <p class="text-cyan-400 font-black uppercase mb-1">üìå Trazabilidad</p>
                    <p>Cada asignaci√≥n queda vinculada al ID del usuario en la base de datos, garantizando trazabilidad completa: qui√©n tiene qu√© equipo, desde cu√°ndo, y en qu√© departamento.</p>
                </div>`,
            reportes: `
                <h2 class="text-2xl font-black text-white uppercase mb-4">üìä Generaci√≥n de Reportes</h2>
                <p class="mb-4">Los reportes recogen el historial de novedades reportadas sobre los activos. Pueden filtrarse por estado y per√≠odo de tiempo.</p>
                <h3 class="text-lg font-black text-white mt-4 mb-2">Filtros Disponibles</h3>
                <ul class="space-y-2 text-xs">
                    <li><strong class="text-white">Por estado:</strong> Todos, Da√±ado, Mantenimiento, Excelente</li>
                    <li><strong class="text-white">Por per√≠odo:</strong> Hoy, Esta semana, Este mes, Todo</li>
                    <li><strong class="text-white">B√∫squeda:</strong> Por nombre del activo, usuario o motivo</li>
                </ul>
                <h3 class="text-lg font-black text-white mt-6 mb-2">Reporte Membretado</h3>
                <p class="mb-3 text-xs">Al hacer clic en <strong class="text-emerald-400">"Imprimir Reporte Membretado"</strong>, se genera un documento que incluye:</p>
                <ul class="space-y-1 text-xs list-none">
                    <li class="flex gap-2"><span class="text-purple-400">‚Ä∫</span> Logo institucional y nombre completo del sistema</li>
                    <li class="flex gap-2"><span class="text-purple-400">‚Ä∫</span> Fecha y hora de generaci√≥n del reporte</li>
                    <li class="flex gap-2"><span class="text-purple-400">‚Ä∫</span> Estad√≠sticas de resumen (total, da√±ados, en mantenimiento, excelentes)</li>
                    <li class="flex gap-2"><span class="text-purple-400">‚Ä∫</span> Listado detallado con activo, usuario, estado y motivo</li>
                    <li class="flex gap-2"><span class="text-purple-400">‚Ä∫</span> Filtros aplicados al momento de la impresi√≥n</li>
                </ul>`,
            roles: `
                <h2 class="text-2xl font-black text-white uppercase mb-2">üë• Niveles de Acceso</h2>
                <p class="text-xs text-slate-400 mb-6">El sistema tiene <strong class="text-white">3 niveles jer√°rquicos</strong>. Cada nivel superior incluye todo lo del nivel inferior m√°s permisos adicionales.</p>

                <!-- Pir√°mide visual -->
                <div class="flex flex-col items-center gap-1 mb-8">
                    <div class="bg-purple-500/20 border border-purple-500/40 rounded-xl px-10 py-3 text-center w-72">
                        <p class="text-[9px] text-purple-400 uppercase font-black tracking-widest mb-0.5">Nivel 1 ‚Äî Acceso Total</p>
                        <p class="font-black text-white text-base">üõ°Ô∏è Personal Administrativo</p>
                    </div>
                    <div class="text-slate-600 text-lg">‚ñº</div>
                    <div class="bg-orange-500/10 border border-orange-500/30 rounded-xl px-10 py-3 text-center w-80">
                        <p class="text-[9px] text-orange-400 uppercase font-black tracking-widest mb-0.5">Nivel 2 ‚Äî Casi Acceso Total</p>
                        <p class="font-black text-white text-base">üîß Personal de Mantenimiento</p>
                    </div>
                    <div class="text-slate-600 text-lg">‚ñº</div>
                    <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-xl px-10 py-3 text-center w-96">
                        <p class="text-[9px] text-cyan-400 uppercase font-black tracking-widest mb-0.5">Nivel 3 ‚Äî Acceso B√°sico</p>
                        <p class="font-black text-white text-base">‚öôÔ∏è Personal Operario</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                    <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-2xl p-5">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-2xl">‚öôÔ∏è</span>
                            <div>
                                <p class="text-[8px] text-cyan-400 uppercase font-black">Nivel 3 ‚Äî B√°sico</p>
                                <h3 class="text-sm font-black text-white">Operario</h3>
                            </div>
                        </div>
                        <ul class="space-y-1.5 text-xs">
                            <li class="flex gap-2 items-start"><span class="text-emerald-400 mt-0.5">‚úÖ</span> Ver Panel / Dashboard</li>
                            <li class="flex gap-2 items-start"><span class="text-emerald-400 mt-0.5">‚úÖ</span> Ver inventario de activos</li>
                            <li class="flex gap-2 items-start"><span class="text-emerald-400 mt-0.5">‚úÖ</span> Escanear QR y reportar novedad</li>
                            <li class="flex gap-2 items-start"><span class="text-emerald-400 mt-0.5">‚úÖ</span> Consultar Manual de usuario</li>
                            <li class="flex gap-2 items-start"><span class="text-red-400 mt-0.5">‚ùå</span> No ve Reportes hist√≥ricos</li>
                            <li class="flex gap-2 items-start"><span class="text-red-400 mt-0.5">‚ùå</span> No ve Asignaciones</li>
                            <li class="flex gap-2 items-start"><span class="text-red-400 mt-0.5">‚ùå</span> No accede a Departamentos</li>
                            <li class="flex gap-2 items-start"><span class="text-red-400 mt-0.5">‚ùå</span> No gestiona usuarios ni solicitudes</li>
                        </ul>
                    </div>
                    <div class="bg-orange-500/10 border border-orange-500/30 rounded-2xl p-5">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-2xl">üîß</span>
                            <div>
                                <p class="text-[8px] text-orange-400 uppercase font-black">Nivel 2 ‚Äî Casi Total</p>
                                <h3 class="text-sm font-black text-white">Mantenimiento</h3>
                            </div>
                        </div>
                        <p class="text-[9px] text-orange-400/70 italic mb-2">Todo lo del Nivel 3, m√°s:</p>
                        <ul class="space-y-1.5 text-xs">
                            <li class="flex gap-2 items-start"><span class="text-emerald-400 mt-0.5">‚úÖ</span> Ver historial completo de Reportes</li>
                            <li class="flex gap-2 items-start"><span class="text-emerald-400 mt-0.5">‚úÖ</span> Filtrar reportes por per√≠odo y estado</li>
                            <li class="flex gap-2 items-start"><span class="text-emerald-400 mt-0.5">‚úÖ</span> Ver e imprimir reporte membretado</li>
                            <li class="flex gap-2 items-start"><span class="text-emerald-400 mt-0.5">‚úÖ</span> Ver tabla de Asignaciones</li>
                            <li class="flex gap-2 items-start"><span class="text-emerald-400 mt-0.5">‚úÖ</span> Gestionar Departamentos</li>
                            <li class="flex gap-2 items-start"><span class="text-red-400 mt-0.5">‚ùå</span> No gestiona Usuarios del sistema</li>
                            <li class="flex gap-2 items-start"><span class="text-red-400 mt-0.5">‚ùå</span> No ve ni aprueba solicitudes de acceso</li>
                            <li class="flex gap-2 items-start"><span class="text-red-400 mt-0.5">‚ùå</span> No ve el panel de Registrados</li>
                        </ul>
                    </div>
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-2xl p-5">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-2xl">üõ°Ô∏è</span>
                            <div>
                                <p class="text-[8px] text-purple-400 uppercase font-black">Nivel 1 ‚Äî Total</p>
                                <h3 class="text-sm font-black text-white">Administrativo</h3>
                            </div>
                        </div>
                        <p class="text-[9px] text-purple-400/70 italic mb-2">Todo lo del Nivel 2, m√°s:</p>
                        <ul class="space-y-1.5 text-xs">
                            <li class="flex gap-2 items-start"><span class="text-emerald-400 mt-0.5">‚úÖ</span> Crear, editar y eliminar usuarios</li>
                            <li class="flex gap-2 items-start"><span class="text-emerald-400 mt-0.5">‚úÖ</span> Asignar niveles de acceso al personal</li>
                            <li class="flex gap-2 items-start"><span class="text-emerald-400 mt-0.5">‚úÖ</span> Ver todos los usuarios del sistema</li>
                            <li class="flex gap-2 items-start"><span class="text-emerald-400 mt-0.5">‚úÖ</span> Recibir, aprobar y rechazar solicitudes</li>
                            <li class="flex gap-2 items-start"><span class="text-emerald-400 mt-0.5">‚úÖ</span> Control total del sistema</li>
                        </ul>
                    </div>
                </div>
                <div class="mt-5 bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4 text-xs">
                    <p class="text-yellow-400 font-black uppercase mb-1">üîí Principio de m√≠nimo privilegio</p>
                    <p>El Personal de Mantenimiento tiene casi los mismos permisos que el Administrativo pero <strong>no puede tocar la gesti√≥n de usuarios ni aprobar accesos</strong>, lo cual es una funci√≥n exclusiva del Nivel 1. El Personal Operario solo puede realizar su funci√≥n b√°sica de reporte de novedades.</p>
                </div>`,
            qr: `
                <h2 class="text-2xl font-black text-white uppercase mb-4">üì± C√≥digos QR</h2>
                <p class="mb-4">Cada activo tecnol√≥gico puede generar un c√≥digo QR √∫nico que permite acceder a su informaci√≥n y reportar novedades desde cualquier dispositivo.</p>
                <h3 class="text-lg font-black text-white mt-4 mb-2">¬øC√≥mo usar el QR?</h3>
                <ol class="space-y-2 list-decimal list-inside text-xs">
                    <li>En el inventario, haz clic en el bot√≥n <strong class="text-cyan-400">QR</strong> del activo</li>
                    <li>Se genera un c√≥digo QR con el enlace √∫nico del activo</li>
                    <li>Imprime el QR y p√©galo f√≠sicamente en el equipo</li>
                    <li>Cualquier persona con el enlace puede ver el estado p√∫blico del activo</li>
                    <li>Para reportar una novedad, deben iniciar sesi√≥n como operario</li>
                </ol>
                <div class="mt-4 bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4 text-xs">
                    <p class="text-emerald-400 font-black uppercase mb-1">‚úÖ Vista P√∫blica</p>
                    <p>Al escanear el QR sin estar autenticado, se muestra la informaci√≥n b√°sica del activo (nombre, estado, ubicaci√≥n, serial). Para reportar cambios, se requiere credenciales.</p>
                </div>`
        };
        function showManualTab(tab) {
            document.querySelectorAll('.manual-tab').forEach(t => t.classList.remove('active'));
            const btn = document.getElementById('mtab-'+tab);
            if (btn) btn.classList.add('active');
            const area = document.getElementById('manual-content-area');
            if (area) area.innerHTML = manualContent[tab] || '<p>Contenido no disponible</p>';
        }

        // ===================== TIME FILTER FOR REPORTS =====================
        let activeTimeFilter = 'all';
        function setTimeFilter(t) {
            activeTimeFilter = t;
            document.querySelectorAll('.time-filter-btn').forEach(b => {
                b.classList.remove('active-time');
                b.classList.add('bg-white/5','text-slate-400');
            });
            const btn = document.getElementById('tfilter-'+t);
            if (btn) { btn.classList.add('active-time'); btn.classList.remove('bg-white/5','text-slate-400'); }
            renderReports();
        }

        // ===================== PRINT REPORT (membretado) =====================
        function printReport() {
            const filtered = getCurrentFilteredReports();
            const periodLabel = {'all':'Todo el per√≠odo','day':'Hoy','week':'Esta semana','month':'Este mes'}[activeTimeFilter];
            const condLabel = activeFilter === 'todos' ? 'Todos los estados' : activeFilter;
            const now = new Date().toLocaleString('es-VE');
            const total = filtered.length;
            const danado = filtered.filter(r=>r.newC==='Da√±ado').length;
            const mant = filtered.filter(r=>r.newC==='Mantenimiento').length;
            const exc = filtered.filter(r=>r.newC==='Excelente').length;

            const rows = filtered.map(r => `
                <tr style="border-bottom:1px solid #eee;">
                    <td style="padding:8px;font-size:11px;">${r.assetName||'-'}</td>
                    <td style="padding:8px;font-size:11px;">${r.user||'-'}</td>
                    <td style="padding:8px;font-size:11px;color:${r.newC==='Da√±ado'?'#dc2626':r.newC==='Mantenimiento'?'#ea580c':'#16a34a'};font-weight:bold;">${r.newC}</td>
                    <td style="padding:8px;font-size:11px;font-style:italic;">${r.reason||'-'}</td>
                    <td style="padding:8px;font-size:11px;color:#666;">${r.date||'-'}</td>
                </tr>`).join('');

            const win = window.open('','_blank');
            win.document.write(`<!DOCTYPE html><html><head><title>Reporte NEXUS-ID</title>
            <style>
                body{font-family:Arial,sans-serif;margin:0;padding:0;color:#111;}
                .header{background:linear-gradient(135deg,#1a1b25,#0d0e17);color:white;padding:30px 40px;display:flex;align-items:center;gap:20px;}
                .header img{width:70px;height:70px;border-radius:50%;border:2px solid #00f2ff;object-fit:cover;}
                .header-text h1{font-size:28px;font-weight:900;font-style:italic;margin:0;}
                .header-text p{font-size:9px;color:#00f2ff;text-transform:uppercase;letter-spacing:2px;margin:4px 0 0;}
                .header-text small{font-size:10px;color:#aaa;}
                .meta{background:#f8f9fa;border-bottom:3px solid #bc13fe;padding:12px 40px;display:flex;justify-content:space-between;align-items:center;font-size:10px;color:#666;}
                .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:20px 40px;}
                .stat-card{border:1px solid #e5e7eb;border-radius:8px;padding:12px;text-align:center;}
                .stat-card .num{font-size:28px;font-weight:900;} .stat-card .lbl{font-size:9px;text-transform:uppercase;color:#999;}
                table{width:100%;border-collapse:collapse;margin:0 40px;width:calc(100% - 80px);}
                thead th{background:#1a1b25;color:white;padding:10px 8px;font-size:10px;text-transform:uppercase;text-align:left;}
                .footer{margin-top:30px;padding:15px 40px;border-top:1px solid #eee;display:flex;justify-content:space-between;font-size:9px;color:#999;}
            </style></head><body>
            <div class="header">
                <img src="https://raw.githubusercontent.com/anniel137/uptjaa-inventory/main/gemini-2.5-flash-image_quiero_que_me_crees_el_logo_de_el_polianzoategui_que_sea_algo_mas_futurista-0.jpg">
                <div class="header-text">
                    <h1>NEXUS-ID</h1>
                    <p>Sistema Integrado de Activos Tecnol√≥gicos</p>
                    <small>Universidad Polit√©cnica Territorial Jos√© Antonio Anzo√°tegui</small>
                </div>
            </div>
            <div class="meta">
                <span><strong>Reporte de Novedades</strong> ‚Äî Generado: ${now}</span>
                <span>Per√≠odo: <strong>${periodLabel}</strong> | Estado: <strong>${condLabel}</strong></span>
            </div>
            <div class="stats">
                <div class="stat-card"><div class="num" style="color:#7c3aed;">${total}</div><div class="lbl">Total Reportes</div></div>
                <div class="stat-card"><div class="num" style="color:#dc2626;">${danado}</div><div class="lbl">Da√±ados</div></div>
                <div class="stat-card"><div class="num" style="color:#ea580c;">${mant}</div><div class="lbl">Mantenimiento</div></div>
                <div class="stat-card"><div class="num" style="color:#16a34a;">${exc}</div><div class="lbl">Excelentes</div></div>
            </div>
            <table>
                <thead><tr><th>Activo</th><th>Reportado por</th><th>Estado</th><th>Motivo / Observaci√≥n</th><th>Fecha</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>
            <div class="footer">
                <span>NEXUS-ID ‚Äî Sistema Integrado de Activos Tecnol√≥gicos</span>
                <span>Documento generado autom√°ticamente. ${now}</span>
            </div>
            </body></html>`);
            win.document.close();
            setTimeout(() => win.print(), 500);
        }
        function getCurrentFilteredReports() {
            const search = (document.getElementById('report-search')?.value||'').toLowerCase();
            const now = new Date();
            return allReports.filter(r => {
                const matchFilter = activeFilter === 'todos' || r.newC === activeFilter;
                const matchSearch = !search ||
                    (r.assetName||'').toLowerCase().includes(search) ||
                    (r.user||'').toLowerCase().includes(search) ||
                    (r.reason||'').toLowerCase().includes(search);
                // Time filter
                let matchTime = true;
                if (activeTimeFilter !== 'all' && r.date) {
                    try {
                        const rd = new Date(r.date);
                        if (!isNaN(rd)) {
                            if (activeTimeFilter === 'day') {
                                matchTime = rd.toDateString() === now.toDateString();
                            } else if (activeTimeFilter === 'week') {
                                const weekAgo = new Date(now); weekAgo.setDate(now.getDate()-7);
                                matchTime = rd >= weekAgo;
                            } else if (activeTimeFilter === 'month') {
                                matchTime = rd.getMonth()===now.getMonth() && rd.getFullYear()===now.getFullYear();
                            }
                        }
                    } catch(e) {}
                }
                return matchFilter && matchSearch && matchTime;
            });
        }

        // ===================== RENDER REPORTS =====================
        function renderReports() {
            const container = document.getElementById('reports-list-container');
            const emptyEl = document.getElementById('reports-empty');
            const filtered = getCurrentFilteredReports();
            document.getElementById('report-count-label').textContent = `${filtered.length} resultado${filtered.length!==1?'s':''}`;
            if (filtered.length === 0) {
                container.innerHTML = '';
                emptyEl.classList.remove('hidden');
                return;
            }
            emptyEl.classList.add('hidden');
            const condConfig = {
                'Da√±ado':        { border: 'border-red-500',    badge: 'badge-danado',        icon: 'fa-times-circle',  dot: 'bg-red-500' },
                'Mantenimiento': { border: 'border-orange-500', badge: 'badge-mantenimiento', icon: 'fa-tools',         dot: 'bg-orange-500' },
                'Excelente':     { border: 'border-emerald-500',badge: 'badge-excelente',     icon: 'fa-check-circle',  dot: 'bg-emerald-500' }
            };
            container.innerHTML = filtered.map((r, i) => {
                const cfg = condConfig[r.newC] || condConfig['Mantenimiento'];
                const initials = (r.user||'?').substring(0,2).toUpperCase();
                return `
                <div class="report-item glass-card p-5 border-l-4 ${cfg.border} flex gap-4 items-start" style="animation-delay:${i*0.04}s">
                    <div class="w-10 h-10 rounded-2xl bg-white/5 flex items-center justify-center shrink-0 text-[10px] font-black text-cyan-400 border border-white/10">${initials}</div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between gap-2 flex-wrap mb-1">
                            <h5 class="text-white font-black uppercase text-sm truncate">${r.assetName || 'Activo'}</h5>
                            <div class="flex items-center gap-2 shrink-0">
                                <span class="text-[9px] px-3 py-1 rounded-full font-black uppercase ${cfg.badge}">
                                    <i class="fas ${cfg.icon} mr-1"></i>${r.newC}
                                </span>
                                <button onclick="event.stopPropagation();deleteReport('${r.key}')" title="Eliminar reporte" class="w-7 h-7 flex items-center justify-center rounded-lg bg-red-500/10 hover:bg-red-500/25 text-red-500/60 hover:text-red-400 border border-red-500/20 transition-all">
                                    <i class="fas fa-trash text-[9px]"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-xs italic text-slate-300 mb-2">"${r.reason}"</p>
                        <div class="flex items-center gap-3 flex-wrap">
                            <span class="text-[9px] text-slate-500 flex items-center gap-1"><i class="fas fa-user text-[8px]"></i>${r.user}</span>
                            <span class="text-[9px] text-slate-600">‚Ä¢</span>
                            <span class="text-[9px] text-slate-500 flex items-center gap-1"><i class="fas fa-clock text-[8px]"></i>${r.date}</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // ===================== REPORT VIEW TOGGLE =====================
        let activeReportView = 'assets';

        function setReportView(view) {
            activeReportView = view;
            document.getElementById('view-assets-panel').classList.toggle('hidden', view !== 'assets');
            document.getElementById('view-history-panel').classList.toggle('hidden', view !== 'history');
            document.querySelectorAll('.report-view-btn').forEach(b => {
                b.classList.remove('bg-gradient-to-r','from-purple-600','to-violet-600','text-white');
                b.classList.add('bg-white/5','text-slate-400');
            });
            const active = document.getElementById('view-btn-' + view);
            if (active) {
                active.classList.add('bg-gradient-to-r','from-purple-600','to-violet-600','text-white');
                active.classList.remove('bg-white/5','text-slate-400');
            }
            if (view === 'assets') renderAssetReportCards();
            else renderReports();
        }

        // ===================== ASSET REPORT CARDS =====================
        function renderAssetReportCards() {
            const container = document.getElementById('asset-report-cards');
            const emptyEl   = document.getElementById('asset-report-empty');
            if (!container) return;
            const search = (document.getElementById('asset-report-search')?.value || '').toLowerCase();

            // Group reports by assetName
            const grouped = {};
            allReports.forEach(r => {
                const key = r.assetName || 'Sin nombre';
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(r);
            });

            // Match with allAssets to get image/serial. Also include assets with 0 reports.
            // Build list: assets that have at least 1 report come first, sorted by report count desc
            const assetMap = {};
            allAssets.forEach(a => { assetMap[a.name] = a; });

            // Only show assets that have reports
            let entries = Object.entries(grouped).map(([name, reports]) => {
                const asset = assetMap[name] || null;
                return { name, reports, asset };
            }).filter(e => {
                if (!search) return true;
                return e.name.toLowerCase().includes(search) ||
                       (e.asset?.serial||'').toLowerCase().includes(search);
            }).sort((a,b) => b.reports.length - a.reports.length);

            if (!entries.length) {
                container.innerHTML = '';
                emptyEl.classList.remove('hidden');
                return;
            }
            emptyEl.classList.add('hidden');

            const condConfig = {
                'Da√±ado':        { color: 'text-red-400',     bg: 'bg-red-500/10',     border: 'border-red-500/30',     dot: 'bg-red-500'     },
                'Mantenimiento': { color: 'text-orange-400',  bg: 'bg-orange-500/10',  border: 'border-orange-500/30',  dot: 'bg-orange-400'  },
                'Excelente':     { color: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'border-emerald-500/30', dot: 'bg-emerald-400' }
            };

            container.innerHTML = entries.map(({name, reports, asset}) => {
                const last = reports[0]; // most recent first (allReports is unshifted)
                const cfg  = condConfig[last?.newC] || condConfig['Excelente'];
                const danado = reports.filter(r => r.newC === 'Da√±ado').length;
                const mant   = reports.filter(r => r.newC === 'Mantenimiento').length;
                const exc    = reports.filter(r => r.newC === 'Excelente').length;
                const fallback = "this.style.display='none';this.nextElementSibling.style.display='flex'";
                const safeKey = encodeURIComponent(name);
                return `
                <div onclick="openAssetReportModal('${safeKey}')"
                    class="glass-card p-0 border border-white/5 hover:border-cyan-400/30 transition-all cursor-pointer overflow-hidden group">
                    <!-- Image strip -->
                    <div class="relative w-full h-28 bg-white/5">
                        <img src="${asset?.imageUrl||''}" onerror="${fallback}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                        <div style="display:none" class="absolute inset-0 items-center justify-center text-slate-700 text-3xl"><i class="fas fa-image"></i></div>
                        <!-- Badge estado actual -->
                        <div class="absolute top-2 right-2">
                            <span class="text-[8px] px-2 py-1 rounded-full font-black border ${cfg.bg} ${cfg.border} ${cfg.color}">
                                <span class="inline-block w-1.5 h-1.5 rounded-full ${cfg.dot} mr-1"></span>${last?.newC||'‚Äî'}
                            </span>
                        </div>
                        <!-- Report count badge -->
                        <div class="absolute top-2 left-2">
                            <span class="text-[9px] px-2 py-1 rounded-full font-black bg-black/60 text-white border border-white/10">
                                <i class="fas fa-file-alt mr-1"></i>${reports.length} reporte${reports.length!==1?'s':''}
                            </span>
                        </div>
                    </div>
                    <!-- Info -->
                    <div class="p-4">
                        <h4 class="text-white font-black uppercase text-xs group-hover:text-cyan-400 transition truncate">${name}</h4>
                        <p class="text-[8px] text-slate-600 mt-0.5 truncate">${asset?.serial ? 'S/N: '+asset.serial : asset?.type||''}</p>
                        <!-- Mini stats -->
                        <div class="flex gap-2 mt-3 flex-wrap">
                            ${danado   ? `<span class="text-[8px] px-1.5 py-0.5 rounded bg-red-500/10 text-red-400 border border-red-500/20 font-black">${danado} Da√±ado</span>` : ''}
                            ${mant     ? `<span class="text-[8px] px-1.5 py-0.5 rounded bg-orange-500/10 text-orange-400 border border-orange-500/20 font-black">${mant} Mant.</span>` : ''}
                            ${exc      ? `<span class="text-[8px] px-1.5 py-0.5 rounded bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 font-black">${exc} Excelente</span>` : ''}
                        </div>
                        <!-- Last report -->
                        <div class="mt-3 pt-3 border-t border-white/5">
                            <p class="text-[8px] text-slate-600 uppercase font-black mb-1"><i class="fas fa-clock mr-1"></i>√öltimo reporte</p>
                            <p class="text-[9px] text-slate-400 italic truncate">"${last?.reason||'‚Äî'}"</p>
                            <p class="text-[8px] text-slate-600 mt-0.5">${last?.user||''} ¬∑ ${last?.date||''}</p>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // ===================== ASSET REPORT MODAL =====================
        function openAssetReportModal(encodedName) {
            const name = decodeURIComponent(encodedName);
            const reports = allReports.filter(r => r.assetName === name);
            const asset   = allAssets.find(a => a.name === name);
            const modal   = document.getElementById('asset-report-modal');

            // Header
            document.getElementById('arm-img').src    = asset?.imageUrl || '';
            document.getElementById('arm-name').textContent   = name;
            document.getElementById('arm-serial').textContent = asset?.serial ? 'Serial: ' + asset.serial : asset?.type || '';

            // Mini stats in header
            const danado = reports.filter(r => r.newC === 'Da√±ado').length;
            const mant   = reports.filter(r => r.newC === 'Mantenimiento').length;
            const exc    = reports.filter(r => r.newC === 'Excelente').length;
            document.getElementById('arm-stats').innerHTML = `
                <span class="text-[8px] px-2 py-0.5 rounded-full bg-white/5 border border-white/10 text-slate-400 font-black">${reports.length} total</span>
                ${danado ? `<span class="text-[8px] px-2 py-0.5 rounded-full bg-red-500/10 border border-red-500/20 text-red-400 font-black">${danado} Da√±ado</span>` : ''}
                ${mant   ? `<span class="text-[8px] px-2 py-0.5 rounded-full bg-orange-500/10 border border-orange-500/20 text-orange-400 font-black">${mant} Mant.</span>` : ''}
                ${exc    ? `<span class="text-[8px] px-2 py-0.5 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 font-black">${exc} Excelente</span>` : ''}`;

            // Reports list (timeline style)
            const condConfig = {
                'Da√±ado':        { border: 'border-red-500',    badge: 'badge-danado',        icon: 'fa-times-circle',  line: 'bg-red-500'     },
                'Mantenimiento': { border: 'border-orange-500', badge: 'badge-mantenimiento', icon: 'fa-tools',         line: 'bg-orange-400'  },
                'Excelente':     { border: 'border-emerald-500',badge: 'badge-excelente',     icon: 'fa-check-circle',  line: 'bg-emerald-400' }
            };

            if (!reports.length) {
                document.getElementById('arm-list').innerHTML = '<p class="text-slate-500 text-xs text-center py-8 italic">Sin reportes para este activo</p>';
            } else {
                document.getElementById('arm-list').innerHTML = reports.map((r, i) => {
                    const cfg = condConfig[r.newC] || condConfig['Excelente'];
                    const initials = (r.user||'?').substring(0,2).toUpperCase();
                    const isLast = i === reports.length - 1;
                    return `
                    <div class="relative flex gap-3">
                        <!-- Timeline line -->
                        ${!isLast ? `<div class="absolute left-[19px] top-10 bottom-0 w-0.5 ${cfg.line} opacity-20"></div>` : ''}
                        <!-- Avatar -->
                        <div class="w-10 h-10 rounded-2xl bg-white/5 flex items-center justify-center shrink-0 text-[10px] font-black text-cyan-400 border border-white/10 z-10">${initials}</div>
                        <!-- Content -->
                        <div class="flex-1 glass-card p-4 border-l-4 ${cfg.border} mb-0">
                            <div class="flex items-center justify-between gap-2 flex-wrap mb-1">
                                <span class="text-[9px] px-2 py-0.5 rounded-full font-black uppercase ${cfg.badge}">
                                    <i class="fas ${cfg.icon} mr-1"></i>${r.newC}
                                </span>
                                <div class="flex items-center gap-2">
                                    <span class="text-[8px] text-slate-600"><i class="fas fa-clock mr-1"></i>${r.date||'‚Äî'}</span>
                                    <button onclick="deleteReport('${r.key}')" title="Eliminar" class="w-6 h-6 flex items-center justify-center rounded-lg bg-red-500/10 hover:bg-red-500/25 text-red-500/50 hover:text-red-400 border border-red-500/20 transition-all">
                                        <i class="fas fa-trash text-[8px]"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="text-xs italic text-slate-300 mb-1">"${r.reason}"</p>
                            <p class="text-[9px] text-slate-500"><i class="fas fa-user mr-1"></i>${r.user||'‚Äî'}</p>
                        </div>
                    </div>`;
                }).join('');
            }
            modal.classList.remove('hidden');
        }

        function closeAssetReportModal() {
            document.getElementById('asset-report-modal').classList.add('hidden');
        }

        function deleteReport(id) {
            if (!confirm('¬øEliminar este reporte? Esta acci√≥n no se puede deshacer.')) return;
            db.ref('reports/' + id).remove().then(() => {
                showToast('Reporte eliminado.', 'success');
            }).catch(() => showToast('Error al eliminar el reporte.', 'error'));
        }

        // ===================== TOGGLE PASSWORD VISIBILITY =====================
        function togglePassVis(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon  = document.getElementById(iconId);
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        // ===================== ENHANCED USER FORM (creates real Firebase Auth user) =====================
        document.getElementById('form-user').onsubmit = async (e) => {
            e.preventDefault();

            const errEl  = document.getElementById('form-user-error');
            const btnEl  = document.getElementById('btn-add-user');
            errEl.classList.add('hidden');

            const name     = document.getElementById('u-name').value.trim();
            const cedula   = document.getElementById('u-cedula').value.trim();
            const email    = document.getElementById('u-email').value.trim();
            const cargo    = document.getElementById('u-cargo').value.trim();
            const deptKey  = document.getElementById('u-dept-assign').value;
            const role     = document.getElementById('u-role').value;
            const password = document.getElementById('u-password').value;
            const confirm  = document.getElementById('u-password-confirm').value;

            // Validations
            if (password !== confirm) {
                errEl.textContent = '‚ö†Ô∏è Las contrase√±as no coinciden.';
                errEl.classList.remove('hidden');
                return;
            }
            if (password.length < 6) {
                errEl.textContent = '‚ö†Ô∏è La contrase√±a debe tener al menos 6 caracteres.';
                errEl.classList.remove('hidden');
                return;
            }

            // Loading state
            btnEl.disabled = true;
            btnEl.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creando usuario...';

            try {
                // Use Firebase Auth REST API to create user WITHOUT signing out current admin
                const FIREBASE_API_KEY = firebaseConfig.apiKey;
                const res = await fetch(
                    `https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${FIREBASE_API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password, returnSecureToken: true })
                    }
                );
                const result = await res.json();

                if (result.error) {
                    // Translate common Firebase errors to Spanish
                    const msg = {
                        'EMAIL_EXISTS':          '‚ö†Ô∏è Este correo ya est√° registrado en el sistema.',
                        'INVALID_EMAIL':         '‚ö†Ô∏è El correo ingresado no es v√°lido.',
                        'WEAK_PASSWORD':         '‚ö†Ô∏è Contrase√±a muy d√©bil. Usa al menos 6 caracteres.',
                        'OPERATION_NOT_ALLOWED': '‚ö†Ô∏è El registro est√° deshabilitado en Firebase.',
                    }[result.error.message] || `‚ö†Ô∏è Error: ${result.error.message}`;
                    errEl.textContent = msg;
                    errEl.classList.remove('hidden');
                    return;
                }

                // Save user profile in Realtime Database using the real UID
                const uid  = result.localId;
                const dept = allDepts.find(d => d.key === deptKey);
                const userData = {
                    name, cedula, email, cargo,
                    deptKey:  deptKey  || '',
                    deptName: dept?.name || '',
                    role,
                    registeredAt: new Date().toISOString()
                };

                await db.ref('users/' + uid).set(userData);

                // Success
                showToast(`‚úÖ Usuario "${name}" creado. Ya puede iniciar sesi√≥n.`, 'success');
                e.target.reset();

            } catch (err) {
                errEl.textContent = '‚ö†Ô∏è Error de conexi√≥n. Verifica tu internet e intenta de nuevo.';
                errEl.classList.remove('hidden');
            } finally {
                btnEl.disabled = false;
                btnEl.innerHTML = '<i class="fas fa-user-plus mr-2"></i>A√±adir al Sistema';
            }
        };

        // ===================== ENHANCED ASSET FORM =====================
        document.getElementById('form-asset').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const deptKey = document.getElementById('as-dept').value;
            const dept = allDepts.find(d=>d.key===deptKey);
            const now = new Date().toISOString();
            const byInfo = {
                uid:   currentUserData.uid   || '',
                name:  currentUserData.name  || currentUserData.email || 'Desconocido',
                email: currentUserData.email || '',
                role:  currentUserData.role  || userRole,
                date:  now
            };
            const baseData = {
                name: document.getElementById('as-name').value,
                serial: document.getElementById('as-serial').value,
                model: document.getElementById('as-model').value,
                type: document.getElementById('as-type').value,
                location: document.getElementById('as-loc').value,
                deptKey: deptKey, deptName: dept?.name||'',
                imageUrl: document.getElementById('as-photo').value,
                purchaseDate: document.getElementById('as-purchase').value,
                cond: document.getElementById('as-cond').value,
                reason: document.getElementById('as-reason').value,
                updatedAt: now,
                updatedBy: byInfo
            };
            if (id) {
                // Editing: preserve original createdBy, just update updatedBy
                db.ref('assets/'+id).once('value', snap => {
                    const existing = snap.val() || {};
                    const updateData = { ...baseData, createdBy: existing.createdBy || byInfo };
                    db.ref('assets/'+id).update(updateData).then(() => {
                        showToast('‚úÖ Activo actualizado.', 'success');
                        e.target.reset(); resetImageUpload();
                        document.getElementById('edit-id').value = '';
                    });
                });
            } else {
                // New asset: set createdBy = current user
                const newData = { ...baseData, createdBy: byInfo };
                db.ref('assets').push(newData).then(() => {
                    showToast('‚úÖ Activo guardado.', 'success');
                    e.target.reset(); resetImageUpload();
                });
            }
        };

        // ===================== ENHANCED editAsset =====================
        function editAsset(id) {
            db.ref('assets/'+id).once('value', snap => {
                const a = snap.val();
                document.getElementById('edit-id').value = id;
                document.getElementById('as-name').value = a.name;
                document.getElementById('as-serial').value = a.serial;
                document.getElementById('as-model').value = a.model||'';
                document.getElementById('as-type').value = a.type||'';
                document.getElementById('as-loc').value = a.location;
                document.getElementById('as-dept').value = a.deptKey||'';
                document.getElementById('as-purchase').value = a.purchaseDate||'';
                document.getElementById('as-cond').value = a.cond;
                document.getElementById('as-reason').value = a.reason||'';
                // Restore image preview
                if (a.imageUrl) {
                    document.getElementById('as-photo').value = a.imageUrl;
                    const preview = document.getElementById('img-preview');
                    const placeholder = document.getElementById('img-placeholder');
                    const overlay = document.getElementById('img-change-overlay');
                    preview.src = a.imageUrl;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    overlay.classList.remove('hidden');
                    overlay.classList.add('flex');
                }
                showSection('inventario');
            });
        }

        // ===================== IMAGE UPLOAD HANDLER =====================
        function handleUrlInput(url) {
            // When user types a URL, show it in the preview
            const preview = document.getElementById('img-preview');
            const placeholder = document.getElementById('img-placeholder');
            const overlay = document.getElementById('img-change-overlay');
            if (url && url.startsWith('http')) {
                preview.src = url;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
                // Clear file input so URL takes priority
                document.getElementById('as-photo-file').value = '';
            } else {
                preview.classList.add('hidden');
                placeholder.classList.remove('hidden');
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            const errEl = document.getElementById('img-upload-error');
            errEl.classList.add('hidden');

            if (!file) return;

            // Validate size (2 MB max)
            if (file.size > 2 * 1024 * 1024) {
                errEl.textContent = '‚ö†Ô∏è La imagen supera los 2 MB. Elige una imagen m√°s peque√±a.';
                errEl.classList.remove('hidden');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                // Store base64 in the URL field (replaces any typed URL)
                document.getElementById('as-photo').value = base64;
                // Clear URL text visually by setting placeholder hint
                // Show preview
                const preview = document.getElementById('img-preview');
                const placeholder = document.getElementById('img-placeholder');
                const overlay = document.getElementById('img-change-overlay');
                preview.src = base64;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            };
            reader.readAsDataURL(file);
        }

        function resetImageUpload() {
            document.getElementById('as-photo').value = '';
            document.getElementById('as-photo-file').value = '';
            const preview = document.getElementById('img-preview');
            const placeholder = document.getElementById('img-placeholder');
            const overlay = document.getElementById('img-change-overlay');
            preview.src = '';
            preview.classList.add('hidden');
            placeholder.classList.remove('hidden');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
            document.getElementById('img-upload-error').classList.add('hidden');
        }

        // ===================== ROLE PERMISSIONS MAP =====================
        // Nivel 1 = admin        ‚Üí acceso total
        // Nivel 2 = mantenimiento ‚Üí casi todo, SIN gesti√≥n de usuarios/solicitudes
        // Nivel 3 = operario      ‚Üí solo ver inventario, escanear QR, reportar
        function getRolePermissions(role) {
            if (role === 'admin')         return ['Panel','Inventario','Asignaciones','Reportes','Departamentos','Usuarios','Registrados','Manual'];
            if (role === 'mantenimiento') return ['Panel','Inventario','Asignaciones','Reportes','Departamentos','Manual'];
            return ['Panel','Inventario','Manual'];  // operario
        }

        function applyRoleUI(role) {
            userRole = role;

            // Reset all controlled nav items
            document.querySelectorAll('.admin-only, .mantenimiento-only, .operario-only').forEach(el => {
                el.style.display = 'none';
            });

            // Level indicator
            const indicator = document.getElementById('role-level-indicator');
            if (indicator) indicator.classList.remove('hidden');

            if (role === 'admin') {
                // Nivel 1 ‚Äî todo visible
                document.querySelectorAll('.admin-only, .mantenimiento-only').forEach(el => el.style.display = 'flex');
                document.getElementById('user-role-badge').innerHTML = '<span class="role-badge-admin">üõ°Ô∏è Nivel 1 ‚Äî Administrativo</span>';
                document.getElementById('lvl-dot-1').className = 'w-3 h-3 rounded-full bg-purple-500 border border-purple-300';
                document.getElementById('lvl-dot-2').className = 'w-3 h-3 rounded-full bg-purple-400/60 border border-purple-400';
                document.getElementById('lvl-dot-3').className = 'w-3 h-3 rounded-full bg-purple-400/30 border border-purple-500/50';

            } else if (role === 'mantenimiento') {
                // Nivel 2 ‚Äî ve todo excepto usuarios/registrados
                document.querySelectorAll('.mantenimiento-only').forEach(el => el.style.display = 'flex');
                document.getElementById('user-role-badge').innerHTML = '<span class="role-badge-mantenimiento">üîß Nivel 2 ‚Äî Mantenimiento</span>';
                document.getElementById('lvl-dot-1').className = 'w-3 h-3 rounded-full bg-orange-500/20 border border-orange-500/30';
                document.getElementById('lvl-dot-2').className = 'w-3 h-3 rounded-full bg-orange-400 border border-orange-300';
                document.getElementById('lvl-dot-3').className = 'w-3 h-3 rounded-full bg-orange-400/40 border border-orange-400/60';

            } else {
                // Nivel 3 ‚Äî operario ‚Äî acceso m√≠nimo
                document.getElementById('user-role-badge').innerHTML = '<span class="role-badge-operario">‚öôÔ∏è Nivel 3 ‚Äî Operario</span>';
                document.getElementById('lvl-dot-1').className = 'w-3 h-3 rounded-full bg-cyan-500/20 border border-cyan-500/30';
                document.getElementById('lvl-dot-2').className = 'w-3 h-3 rounded-full bg-cyan-500/20 border border-cyan-500/30';
                document.getElementById('lvl-dot-3').className = 'w-3 h-3 rounded-full bg-cyan-400 border border-cyan-300';
            }
        }

        // ===================== ENHANCED AUTH STATE =====================
        auth.onAuthStateChanged(user => {
            if (user) {
                db.ref('users/' + user.uid).on('value', snap => {
                    let userData = snap.val();
                    if (user.email === MASTER_EMAIL && !userData) {
                        userData = { name: "Admin General", role: "admin", email: user.email, cedula: 'N/A', cargo: 'Administrador del Sistema' };
                        db.ref('users/' + user.uid).set(userData);
                    }

                    const role = userData?.role || "mantenimiento";

                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('public-scan-screen').classList.add('hidden');
                    document.getElementById('app-interface').classList.remove('hidden');
                    document.getElementById('display-user').textContent = user.email;

                    // Store current user data globally for asset registration
                    currentUserData = {
                        uid: user.uid,
                        email: user.email,
                        name: userData?.name || user.email,
                        role: role
                    };
                    // Apply role UI (nav visibility + badge + dots)
                    applyRoleUI(role);

                    // Load data based on role level
                    if (role === 'admin') {
                        document.getElementById('admin-user-list').classList.remove('hidden');
                        loadAdminUsers();
                        loadRegistrados();
                    }

                    // Load shared data
                    loadDepts();

                    // Nivel 2 (mantenimiento) y Nivel 1 (admin) cargan asignaciones
                    if (role === 'admin' || role === 'mantenimiento') {
                        loadAssignments();
                        populateAssignSelects();
                    }

                    if (scannedId) {
                        document.getElementById('main-sidebar').classList.add('hidden');
                        loadScannedAsset(scannedId);
                    } else {
                        showSection('dashboard');
                        loadAssets();
                        if (role === 'admin' || role === 'mantenimiento') {
                            loadReports();
                        }
                        setTimeout(() => showManualTab('intro'), 100);
                    }
                });
            } else {
                if (!scannedId) {
                    document.getElementById('login-screen').classList.remove('hidden');
                    document.getElementById('app-interface').classList.add('hidden');
                }
            }
        });
    </script>
</body>
</html>
